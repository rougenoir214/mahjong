<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»é›€æˆç¸¾ç®¡ç† - ç®¡ç†è€…ç”»é¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .animate-fade { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-red-50 min-h-screen">

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginScreen" class="fixed inset-0 bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 animate-fade">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">ğŸ”</div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ç®¡ç†è€…ç”»é¢</h1>
                <p class="text-gray-600">ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</p>
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="adminPasswordInput" 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                       placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                       onkeypress="if(event.key==='Enter') adminLogin()">
            </div>
            <button onclick="adminLogin()" 
                    class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-bold hover:opacity-90 transition">
                ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <div id="loginError" class="mt-4 text-red-500 text-sm text-center hidden"></div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="mainScreen" style="display: none;">
        <header class="bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold">ğŸ” ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</h1>
                    <button onclick="logout()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded text-sm">
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </div>
            </div>
        </header>

        <div class="container mx-auto px-4 py-8 max-w-4xl">
            <!-- ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 animate-fade">
                <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ†• æ–°è¦ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ</h2>
                <div class="grid gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700">ã‚°ãƒ«ãƒ¼ãƒ—IDï¼ˆè‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ï¼‰</label>
                        <input type="text" id="newGroupId" 
                               class="w-full px-4 py-2 border rounded-lg focus:border-purple-500 focus:outline-none"
                               placeholder="ä¾‹: team-a, company-2024"
                               pattern="[a-zA-Z0-9-]+"
                               title="è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ä½¿ç”¨ã§ãã¾ã™">
                        <p class="text-xs text-gray-500 mt-1">â€» ã“ã®IDãŒURLã®ä¸€éƒ¨ã«ãªã‚Šã¾ã™</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700">ã‚°ãƒ«ãƒ¼ãƒ—å</label>
                        <input type="text" id="newGroupName" 
                               class="w-full px-4 py-2 border rounded-lg focus:border-purple-500 focus:outline-none"
                               placeholder="ä¾‹: Aãƒãƒ¼ãƒ , ç¤¾å†…éº»é›€éƒ¨">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700">èª¬æ˜ï¼ˆä»»æ„ï¼‰</label>
                        <textarea id="newGroupDescription" 
                                  class="w-full px-4 py-2 border rounded-lg focus:border-purple-500 focus:outline-none"
                                  placeholder="ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®èª¬æ˜ã‚’å…¥åŠ›"
                                  rows="2"></textarea>
                    </div>
                    <button onclick="createGroup()" 
                            class="bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-bold hover:opacity-90 transition">
                        ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ
                    </button>
                </div>
            </div>

            <!-- ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ -->
            <div class="bg-white rounded-xl shadow-lg p-6 animate-fade">
                <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ“‹ ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§</h2>
                <div id="groupsList" class="space-y-3">
                    <p class="text-gray-500 text-center py-8">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyA7bkfPDgs3iSNFC2MOxjs1aakbHbMi-jM",
            authDomain: "mahjong-337a9.firebaseapp.com",
            databaseURL: "https://mahjong-337a9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mahjong-337a9",
            storageBucket: "mahjong-337a9.firebasestorage.app",
            messagingSenderId: "605742422445",
            appId: "1:605742422445:web:e207ae05cba0a67f7b2924",
            measurementId: "G-2VDY4LKSPP"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆFirebaseã«ä¿å­˜ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ï¼‰
        const ADMIN_PASSWORD = "admin2024";

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function adminLogin() {
            const password = document.getElementById('adminPasswordInput').value;
            const errorDiv = document.getElementById('loginError');

            if (password === ADMIN_PASSWORD) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainScreen').style.display = 'block';
                loadGroups();
            } else {
                errorDiv.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                errorDiv.classList.remove('hidden');
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('adminPasswordInput').value = '';
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
        async function createGroup() {
            const groupId = document.getElementById('newGroupId').value.trim();
            const groupName = document.getElementById('newGroupName').value.trim();
            const groupDescription = document.getElementById('newGroupDescription').value.trim();

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!groupId) {
                alert('ã‚°ãƒ«ãƒ¼ãƒ—IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!groupName) {
                alert('ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!/^[a-zA-Z0-9-]+$/.test(groupId)) {
                alert('ã‚°ãƒ«ãƒ¼ãƒ—IDã«ã¯è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ä½¿ç”¨ã§ãã¾ã™');
                return;
            }

            try {
                // æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒã‚§ãƒƒã‚¯
                const snapshot = await database.ref('groups/' + groupId).once('value');
                if (snapshot.exists()) {
                    alert('ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—IDã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™');
                    return;
                }

                // ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
                const groupData = {
                    groupId: groupId,
                    name: groupName,
                    description: groupDescription,
                    createdAt: new Date().toISOString(),
                    createdBy: 'admin'
                };

                await database.ref('groups/' + groupId + '/info').set(groupData);

                // åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
                await database.ref('groups/' + groupId + '/passwords').set({
                    login: 'mahjong2024',
                    delete: 'mahjong1234'
                });

                alert('ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸï¼\n\nã‚¢ã‚¯ã‚»ã‚¹URL:\n' + getGroupUrl(groupId));

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('newGroupId').value = '';
                document.getElementById('newGroupName').value = '';
                document.getElementById('newGroupDescription').value = '';

                // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                loadGroups();

            } catch (error) {
                console.error('ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadGroups() {
            try {
                const snapshot = await database.ref('groups').once('value');
                const groups = snapshot.val() || {};

                const container = document.getElementById('groupsList');

                if (Object.keys(groups).length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">ã¾ã ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                let html = '';
                for (const groupId in groups) {
                    const info = groups[groupId].info || {};
                    const groupName = info.name || groupId;
                    const description = info.description || '';
                    const createdAt = info.createdAt ? new Date(info.createdAt).toLocaleString('ja-JP') : '';

                    html += `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg text-gray-800">${escapeHtml(groupName)}</h3>
                                    <p class="text-sm text-gray-500">ID: ${escapeHtml(groupId)}</p>
                                    ${description ? `<p class="text-sm text-gray-600 mt-1">${escapeHtml(description)}</p>` : ''}
                                    <p class="text-xs text-gray-400 mt-1">ä½œæˆæ—¥æ™‚: ${createdAt}</p>
                                </div>
                                <button onclick="deleteGroup('${escapeHtml(groupId)}')" 
                                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm ml-2">
                                    å‰Šé™¤
                                </button>
                            </div>
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <div class="flex gap-2">
                                    <input type="text" value="${getGroupUrl(groupId)}" readonly
                                           class="flex-1 px-3 py-2 border rounded bg-gray-50 text-sm">
                                    <button onclick="copyUrl('${escapeHtml(groupId)}')" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm whitespace-nowrap">
                                        URLã‚³ãƒ”ãƒ¼
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html;

            } catch (error) {
                console.error('ã‚°ãƒ«ãƒ¼ãƒ—èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('groupsList').innerHTML = 
                    '<p class="text-red-500 text-center py-8">ã‚°ãƒ«ãƒ¼ãƒ—ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤
        async function deleteGroup(groupId) {
            if (!confirm(`ã‚°ãƒ«ãƒ¼ãƒ—ã€Œ${groupId}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€» ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®å…¨ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }

            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆæœ€çµ‚ç¢ºèªï¼‰')) {
                return;
            }

            try {
                await database.ref('groups/' + groupId).remove();
                alert('ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                loadGroups();
            } catch (error) {
                console.error('ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚°ãƒ«ãƒ¼ãƒ—ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—URLã‚’å–å¾—
        function getGroupUrl(groupId) {
            const baseUrl = window.location.href.replace('/admin.html', '/mobile-firebase.html');
            return baseUrl.split('?')[0] + '?group=' + encodeURIComponent(groupId);
        }

        // URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyUrl(groupId) {
            const url = getGroupUrl(groupId);
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
                }).catch(err => {
                    fallbackCopy(url);
                });
            } else {
                fallbackCopy(url);
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ã‚³ãƒ”ãƒ¼å‡¦ç†
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showNotification('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            } catch (err) {
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:\n' + text);
            }
            document.body.removeChild(textarea);
        }

        // é€šçŸ¥è¡¨ç¤º
        function showNotification(message) {
            const existing = document.getElementById('notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: bold;
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById('adminPasswordInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') adminLogin();
        });
    </script>
</body>
</html>
