<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È∫ªÈõÄÊàêÁ∏æÁÆ°ÁêÜ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#ecfeff',
                            100: '#cffafe',
                            200: '#a5f3fc',
                            300: '#67e8f9',
                            400: '#22d3ee',
                            500: '#06b6d4',
                            600: '#0891b2',
                            700: '#0e7490',
                            800: '#155e75',
                            900: '#164e63',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .table-scroll {
            overflow-x: auto;
        }

        table {
            border-collapse: collapse;
        }

        .dropdown {
            position: relative;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-cyan-50 via-blue-50 to-teal-50 min-h-screen">

    <!-- Header -->
    <header class="bg-gradient-to-r from-cyan-600 to-teal-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div class="flex-1"></div>
                <div class="flex-1 text-center">
                    <h1 class="text-4xl font-bold">üÄÑ È∫ªÈõÄÊàêÁ∏æÁÆ°ÁêÜ</h1>
                    <p class="text-cyan-100 mt-2">„ÅÇ„Å™„Åü„ÅÆÈõÄÂäõ„ÇíÂèØË¶ñÂåñ</p>
                </div>
                <div class="flex-1 flex justify-end gap-2">
                    <button id="exportBtn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium transition">
                        üì• „Ç®„ÇØ„Çπ„Éù„Éº„Éà
                    </button>
                    <button id="importBtn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium transition">
                        üì§ „Ç§„É≥„Éù„Éº„Éà
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- „Ç§„É≥„Éù„Éº„ÉàÁî®„ÅÆÈö†„Åó„Éï„Ç°„Ç§„É´ÂÖ•Âäõ -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">


    <div class="container mx-auto px-4 py-8">
        <!-- Áµ±Ë®à„Ç´„Éº„Éâ -->
        <div id="statsCards" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <!-- JavaScript „ÅßÂãïÁöÑÁîüÊàê -->
        </div>

        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Â∑¶ÂÅ¥: ÊàêÁ∏æÂÖ•Âäõ„Éï„Ç©„Éº„É† -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-xl p-6 card-hover animate-fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="bg-gradient-to-r from-cyan-500 to-teal-500 text-white rounded-lg px-3 py-1 mr-3">üìù</span>
                        ÊàêÁ∏æÁôªÈå≤
                    </h2>
                    
                    <!-- Êó•‰ªòÈÅ∏Êäû -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Êó•‰ªò</label>
                        <input type="date" id="selectedDate" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition">
                    </div>

                    <!-- È∫ªÈõÄ„ÅÆÁ®ÆÈ°û -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">È∫ªÈõÄ„ÅÆÁ®ÆÈ°û</label>
                        <select id="gameType"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition">
                            <option value="4">4‰∫∫È∫ªÈõÄ</option>
                            <option value="3">3‰∫∫È∫ªÈõÄ</option>
                        </select>
                    </div>

                    <!-- „Éó„É¨„Ç§„É§„ÉºÈÅ∏Êäû -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">„Éó„É¨„Ç§„É§„ÉºÈÅ∏Êäû</label>
                        <div id="playerSelectors" class="space-y-2 mb-3">
                            <!-- JavaScript „ÅßÂãïÁöÑÁîüÊàê -->
                        </div>
                    </div>

                    <!-- ÂçäËçò„Çπ„Ç≥„Ç¢ÂÖ•Âäõ -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂçäËçò„Çπ„Ç≥„Ç¢ÂÖ•Âäõ</label>
                        <div id="scoreInputs" class="space-y-2">
                            <!-- JavaScript „ÅßÂãïÁöÑÁîüÊàê -->
                        </div>
                        <button id="addGameBtn" type="button"
                            class="w-full mt-3 bg-gradient-to-r from-cyan-600 to-teal-600 text-white px-6 py-3 rounded-lg font-medium hover:from-cyan-700 hover:to-teal-700 transition transform hover:scale-105 shadow-lg">
                            ÂçäËçò„ÇíËøΩÂä†
                        </button>
                    </div>
                </div>
            </div>

            <!-- Âè≥ÂÅ¥: ÊàêÁ∏æ‰∏ÄË¶ß„Å®„Éó„É¨„Ç§„É§„ÉºÁµ±Ë®à -->
            <div class="lg:col-span-2 space-y-8">
                <!-- „Çø„Éñ -->
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden animate-fade-in">
                    <div class="flex border-b border-gray-200">
                        <button id="tabDaily" class="tab-btn flex-1 px-6 py-4 text-center font-medium bg-gradient-to-r from-cyan-500 to-teal-500 text-white transition">
                            Êó•Âà•ÊàêÁ∏æ
                        </button>
                        <button id="tabPlayers" class="tab-btn flex-1 px-6 py-4 text-center font-medium text-gray-600 hover:bg-gray-50 transition">
                            „Éó„É¨„Ç§„É§„ÉºÁµ±Ë®à
                        </button>
                    </div>

                    <!-- Êó•Âà•ÊàêÁ∏æ„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
                    <div id="dailyContent" class="p-6">
                        <div class="mb-4 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">Êó•Âà•ÊàêÁ∏æ</h3>
                            <button id="clearAllBtn" class="text-red-600 hover:text-red-700 text-sm font-medium">
                                ÂÖ®„Éá„Éº„ÇøÂâäÈô§
                            </button>
                        </div>
                        <div id="dailyList" class="space-y-4">
                            <!-- JavaScript „ÅßÂãïÁöÑÁîüÊàê -->
                        </div>
                    </div>

                    <!-- „Éó„É¨„Ç§„É§„ÉºÁµ±Ë®à„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
                    <div id="playersContent" class="p-6 hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">„Éó„É¨„Ç§„É§„ÉºÁµ±Ë®à</h3>
                        <div id="playerStats" class="space-y-4">
                            <!-- JavaScript „ÅßÂãïÁöÑÁîüÊàê -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Éá„Éº„ÇøÁÆ°ÁêÜ
        class MahjongApp {
            constructor() {
                this.data = this.loadData();
                this.allPlayers = this.loadAllPlayers();
                this.selectedDate = new Date().toISOString().split('T')[0];
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setTodayDate();
                this.render();
            }

            // „Éá„Éº„ÇøÊßãÈÄ†: { dates: { "2025-01-01": { type: 4, players: ["A", "B"], games: [[100, -50], [50, -20]] } } }
            loadData() {
                const data = localStorage.getItem('mahjongData');
                return data ? JSON.parse(data) : { dates: {} };
            }

            // ÂÖ®„Éó„É¨„Ç§„É§„Éº„É™„Çπ„ÉàÔºàÈÅéÂéª„Å´ÁôªÈå≤„Åó„ÅüÂÖ®„Éó„É¨„Ç§„É§„ÉºÔºâ
            loadAllPlayers() {
                const players = localStorage.getItem('allPlayers');
                return players ? JSON.parse(players) : [];
            }

            saveData() {
                localStorage.setItem('mahjongData', JSON.stringify(this.data));
            }

            saveAllPlayers() {
                localStorage.setItem('allPlayers', JSON.stringify(this.allPlayers));
            }

            addToAllPlayers(playerName) {
                if (!this.allPlayers.includes(playerName)) {
                    this.allPlayers.push(playerName);
                    this.saveAllPlayers();
                }
            }

            setTodayDate() {
                document.getElementById('selectedDate').value = this.selectedDate;
            }

            setupEventListeners() {
                // Êó•‰ªòÂ§âÊõ¥
                document.getElementById('selectedDate').addEventListener('change', (e) => {
                    this.selectedDate = e.target.value;
                    this.render();
                });

                // È∫ªÈõÄ„ÅÆÁ®ÆÈ°ûÂ§âÊõ¥
                document.getElementById('gameType').addEventListener('change', () => {
                    this.updateGameType();
                });

                // ÂçäËçòËøΩÂä†
                document.getElementById('addGameBtn').addEventListener('click', () => {
                    this.addGame();
                });

                // „Çø„ÉñÂàá„ÇäÊõø„Åà
                document.getElementById('tabDaily').addEventListener('click', () => {
                    this.switchTab('daily');
                });
                document.getElementById('tabPlayers').addEventListener('click', () => {
                    this.switchTab('players');
                });

                // ÂÖ®„Éá„Éº„ÇøÂâäÈô§
                document.getElementById('clearAllBtn').addEventListener('click', () => {
                    if (confirm('ÂÖ®„Å¶„ÅÆÂØæÊà¶„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                        this.clearAllData();
                    }
                });

                // „Ç®„ÇØ„Çπ„Éù„Éº„Éà
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportData();
                });

                // „Ç§„É≥„Éù„Éº„Éà
                document.getElementById('importBtn').addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });

                document.getElementById('fileInput').addEventListener('change', (e) => {
                    this.importData(e.target.files[0]);
                });
            }

            getCurrentDateData() {
                if (!this.data.dates[this.selectedDate]) {
                    this.data.dates[this.selectedDate] = {
                        type: 4,
                        players: [],
                        games: []
                    };
                }
                return this.data.dates[this.selectedDate];
            }

            updateGameType() {
                const dateData = this.getCurrentDateData();
                dateData.type = parseInt(document.getElementById('gameType').value);
                
                // „Éó„É¨„Ç§„É§„ÉºÊï∞„ÇíË™øÊï¥
                const requiredPlayers = dateData.type;
                if (dateData.players.length > requiredPlayers) {
                    dateData.players = dateData.players.slice(0, requiredPlayers);
                }
                
                this.saveData();
                this.render();
            }

            updatePlayer(index, playerName) {
                const dateData = this.getCurrentDateData();
                dateData.players[index] = playerName;
                
                // ÂÖ®„Éó„É¨„Ç§„É§„Éº„É™„Çπ„Éà„Å´ËøΩÂä†
                this.addToAllPlayers(playerName);
                
                this.saveData();
                this.render();
            }

            addGame() {
                const dateData = this.getCurrentDateData();
                if (dateData.players.length < dateData.type) {
                    alert('ÂÖ®„Å¶„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }

                const scores = [];
                dateData.players.forEach((player, index) => {
                    const input = document.getElementById(`score_${index}`);
                    const score = input ? parseInt(input.value) || 0 : 0;
                    scores.push(score);
                });

                // „Çπ„Ç≥„Ç¢ÂêàË®à„ÉÅ„Çß„ÉÉ„ÇØ
                const total = scores.reduce((sum, s) => sum + s, 0);
                if (total !== 0) {
                    const playerScores = dateData.players.map((p, i) => `${p}: ${scores[i] > 0 ? '+' : ''}${scores[i]}`).join('\n');
                    const message = `‚ö†Ô∏è „Çπ„Ç≥„Ç¢„ÅÆÂêàË®à„Åå${total > 0 ? '+' : ''}${total}„Åß„ÅôÔºà0„Å´„Å™„Å£„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºâ\n\n„Åì„ÅÆ„Åæ„ÅæÁôªÈå≤„Åó„Åæ„Åô„ÅãÔºü\n\n„ÄêÂÖ•Âäõ„Åó„Åü„Çπ„Ç≥„Ç¢„Äë\n${playerScores}\nÂêàË®à: ${total > 0 ? '+' : ''}${total}`;
                    if (!confirm(message)) {
                        return;
                    }
                }

                // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
                dateData.players.forEach((player, index) => {
                    const input = document.getElementById(`score_${index}`);
                    if (input) input.value = '';
                });

                dateData.games.push(scores);
                this.saveData();
                this.render();
                this.showNotification(`ÂçäËçò ${dateData.games.length} „ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`);
            }

            removeGame(dateStr, gameIndex) {
                if (!confirm('„Åì„ÅÆÂçäËçò„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

                const dateData = this.data.dates[dateStr];
                if (!dateData) return;

                dateData.games.splice(gameIndex, 1);
                this.saveData();
                this.render();
                this.showNotification('ÂçäËçò„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
            }

            updateScore(dateStr, gameIndex, playerIndex, newScore) {
                const dateData = this.data.dates[dateStr];
                if (!dateData || !dateData.games[gameIndex]) return;

                dateData.games[gameIndex][playerIndex] = parseInt(newScore) || 0;
                this.saveData();
                this.render();
            }

            clearAllData() {
                this.data = { dates: {} };
                this.saveData();
                this.render();
                this.showNotification('ÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
            }

            exportData() {
                const exportObj = {
                    data: this.data,
                    allPlayers: this.allPlayers,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };

                const dataStr = JSON.stringify(exportObj, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `mahjong_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                this.showNotification('„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ');
            }

            importData(file) {
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importObj = JSON.parse(e.target.result);
                        
                        // „Éá„Éº„Çø„ÅÆÊ§úË®º
                        if (!importObj.data || !importObj.allPlayers) {
                            throw new Error('ÁÑ°Âäπ„Å™„Éá„Éº„ÇøÂΩ¢Âºè„Åß„Åô');
                        }

                        // Êó¢Â≠ò„Éá„Éº„Çø„Å®„Éû„Éº„Ç∏„Åô„Çã„ÅãÁ¢∫Ë™ç
                        const shouldMerge = confirm('Êó¢Â≠ò„ÅÆ„Éá„Éº„Çø„Å´„Ç§„É≥„Éù„Éº„Éà„Éá„Éº„Çø„ÇíËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü\n\n„ÄåOK„Äç= ËøΩÂä†\n„Äå„Ç≠„É£„É≥„Çª„É´„Äç= ‰∏äÊõ∏„Åç');

                        if (shouldMerge) {
                            // „Éû„Éº„Ç∏Âá¶ÁêÜ
                            Object.entries(importObj.data.dates).forEach(([date, dateData]) => {
                                if (this.data.dates[date]) {
                                    // Êó¢„Å´Âêå„ÅòÊó•„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÁ¢∫Ë™ç
                                    if (confirm(`${date}„ÅÆ„Éá„Éº„Çø„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü`)) {
                                        this.data.dates[date] = dateData;
                                    }
                                } else {
                                    this.data.dates[date] = dateData;
                                }
                            });

                            // „Éó„É¨„Ç§„É§„Éº„É™„Çπ„Éà„Çí„Éû„Éº„Ç∏
                            importObj.allPlayers.forEach(player => {
                                this.addToAllPlayers(player);
                            });
                        } else {
                            // ‰∏äÊõ∏„ÅçÂá¶ÁêÜ
                            this.data = importObj.data;
                            this.allPlayers = importObj.allPlayers;
                        }

                        this.saveData();
                        this.saveAllPlayers();
                        this.render();
                        this.showNotification('„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ');
                    } catch (error) {
                        alert('„Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                    }
                };
                reader.readAsText(file);
                
                // „Éï„Ç°„Ç§„É´ÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„Éà
                document.getElementById('fileInput').value = '';
            }

            switchTab(tab) {
                const tabDaily = document.getElementById('tabDaily');
                const tabPlayers = document.getElementById('tabPlayers');
                const dailyContent = document.getElementById('dailyContent');
                const playersContent = document.getElementById('playersContent');

                if (tab === 'daily') {
                    tabDaily.classList.add('bg-gradient-to-r', 'from-cyan-500', 'to-teal-500', 'text-white');
                    tabDaily.classList.remove('text-gray-600', 'hover:bg-gray-50');
                    tabPlayers.classList.remove('bg-gradient-to-r', 'from-cyan-500', 'to-teal-500', 'text-white');
                    tabPlayers.classList.add('text-gray-600', 'hover:bg-gray-50');
                    dailyContent.classList.remove('hidden');
                    playersContent.classList.add('hidden');
                } else {
                    tabPlayers.classList.add('bg-gradient-to-r', 'from-cyan-500', 'to-teal-500', 'text-white');
                    tabPlayers.classList.remove('text-gray-600', 'hover:bg-gray-50');
                    tabDaily.classList.remove('bg-gradient-to-r', 'from-cyan-500', 'to-teal-500', 'text-white');
                    tabDaily.classList.add('text-gray-600', 'hover:bg-gray-50');
                    playersContent.classList.remove('hidden');
                    dailyContent.classList.add('hidden');
                }
            }

            showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-gradient-to-r from-cyan-600 to-teal-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.3s';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            render() {
                this.renderStatsCards();
                this.renderPlayerSelectors();
                this.renderScoreInputs();
                this.renderDailyList();
                this.renderPlayerStats();
            }

            renderStatsCards() {
                const allGames = [];
                const uniquePlayers = new Set();
                let totalScore = 0;

                Object.values(this.data.dates).forEach(dateData => {
                    dateData.games.forEach(game => {
                        allGames.push(game);
                        game.forEach((score, index) => {
                            uniquePlayers.add(dateData.players[index]);
                            totalScore += score;
                        });
                    });
                });

                const totalGames = allGames.length;

                const container = document.getElementById('statsCards');
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-cyan-500 to-teal-600 rounded-xl shadow-lg p-6 text-white card-hover">
                        <div class="text-3xl font-bold mb-2">${totalGames}</div>
                        <div class="text-cyan-100">Á∑èÂçäËçòÊï∞</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-cyan-600 rounded-xl shadow-lg p-6 text-white card-hover">
                        <div class="text-3xl font-bold mb-2">${uniquePlayers.size}</div>
                        <div class="text-blue-100">„Éó„É¨„Ç§„É§„ÉºÊï∞</div>
                    </div>
                    <div class="bg-gradient-to-br from-teal-500 to-emerald-600 rounded-xl shadow-lg p-6 text-white card-hover">
                        <div class="text-3xl font-bold mb-2">${totalScore.toLocaleString()}</div>
                        <div class="text-teal-100">Á¥ØË®à„Çπ„Ç≥„Ç¢</div>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl shadow-lg p-6 text-white card-hover">
                        <div class="text-3xl font-bold mb-2">${Object.keys(this.data.dates).length}</div>
                        <div class="text-emerald-100">ÂØæÊà¶Êó•Êï∞</div>
                    </div>
                `;
            }

            renderPlayerSelectors() {
                const dateData = this.getCurrentDateData();
                const container = document.getElementById('playerSelectors');
                const gameType = dateData.type;
                
                container.innerHTML = '';
                for (let i = 0; i < gameType; i++) {
                    const currentPlayer = dateData.players[i] || '';
                    const selectorDiv = document.createElement('div');
                    selectorDiv.className = 'flex gap-2';
                    selectorDiv.innerHTML = `
                        <select id="player_${i}" 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition">
                            <option value="">„Éó„É¨„Ç§„É§„Éº${i + 1}„ÇíÈÅ∏Êäû...</option>
                            ${this.allPlayers.map(p => `<option value="${p}" ${p === currentPlayer ? 'selected' : ''}>${p}</option>`).join('')}
                            <option value="__new__">+ Êñ∞„Åó„ÅÑ„Éó„É¨„Ç§„É§„Éº</option>
                        </select>
                    `;
                    container.appendChild(selectorDiv);

                    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºËøΩÂä†
                    const select = selectorDiv.querySelector('select');
                    select.addEventListener('change', (e) => {
                        if (e.target.value === '__new__') {
                            const newName = prompt('Êñ∞„Åó„ÅÑ„Éó„É¨„Ç§„É§„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                            if (newName && newName.trim()) {
                                this.addToAllPlayers(newName.trim());
                                this.updatePlayer(i, newName.trim());
                            } else {
                                e.target.value = currentPlayer;
                            }
                        } else {
                            this.updatePlayer(i, e.target.value);
                        }
                    });
                }
            }

            renderScoreInputs() {
                const dateData = this.getCurrentDateData();
                const container = document.getElementById('scoreInputs');
                
                if (dateData.players.length < dateData.type) {
                    container.innerHTML = '<div class="text-gray-400 text-sm text-center py-2">ÂÖ®„Å¶„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÇíÈÅ∏Êäû„Åô„Çã„Å®ÂÖ•ÂäõÊ¨Ñ„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div>';
                    return;
                }

                container.innerHTML = dateData.players.map((player, index) => `
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-gray-700 w-24 truncate" title="${player}">${player}</span>
                        <input type="number" id="score_${index}" placeholder="„Çπ„Ç≥„Ç¢"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition">
                    </div>
                `).join('');
            }

            renderDailyList() {
                const container = document.getElementById('dailyList');
                const dates = Object.keys(this.data.dates).sort().reverse();
                
                if (dates.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p class="text-lg font-medium">„Åæ„Å†ÂØæÊà¶„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = dates.map(dateStr => {
                    const dateData = this.data.dates[dateStr];
                    if (!dateData || dateData.games.length === 0) return '';

                    // ÂêÑ„Éó„É¨„Ç§„É§„Éº„ÅÆÂêàË®à„Çπ„Ç≥„Ç¢„ÇíË®àÁÆó
                    const totals = dateData.players.map((_, pIndex) => {
                        return dateData.games.reduce((sum, game) => sum + (game[pIndex] || 0), 0);
                    });

                    return `
                        <div class="bg-gradient-to-r from-cyan-50 to-teal-50 rounded-xl p-6 border border-cyan-200 card-hover">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <div class="text-lg font-bold text-gray-800">${new Date(dateStr).toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                                    <div class="inline-block bg-gradient-to-r from-cyan-600 to-teal-600 text-white px-3 py-1 rounded-full text-sm font-medium mt-1">
                                        ${dateData.type}‰∫∫È∫ªÈõÄ | ${dateData.games.length}ÂçäËçò
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-scroll">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b-2 border-cyan-300">
                                            <th class="text-left py-2 px-2 font-bold text-gray-700">ÂçäËçò</th>
                                            ${dateData.players.map(player => `<th class="text-center py-2 px-2 font-bold text-gray-700">${player}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${dateData.games.map((game, gIndex) => `
                                            <tr class="border-b border-gray-200 hover:bg-white transition">
                                                <td class="py-2 px-2 font-medium text-gray-800">
                                                    ${gIndex + 1}ÂçäËçò
                                                    <button onclick="app.removeGame('${dateStr}', ${gIndex})" 
                                                        class="ml-2 text-xs text-red-500 hover:text-red-700">
                                                        ÂâäÈô§
                                                    </button>
                                                </td>
                                                ${game.map((score, pIndex) => {
                                                    const colorClass = score > 0 ? 'text-green-600' : score < 0 ? 'text-red-600' : 'text-gray-600';
                                                    return `
                                                        <td class="text-center py-2 px-2">
                                                            <input type="number" 
                                                                value="${score}"
                                                                onchange="app.updateScore('${dateStr}', ${gIndex}, ${pIndex}, this.value)"
                                                                class="w-20 text-center px-2 py-1 border border-gray-300 rounded ${colorClass} focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                                                        </td>
                                                    `;
                                                }).join('')}
                                            </tr>
                                        `).join('')}
                                        <tr class="border-t-2 border-cyan-300 bg-cyan-50 font-bold">
                                            <td class="py-2 px-2 text-gray-800">ÂêàË®à</td>
                                            ${totals.map(total => {
                                                const colorClass = total > 0 ? 'text-green-600' : total < 0 ? 'text-red-600' : 'text-gray-600';
                                                return `<td class="text-center py-2 px-2 ${colorClass}">${total > 0 ? '+' : ''}${total}</td>`;
                                            }).join('')}
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            calculatePlayerStats() {
                const stats = {};

                Object.entries(this.data.dates).forEach(([dateStr, dateData]) => {
                    dateData.games.forEach(game => {
                        game.forEach((score, pIndex) => {
                            const playerName = dateData.players[pIndex];
                            if (!playerName) return;

                            if (!stats[playerName]) {
                                stats[playerName] = {
                                    name: playerName,
                                    totalGames: 0,
                                    totalScore: 0,
                                    ranks: { 1: 0, 2: 0, 3: 0, 4: 0 },
                                    avgScore: 0
                                };
                            }

                            stats[playerName].totalGames++;
                            stats[playerName].totalScore += score;

                            // È†Ü‰Ωç„ÇíË®àÁÆóÔºà„Åù„ÅÆ„Ç≤„Éº„É†„ÅÆ„Çπ„Ç≥„Ç¢„Åß„ÇΩ„Éº„ÉàÔºâ
                            const sortedScores = [...game].sort((a, b) => b - a);
                            const rank = sortedScores.indexOf(score) + 1;
                            stats[playerName].ranks[rank]++;
                        });
                    });
                });

                // Âπ≥Âùá„Çπ„Ç≥„Ç¢„ÇíË®àÁÆó
                Object.values(stats).forEach(player => {
                    player.avgScore = player.totalGames > 0 ? Math.round(player.totalScore / player.totalGames) : 0;
                });

                return Object.values(stats).sort((a, b) => b.totalScore - a.totalScore);
            }

            renderPlayerStats() {
                const container = document.getElementById('playerStats');
                const playerStats = this.calculatePlayerStats();

                if (playerStats.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <p class="text-lg font-medium">„Åæ„Å†„Éó„É¨„Ç§„É§„ÉºÁµ±Ë®à„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = playerStats.map((player, index) => {
                    // È†Ü‰ΩçÂèñÂæóÁéá„ÇíË®àÁÆó
                    const rankPercentages = [];
                    let maxRank = 4;
                    for (let i = 1; i <= maxRank; i++) {
                        const count = player.ranks[i] || 0;
                        const percentage = player.totalGames > 0 ? ((count / player.totalGames) * 100).toFixed(1) : '0.0';
                        rankPercentages.push({ rank: i, count, percentage: parseFloat(percentage) });
                    }

                    // È†Ü‰ΩçÂèñÂæóÁéá„ÅÆ„Éê„ÉºË°®Á§∫
                    const rankBars = rankPercentages.map(r => {
                        const colors = ['bg-yellow-500', 'bg-gray-400', 'bg-orange-500', 'bg-red-500'];
                        const textColors = ['text-yellow-700', 'text-gray-700', 'text-orange-700', 'text-red-700'];
                        const bgColors = ['bg-yellow-50', 'bg-gray-50', 'bg-orange-50', 'bg-red-50'];
                        return `
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-sm font-bold w-10 ${textColors[r.rank - 1]}">${r.rank}‰Ωç</span>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <div class="flex-1 ${bgColors[r.rank - 1]} rounded-full h-8 overflow-hidden">
                                            <div class="${colors[r.rank - 1]} h-full flex items-center justify-end px-3 text-white text-xs font-bold transition-all duration-500" 
                                                style="width: ${r.percentage}%">
                                                ${r.percentage > 15 ? r.percentage + '%' : ''}
                                            </div>
                                        </div>
                                        <span class="text-sm font-bold ${textColors[r.rank - 1]} w-16">${r.percentage}%</span>
                                        <span class="text-sm text-gray-500 w-12 text-right">${r.count}Âõû</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    const medalEmoji = index === 0 ? 'üëë' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                    
                    return `
                        <div class="bg-gradient-to-r from-cyan-50 to-teal-50 rounded-xl p-6 border border-cyan-200 card-hover">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-14 h-14 bg-gradient-to-r from-cyan-500 to-teal-500 rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                                        ${player.name.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                            ${medalEmoji} ${player.name}
                                        </h3>
                                        <p class="text-sm text-gray-600">${player.totalGames}ÂçäËçò</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 to-teal-600">
                                        ${player.totalScore > 0 ? '+' : ''}${player.totalScore.toLocaleString()}
                                    </div>
                                    <div class="text-sm text-gray-600 mt-1">Âπ≥Âùá: ${player.avgScore > 0 ? '+' : ''}${player.avgScore.toLocaleString()}</div>
                                </div>
                            </div>
                            
                            <div class="border-t border-cyan-200 pt-4">
                                <h4 class="text-sm font-bold text-gray-700 mb-3">È†Ü‰ΩçÂèñÂæóÁéá</h4>
                                ${rankBars}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // „Ç¢„Éó„É™Ëµ∑Âãï
        const app = new MahjongApp();
    </script>
</body>
</html>
