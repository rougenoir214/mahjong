<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>イントロクイズ - モバイル版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        
        * {
            font-family: 'Noto Sans JP', sans-serif;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            box-sizing: border-box;
        }
        
        /* iPhone Safari対応 */
        input, button, select, textarea {
            font-size: 16px !important; /* 16px未満だとiOSが自動ズームする */
            -webkit-appearance: none;
        }
        
        input[type="text"] {
            width: 100%;
            max-width: 100%;
        }
        
        input[type="range"] {
            width: 100%;
        }
        
        /* flex内の入力欄の幅制御 */
        .flex input {
            min-width: 0;
            flex-shrink: 1;
        }
        
        body {
            overscroll-behavior: none;
            overflow-x: hidden;
            max-width: 100vw;
        }
        
        html {
            overflow-x: hidden;
        }
        
        .gradient-cyan-teal {
            background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 25%, #14b8a6 50%, #10b981 75%, #0891b2 100%);
            background-size: 400% 400%;
            animation: gradientShift 10s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }
        
        .btn-touch {
            transition: all 0.15s ease;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .btn-touch:active:not(:disabled) {
            transform: scale(0.95);
            filter: brightness(0.9);
        }
        
        .btn-touch:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .music-wave {
            animation: wave 1.2s linear infinite;
        }
        
        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }
        
        .correct-answer {
            animation: correctPulse 0.6s ease;
        }
        
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* YouTube Player Container */
        #player {
            position: fixed;
            top: -9999px;
            left: -9999px;
        }
        
        /* スマホ用の大きなボタン */
        .mobile-btn {
            min-height: 60px;
            font-size: 1.125rem;
        }
        
        /* プレイヤーカードの最適化 */
        .player-card {
            min-height: 80px;
        }
        
        /* スワイプインジケーター */
        .swipe-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }
    </style>
</head>
<body class="gradient-cyan-teal min-h-screen">
    <!-- YouTube Player (非表示) -->
    <div id="player"></div>
    
    <!-- メインコンテナ -->
    <div class="container mx-auto px-4 py-4 max-w-md pb-20">
        <!-- ヘッダー -->
        <header class="text-center mb-6">
            <h1 class="text-4xl font-black text-white mb-2 drop-shadow-lg">
                🎵 イントロクイズ
            </h1>
            <p class="text-base text-white/90 drop-shadow">スマホ最適化版</p>
        </header>

        <!-- メイン画面切り替えエリア -->
        <div id="app">
            <!-- ユーザー管理画面 -->
            <div id="userManagement" class="space-y-4">
                <!-- プレイヤー管理 -->
                <div class="glass-effect rounded-3xl p-5 shadow-2xl">
                    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                        <span class="text-3xl">👥</span>
                        プレイヤー
                    </h2>
                    
                    <!-- プレイヤー追加フォーム -->
                    <div class="mb-4 flex gap-2">
                        <input 
                            type="text" 
                            id="newPlayerName" 
                            placeholder="プレイヤー名"
                            maxlength="15"
                            style="min-width: 0; flex: 1 1 0%;"
                            class="px-4 py-4 rounded-2xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50"
                        />
                        <button 
                            onclick="addPlayer()"
                            class="px-6 py-4 bg-white text-cyan-600 rounded-2xl font-bold btn-touch flex-shrink-0"
                        >
                            追加
                        </button>
                    </div>
                    
                    <!-- プレイヤーリスト -->
                    <div id="playerList" class="space-y-3 mb-4">
                        <!-- プレイヤーカードはJSで動的生成 -->
                    </div>
                    
                    <div class="text-xs text-white/70 text-center">
                        ※ 最大4人まで登録可能
                    </div>
                </div>

                <!-- YouTube検索 -->
                <div class="glass-effect rounded-3xl p-5 shadow-2xl">
                    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                        <span class="text-3xl">🎬</span>
                        曲を検索
                    </h2>
                    
                    <!-- 検索フォーム -->
                    <div class="mb-4 flex gap-2">
                        <input 
                            type="text" 
                            id="searchQuery" 
                            placeholder="曲名で検索"
                            style="min-width: 0; flex: 1 1 0%;"
                            class="px-4 py-3 rounded-xl bg-white/20 text-white placeholder-white/60 border border-white/30 focus:outline-none focus:ring-2 focus:ring-white/50"
                        />
                        <button 
                            onclick="searchYouTube()"
                            class="px-6 py-3 bg-white text-cyan-600 rounded-xl font-bold btn-touch flex-shrink-0"
                        >
                            検索
                        </button>
                    </div>
                    
                    <!-- 検索結果 -->
                    <div id="searchResults" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- 検索結果はJSで動的生成 -->
                    </div>
                    
                    <!-- 選択済み曲リスト -->
                    <div class="mt-4">
                        <h3 class="text-white font-semibold mb-2 text-sm">選択済み: <span id="selectedCount">0</span>曲</h3>
                        <div id="selectedSongs" class="space-y-2 max-h-96 overflow-y-auto">
                            <!-- 選択済み曲はJSで動的生成 -->
                        </div>
                    </div>
                </div>

                <!-- クイズ設定 -->
                <div class="glass-effect rounded-3xl p-5 shadow-2xl">
                    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                        <span class="text-3xl">⚙️</span>
                        設定
                    </h2>
                    
                    <!-- イントロ再生時間 -->
                    <div class="mb-4">
                        <label class="block text-white font-semibold mb-2">
                            イントロ時間: <span id="introTimeDisplay" class="text-cyan-200">5</span>秒
                        </label>
                        <input 
                            type="range" 
                            id="introTime" 
                            min="3" 
                            max="15" 
                            value="5"
                            class="w-full h-3 bg-white/30 rounded-lg appearance-none cursor-pointer accent-white"
                        />
                        <div class="flex justify-between text-xs text-white/60 mt-1">
                            <span>3秒</span>
                            <span>15秒</span>
                        </div>
                    </div>
                    
                    <!-- クイズ開始ボタン -->
                    <button 
                        onclick="startQuiz()"
                        class="w-full py-5 bg-gradient-to-r from-pink-500 to-purple-600 text-white text-xl font-bold rounded-2xl btn-touch shadow-lg mobile-btn"
                    >
                        🎵 クイズを開始
                    </button>
                </div>

                <!-- スコアボード -->
                <div class="glass-effect rounded-3xl p-5 shadow-2xl">
                    <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                        <span class="text-3xl">🏆</span>
                        スコア
                    </h2>
                    <div id="scoreBoard" class="space-y-2">
                        <!-- スコアはJSで動的生成 -->
                    </div>
                    <button 
                        onclick="clearScores()"
                        class="mt-4 w-full py-3 bg-red-500/80 text-white font-bold rounded-xl btn-touch"
                    >
                        スコアをクリア
                    </button>
                </div>
            </div>

            <!-- クイズ実行画面 -->
            <div id="quizGame" class="hidden space-y-4">
                <div class="glass-effect rounded-3xl p-5 shadow-2xl">
                    <!-- クイズヘッダー -->
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                            <span class="text-3xl">🎵</span>
                            クイズ中
                        </h2>
                        <button 
                            onclick="endQuiz()"
                            class="px-4 py-2 bg-red-500/80 text-white font-bold rounded-xl btn-touch text-sm"
                        >
                            終了
                        </button>
                    </div>
                    
                    <!-- 進捗表示 -->
                    <div class="mb-4">
                        <div class="flex justify-between text-white text-sm mb-2">
                            <span id="currentQuestion">問題 1/?</span>
                            <span id="timer" class="font-bold">--</span>
                        </div>
                        <div class="w-full bg-white/20 rounded-full h-2">
                            <div id="progressBar" class="bg-white h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- 音楽波形ビジュアライザー -->
                    <div class="flex justify-center items-end gap-1 h-24 mb-4 bg-white/10 rounded-2xl p-3">
                        <div class="w-2 bg-white/60 rounded-full music-wave" style="height: 20%; animation-delay: 0s;"></div>
                        <div class="w-2 bg-white/70 rounded-full music-wave" style="height: 40%; animation-delay: 0.1s;"></div>
                        <div class="w-2 bg-white/80 rounded-full music-wave" style="height: 60%; animation-delay: 0.2s;"></div>
                        <div class="w-2 bg-white/90 rounded-full music-wave" style="height: 80%; animation-delay: 0.3s;"></div>
                        <div class="w-2 bg-white rounded-full music-wave" style="height: 100%; animation-delay: 0.4s;"></div>
                        <div class="w-2 bg-white/90 rounded-full music-wave" style="height: 80%; animation-delay: 0.5s;"></div>
                        <div class="w-2 bg-white/80 rounded-full music-wave" style="height: 60%; animation-delay: 0.6s;"></div>
                        <div class="w-2 bg-white/70 rounded-full music-wave" style="height: 40%; animation-delay: 0.7s;"></div>
                        <div class="w-2 bg-white/60 rounded-full music-wave" style="height: 20%; animation-delay: 0.8s;"></div>
                    </div>
                    
                    <!-- 現在の曲情報 -->
                    <div class="text-center mb-4">
                        <p class="text-white/70 text-sm mb-2">この曲のタイトルは?</p>
                        <p id="currentSongTitle" class="text-lg font-bold text-white hidden">曲名がここに表示されます</p>
                    </div>
                    
                    <!-- プレイヤーボタン -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div id="playerButtons" class="col-span-2 grid grid-cols-2 gap-3">
                            <!-- プレイヤーボタンはJSで動的生成 -->
                        </div>
                    </div>
                    
                    <!-- コントロールボタン -->
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <button 
                                onclick="playIntro()"
                                id="playButton"
                                class="py-5 bg-white text-cyan-600 font-bold rounded-2xl btn-touch shadow-lg mobile-btn"
                            >
                                ▶️ 再生
                            </button>
                            <button 
                                onclick="pauseIntro()"
                                id="pauseButton"
                                class="py-5 bg-orange-500 text-white font-bold rounded-2xl btn-touch shadow-lg mobile-btn"
                                disabled
                            >
                                ⏸️ 停止
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button 
                                onclick="showAnswer()"
                                id="showAnswerButton"
                                class="py-4 bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold rounded-2xl btn-touch shadow-lg"
                            >
                                💡 答え
                            </button>
                            <button 
                                onclick="nextQuestion()"
                                id="nextButton"
                                class="py-4 bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold rounded-2xl btn-touch shadow-lg"
                            >
                                ➡️ 次へ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let players = JSON.parse(localStorage.getItem('quizPlayers')) || [];
        let scores = JSON.parse(localStorage.getItem('quizScores')) || {};
        let selectedSongs = JSON.parse(localStorage.getItem('selectedSongs')) || []; // 曲を保持
        let currentQuestionIndex = 0;
        let introTime = 5;
        let questionAnswered = false;
        let ytPlayer = null;
        let playbackTimer = null;
        let nextPageToken = null; // ページネーション用
        let currentSearchQuery = ''; // 現在の検索クエリ
        let isPlaying = false; // 再生状態
        let videoLoaded = false; // 動画ロード完了フラグ

        // YouTube IFrame API準備完了
        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('player', {
                height: '0',
                width: '0',
                playerVars: {
                    'playsinline': 1,
                    'controls': 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }
        
        // プレイヤー準備完了
        function onPlayerReady(event) {
            // ミュート解除（音が出るようにする）
            event.target.unMute();
            event.target.setVolume(100);
        }
        
        // プレイヤー状態変更
        function onPlayerStateChange(event) {
            // 動画がロードされたら（CUED = 5）
            if (event.data === 5 || event.data === 1) {
                videoLoaded = true;
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            updatePlayerList();
            updateScoreBoard();
            updateSelectedSongs(); // 保存されている曲を表示
            
            // イントロ時間スライダー
            document.getElementById('introTime').addEventListener('input', function(e) {
                introTime = parseInt(e.target.value);
                document.getElementById('introTimeDisplay').textContent = introTime;
            });
        });

        // プレイヤー追加
        function addPlayer() {
            const input = document.getElementById('newPlayerName');
            const name = input.value.trim();
            
            if (!name) {
                alert('プレイヤー名を入力してください');
                return;
            }
            
            if (players.length >= 4) {
                alert('最大4人までです');
                return;
            }
            
            if (players.some(p => p.name === name)) {
                alert('同じ名前のプレイヤーが既に存在します');
                return;
            }
            
            const player = {
                id: Date.now(),
                name: name
            };
            
            players.push(player);
            if (!scores[player.id]) {
                scores[player.id] = 0;
            }
            
            savePlayers();
            saveScores();
            updatePlayerList();
            updateScoreBoard();
            input.value = '';
        }

        // プレイヤー削除
        function removePlayer(playerId) {
            if (confirm('このプレイヤーを削除しますか?')) {
                players = players.filter(p => p.id !== playerId);
                savePlayers();
                updatePlayerList();
                updateScoreBoard();
            }
        }

        // プレイヤーリスト更新
        function updatePlayerList() {
            const container = document.getElementById('playerList');
            
            if (players.length === 0) {
                container.innerHTML = '<div class="text-center text-white/60 py-4 text-sm">プレイヤーを追加してください</div>';
                return;
            }
            
            container.innerHTML = players.map(player => `
                <div class="glass-effect rounded-2xl p-4 flex items-center justify-between player-card">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                            ${player.name.charAt(0).toUpperCase()}
                        </div>
                        <span class="text-white font-semibold">${player.name}</span>
                    </div>
                    <button 
                        onclick="removePlayer(${player.id})"
                        class="text-red-300 hover:text-red-100 font-bold text-2xl w-10 h-10 flex items-center justify-center"
                    >
                        ✕
                    </button>
                </div>
            `).join('');
        }

        // スコアボード更新
        function updateScoreBoard() {
            const container = document.getElementById('scoreBoard');
            
            if (players.length === 0) {
                container.innerHTML = '<div class="text-center text-white/60 py-3 text-sm">プレイヤーがいません</div>';
                return;
            }
            
            const sortedPlayers = [...players].sort((a, b) => (scores[b.id] || 0) - (scores[a.id] || 0));
            
            container.innerHTML = sortedPlayers.map((player, index) => {
                const score = scores[player.id] || 0;
                const medals = ['🥇', '🥈', '🥉'];
                const medal = index < 3 ? medals[index] : '🏅';
                
                return `
                    <div class="flex items-center justify-between bg-white/10 rounded-xl p-3">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${medal}</span>
                            <span class="text-white font-semibold">${player.name}</span>
                        </div>
                        <span class="text-xl font-bold text-white">${score}pt</span>
                    </div>
                `;
            }).join('');
        }

        // スコアクリア
        function clearScores() {
            if (confirm('全てのスコアをクリアしますか?')) {
                scores = {};
                players.forEach(player => {
                    scores[player.id] = 0;
                });
                saveScores();
                updateScoreBoard();
            }
        }        
        // APIキーを取得
        function getApiKey() {
            // 1. LocalStorageから取得（GitHub Pages用）
            const storedKey = localStorage.getItem('youtubeApiKey');
            if (storedKey) {
                return storedKey;
            }
            
            // 2. config.jsから取得（ローカル開発用）
            if (typeof CONFIG !== 'undefined' && CONFIG.YOUTUBE_API_KEY) {
                return CONFIG.YOUTUBE_API_KEY;
            }
            
            // 3. 取得できない場合
            return null;
        }

        // YouTube検索
        async function searchYouTube(clearResults = true) {
            // APIキーを取得
            const apiKey = getApiKey();
            
            if (!apiKey) {
                if (confirm('APIキーが設定されていません。\n設定ページに移動しますか？')) {
                    window.location.href = 'setup.html';
                }
                return;
            }
            
            const query = document.getElementById('searchQuery').value.trim();
            
            if (!query) {
                alert('検索キーワードを入力してください');
                return;
            }
            
            // 新しい検索の場合はリセット
            if (clearResults) {
                nextPageToken = null;
                currentSearchQuery = query;
            }
            
            const container = document.getElementById('searchResults');
            
            if (clearResults) {
                container.innerHTML = '<div class="text-white/70 text-center py-3 text-sm">検索中...</div>';
            } else {
                // 「もっと見る」ボタンを「読み込み中...」に変更
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                if (loadMoreBtn) {
                    loadMoreBtn.textContent = '読み込み中...';
                    loadMoreBtn.disabled = true;
                }
            }
            
            try {
                let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query + ' music')}&type=video&videoCategoryId=10&maxResults=30&key=${apiKey}`;
                
                // ページトークンがある場合は追加
                if (!clearResults && nextPageToken) {
                    url += `&pageToken=${nextPageToken}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('検索に失敗しました');
                }
                
                const data = await response.json();
                
                // 次のページトークンを保存
                nextPageToken = data.nextPageToken || null;
                
                if (!data.items || data.items.length === 0) {
                    if (clearResults) {
                        container.innerHTML = '<div class="text-white/70 text-center py-3 text-sm">結果が見つかりませんでした</div>';
                    }
                    return;
                }
                
                const resultHTML = data.items.map(item => `
                    <div class="bg-white/10 rounded-xl p-3 flex items-center gap-3">
                        <img src="${item.snippet.thumbnails.default.url}" class="w-16 h-12 rounded object-cover" />
                        <div class="flex-1 min-w-0">
                            <p class="text-white text-sm font-semibold truncate">${item.snippet.title}</p>
                            <p class="text-white/60 text-xs truncate">${item.snippet.channelTitle}</p>
                        </div>
                        <button 
                            onclick="addSong('${item.id.videoId}', '${item.snippet.title.replace(/'/g, "\\'")}', '${item.snippet.thumbnails.default.url}')"
                            class="px-3 py-2 bg-cyan-500 text-white rounded-lg btn-touch text-xs font-bold flex-shrink-0"
                        >
                            追加
                        </button>
                    </div>
                `).join('');
                
                // 「もっと見る」ボタンのHTML
                const loadMoreHTML = nextPageToken ? `
                    <button 
                        id="loadMoreBtn"
                        onclick="loadMoreResults()"
                        class="w-full py-3 bg-white/20 text-white font-bold rounded-xl btn-touch text-sm mt-2"
                    >
                        ⬇️ もっと見る（${data.items.length}件追加表示）
                    </button>
                ` : '';
                
                if (clearResults) {
                    container.innerHTML = resultHTML + loadMoreHTML;
                } else {
                    // 既存の結果に追加
                    const existingHTML = container.innerHTML.replace(/<button[^>]*id="loadMoreBtn"[^>]*>.*?<\/button>/s, '');
                    container.innerHTML = existingHTML + resultHTML + loadMoreHTML;
                }
                
            } catch (error) {
                if (clearResults) {
                    container.innerHTML = '<div class="text-red-300 text-center py-3 text-sm">エラー: ' + error.message + '</div>';
                } else {
                    alert('エラー: ' + error.message);
                }
            }
        }
        
        // もっと見るボタン
        async function loadMoreResults() {
            await searchYouTube(false);
        }

        // 曲を追加
        function addSong(videoId, title, thumbnail) {
            if (selectedSongs.some(s => s.videoId === videoId)) {
                alert('この曲は既に追加されています');
                return;
            }
            
            selectedSongs.push({ videoId, title, thumbnail });
            saveSelectedSongs(); // LocalStorageに保存
            updateSelectedSongs();
        }

        // 選択済み曲を削除
        function removeSong(videoId) {
            selectedSongs = selectedSongs.filter(s => s.videoId !== videoId);
            saveSelectedSongs(); // LocalStorageに保存
            updateSelectedSongs();
        }

        // 選択済み曲リスト更新
        function updateSelectedSongs() {
            const container = document.getElementById('selectedSongs');
            const countDisplay = document.getElementById('selectedCount');
            
            countDisplay.textContent = selectedSongs.length;
            
            if (selectedSongs.length === 0) {
                container.innerHTML = '<div class="text-white/60 text-center py-2 text-xs">曲を追加してください</div>';
                return;
            }
            
            container.innerHTML = selectedSongs.map(song => `
                <div class="bg-white/10 rounded-lg p-2 flex items-center gap-2">
                    <img src="${song.thumbnail}" class="w-12 h-9 rounded object-cover" />
                    <div class="flex-1 min-w-0">
                        <p class="text-white text-xs truncate">${song.title}</p>
                    </div>
                    <button 
                        onclick="removeSong('${song.videoId}')"
                        class="text-red-300 font-bold text-lg w-8 h-8 flex items-center justify-center"
                    >
                        ✕
                    </button>
                </div>
            `).join('');
        }

        // クイズ開始
        function startQuiz() {
            if (players.length === 0) {
                alert('プレイヤーを追加してください');
                return;
            }
            
            if (selectedSongs.length === 0) {
                alert('曲を選択してください');
                return;
            }
            
            if (!ytPlayer) {
                alert('YouTube Playerの準備ができていません。少し待ってから再試行してください。');
                return;
            }
            
            // ユーザーのクリックアクションで音声を有効化（重要！）
            try {
                ytPlayer.unMute();
                ytPlayer.setVolume(100);
                // ダミー再生で音声を確実に有効化
                ytPlayer.playVideo();
                setTimeout(() => {
                    ytPlayer.pauseVideo();
                }, 100);
            } catch (e) {
                console.log('音声初期化エラー:', e);
            }
            
            currentQuestionIndex = 0;
            shuffleArray(selectedSongs);
            
            document.getElementById('userManagement').classList.add('hidden');
            document.getElementById('quizGame').classList.remove('hidden');
            
            loadQuestion();
        }

        // 問題読み込み
        function loadQuestion() {
            questionAnswered = false;
            document.getElementById('currentSongTitle').classList.add('hidden');
            
            // タイマーをクリア
            if (playbackTimer) {
                clearInterval(playbackTimer);
                playbackTimer = null;
            }
            
            // タイマー表示をリセット
            document.getElementById('timer').textContent = '--';
            
            // ボタン状態をリセット
            isPlaying = false;
            document.getElementById('playButton').disabled = false;
            document.getElementById('pauseButton').disabled = true;
            
            const progress = ((currentQuestionIndex + 1) / selectedSongs.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = 
                `問題 ${currentQuestionIndex + 1}/${selectedSongs.length}`;
            
            // プレイヤーボタン生成
            const buttonContainer = document.getElementById('playerButtons');
            buttonContainer.innerHTML = players.map(player => `
                <button 
                    onclick="playerAnswer(${player.id})"
                    class="py-6 bg-gradient-to-br from-purple-500 to-pink-500 text-white font-bold rounded-2xl btn-touch shadow-lg mobile-btn"
                >
                    ${player.name}
                </button>
            `).join('');
            
            // YouTube動画をロード（loadVideoByIdで音声も準備）
            const song = selectedSongs[currentQuestionIndex];
            ytPlayer.loadVideoById({
                videoId: song.videoId,
                startSeconds: 0
            });
            // ロード後すぐに停止（再生ボタンを押すまで待機）
            setTimeout(() => {
                ytPlayer.pauseVideo();
            }, 500);
        }

        // イントロ再生
        async function playIntro() {
            if (!ytPlayer) {
                alert('YouTube Playerが準備できていません');
                return;
            }
            
            // タイマーをクリア
            if (playbackTimer) {
                clearInterval(playbackTimer);
            }
            
            // ボタンを「準備中」に
            const playBtn = document.getElementById('playButton');
            const pauseBtn = document.getElementById('pauseButton');
            playBtn.textContent = '準備中...';
            playBtn.disabled = true;
            
            try {
                // 確実にミュート解除（ユーザー操作時なので確実に実行される）
                ytPlayer.unMute();
                ytPlayer.setVolume(100);
                
                // 動画を最初から再ロード（音声も含めて）
                ytPlayer.loadVideoById({
                    videoId: selectedSongs[currentQuestionIndex].videoId,
                    startSeconds: 0
                });
                
                // 動画のロード完了を待つ
                await waitForVideoLoad();
                
                // 再生開始
                ytPlayer.playVideo();
                
                // ボタン状態を更新
                isPlaying = true;
                playBtn.textContent = '▶️ 再生';
                playBtn.disabled = true;
                pauseBtn.disabled = false;
                
                const startTime = Date.now();
                const targetDuration = introTime * 1000;
                const timerDisplay = document.getElementById('timer');
                
                playbackTimer = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const remaining = Math.max(0, Math.ceil((targetDuration - elapsed) / 1000));
                    
                    timerDisplay.textContent = remaining + '秒';
                    
                    if (elapsed >= targetDuration) {
                        clearInterval(playbackTimer);
                        ytPlayer.pauseVideo();
                        timerDisplay.textContent = '終了';
                        isPlaying = false;
                        playBtn.disabled = false;
                        pauseBtn.disabled = true;
                    }
                }, 100);
                
            } catch (error) {
                alert('動画の読み込みに失敗しました: ' + error.message);
                playBtn.textContent = '▶️ 再生';
                playBtn.disabled = false;
            }
        }
        
        // 動画のロード完了を待つ
        function waitForVideoLoad() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5秒まで待つ
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    // プレイヤー状態をチェック
                    const state = ytPlayer.getPlayerState();
                    
                    // BUFFERING(3), CUED(5), PLAYING(1) なら準備完了
                    if (state === 3 || state === 5 || state === 1 || state === 2) {
                        clearInterval(checkInterval);
                        // さらに少し待つ（音声の準備）
                        setTimeout(() => resolve(), 300);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('動画のロードがタイムアウトしました'));
                    }
                }, 100);
            });
        }
        
        // イントロ一時停止
        function pauseIntro() {
            if (!ytPlayer) {
                return;
            }
            
            // 再生を停止
            ytPlayer.pauseVideo();
            
            // タイマーを停止
            if (playbackTimer) {
                clearInterval(playbackTimer);
                playbackTimer = null;
            }
            
            // ボタン状態を更新
            isPlaying = false;
            document.getElementById('playButton').disabled = false;
            document.getElementById('pauseButton').disabled = true;
            document.getElementById('timer').textContent = '停止中';
        }

        // プレイヤー回答
        function playerAnswer(playerId) {
            if (questionAnswered) {
                alert('この問題は既に回答されています');
                return;
            }
            
            const player = players.find(p => p.id === playerId);
            const correctAnswer = confirm(`${player.name}さんの回答は正解ですか?`);
            
            if (correctAnswer) {
                // イントロ再生を停止
                if (ytPlayer) {
                    ytPlayer.pauseVideo();
                }
                if (playbackTimer) {
                    clearInterval(playbackTimer);
                    playbackTimer = null;
                }
                document.getElementById('timer').textContent = '正解!';
                
                scores[playerId] = (scores[playerId] || 0) + 10;
                saveScores();
                updateScoreBoard();
                questionAnswered = true;
                
                alert(`🎉 正解! ${player.name}さんに10ポイント!`);
            } else {
                alert(`❌ 不正解...`);
            }
        }

        // 答えを表示
        function showAnswer() {
            // タイマーをクリア
            if (playbackTimer) {
                clearInterval(playbackTimer);
                playbackTimer = null;
            }
            
            const song = selectedSongs[currentQuestionIndex];
            
            document.getElementById('currentSongTitle').textContent = song.title;
            document.getElementById('currentSongTitle').classList.remove('hidden');
            document.getElementById('timer').textContent = '答え表示中';
            
            // 全曲再生
            if (ytPlayer) {
                // ミュート解除を確認
                if (ytPlayer.isMuted()) {
                    ytPlayer.unMute();
                }
                ytPlayer.setVolume(100);
                
                ytPlayer.seekTo(0, true);
                setTimeout(() => {
                    ytPlayer.playVideo();
                }, 300);
            }
        }

        // 次の問題
        function nextQuestion() {
            // 再生を停止
            if (ytPlayer) {
                ytPlayer.pauseVideo();
                ytPlayer.stopVideo();
            }
            
            // タイマーをクリア
            if (playbackTimer) {
                clearInterval(playbackTimer);
                playbackTimer = null;
            }
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= selectedSongs.length) {
                endQuiz();
            } else {
                loadQuestion();
            }
        }

        // クイズ終了
        function endQuiz() {
            // 再生を完全停止
            if (ytPlayer) {
                ytPlayer.pauseVideo();
                ytPlayer.stopVideo();
            }
            
            // タイマーをクリア
            if (playbackTimer) {
                clearInterval(playbackTimer);
                playbackTimer = null;
            }
            
            document.getElementById('quizGame').classList.add('hidden');
            document.getElementById('userManagement').classList.remove('hidden');
            
            // 最終結果表示
            const sortedPlayers = [...players].sort((a, b) => (scores[b.id] || 0) - (scores[a.id] || 0));
            const winner = sortedPlayers[0];
            
            if (winner && scores[winner.id] > 0) {
                alert(`🏆 優勝: ${winner.name}さん (${scores[winner.id]}ポイント)`);
            }
        }

        // ユーティリティ関数
        function savePlayers() {
            localStorage.setItem('quizPlayers', JSON.stringify(players));
        }

        function saveScores() {
            localStorage.setItem('quizScores', JSON.stringify(scores));
        }
        
        function saveSelectedSongs() {
            localStorage.setItem('selectedSongs', JSON.stringify(selectedSongs));
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    </script>
</body>
</html>
