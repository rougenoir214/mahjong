<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>éº»é›€æˆç¸¾ç®¡ç† Firebaseç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; -webkit-font-smoothing: antialiased; }
        * { -webkit-tap-highlight-color: transparent; }
        input, select, button { font-size: 16px !important; }
        .animate-fade { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { border-collapse: collapse; min-width: 100%; }
        .login-screen { 
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-gradient-to-br from-cyan-50 via-blue-50 to-teal-50 min-h-screen">

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginScreen" class="login-screen">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 animate-fade">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">ğŸ€„</div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">éº»é›€æˆç¸¾ç®¡ç†</h1>
                <p class="text-gray-600">Firebaseç‰ˆ</p>
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="passwordInput" 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-cyan-500 focus:outline-none"
                       placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                       onkeypress="if(event.key==='Enter') login()">
            </div>
            <button onclick="login()" 
                    class="w-full bg-gradient-to-r from-cyan-600 to-teal-600 text-white py-3 rounded-lg font-bold hover:opacity-90 transition">
                ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <div id="loginError" class="mt-4 text-red-500 text-sm text-center hidden"></div>
            <div class="mt-6 text-center text-sm text-gray-500">
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç®¡ç†è€…ã‹ã‚‰å–å¾—ã—ã¦ãã ã•ã„
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è¡¨ç¤ºï¼‰ -->
    <div id="mainApp" style="display: none;">
        <header class="bg-gradient-to-r from-cyan-600 to-teal-600 text-white shadow-lg sticky top-0 z-50">
            <div class="px-3 py-3">
                <div class="flex items-center justify-between mb-2">
                    <h1 class="text-xl font-bold">ğŸ€„ éº»é›€æˆç¸¾ç®¡ç†</h1>
                    <div class="flex items-center gap-2">
                        <div id="syncStatus" class="text-xs px-2 py-1 bg-white/20 rounded">
                            <span class="pulse">ğŸ”„</span> åŒæœŸä¸­...
                        </div>
                        <button onclick="logout()" class="bg-white/20 active:bg-white/30 px-3 py-2 rounded text-xs">
                            ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                        </button>
                    </div>
                </div>
                <div class="flex gap-2 justify-center">
                    <button onclick="exportData()" class="bg-white/20 active:bg-white/30 px-3 py-2 rounded text-xs">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button onclick="document.getElementById('fileInput').click()" class="bg-white/20 active:bg-white/30 px-3 py-2 rounded text-xs">ğŸ“¤ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                </div>
            </div>
        </header>
        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="importData(event)">

        <div class="px-3 py-4">
            <div id="stats" class="grid grid-cols-2 gap-2 mb-4"></div>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-4 animate-fade">
                <div class="flex border-b">
                    <button onclick="switchTab('input')" id="tab-input" class="flex-1 px-4 py-3 text-sm font-medium bg-gradient-to-r from-cyan-500 to-teal-500 text-white">å…¥åŠ›</button>
                    <button onclick="switchTab('daily')" id="tab-daily" class="flex-1 px-4 py-3 text-sm font-medium text-gray-600">æ—¥åˆ¥</button>
                    <button onclick="switchTab('players')" id="tab-players" class="flex-1 px-4 py-3 text-sm font-medium text-gray-600">çµ±è¨ˆ</button>
                </div>
                <div id="content-input" class="p-4">
                    <div class="mb-3">
                        <label class="block text-sm font-medium mb-1">æ—¥ä»˜</label>
                        <input type="date" id="selectedDate" onchange="dateChanged()" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium mb-1">éº»é›€ã®ç¨®é¡</label>
                        <select id="gameType" onchange="gameTypeChanged()" class="w-full px-3 py-2 border rounded-lg">
                            <option value="4">4äººéº»é›€</option>
                            <option value="3">3äººéº»é›€</option>
                        </select>
                    </div>
                    <div id="playerSelects"></div>
                    <div id="scoreInputs"></div>
                    <button onclick="addGame()" class="w-full bg-gradient-to-r from-cyan-500 to-teal-500 text-white py-3 rounded-lg font-bold mt-3 active:opacity-80">åŠè˜ã‚’è¿½åŠ </button>
                    <div id="gamesList"></div>
                    <div class="mt-4 flex gap-2">
                        <input type="text" id="newPlayer" placeholder="æ–°ã—ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å" class="flex-1 px-3 py-2 border rounded-lg">
                        <button onclick="addPlayer()" class="bg-green-500 text-white px-4 py-2 rounded-lg active:bg-green-600">è¿½åŠ </button>
                    </div>
                    <button onclick="if(confirm('æœ¬å½“ã«ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) clearToday()" class="w-full bg-red-500 text-white py-2 rounded-lg mt-3 active:bg-red-600">ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
                </div>
                <div id="content-daily" class="p-4" style="display:none;">
                    <div id="dailyList"></div>
                </div>
                <div id="content-players" class="p-4" style="display:none;">
                    <div id="playerStats"></div>
                </div>
            </div>
        </div>

        <div id="notification" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg" style="display:none;"></div>
    </div>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyA7bkfPDgs3iSNFC2MOxjs1aakbHbMi-jM",
            authDomain: "mahjong-337a9.firebaseapp.com",
            databaseURL: "https://mahjong-337a9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mahjong-337a9",
            storageBucket: "mahjong-337a9.firebasestorage.app",
            messagingSenderId: "605742422445",
            appId: "1:605742422445:web:e207ae05cba0a67f7b2924",
            measurementId: "G-2VDY4LKSPP"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ç°¡æ˜“ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®é‹ç”¨ã§ã¯ç’°å¢ƒå¤‰æ•°ãªã©ã«æ ¼ç´æ¨å¥¨ï¼‰
        const APP_PASSWORD = "mahjong2025";
        
        // ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹
        let data = { dates: {} };
        let allPlayers = [];
        let currentTab = 'input';
        let isLoggedIn = false;

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function login() {
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');
            
            if (password === APP_PASSWORD) {
                isLoggedIn = true;
                localStorage.setItem('mahjong_logged_in', 'true');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                errorDiv.classList.add('hidden');
                
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                loadFromFirebase();
            } else {
                errorDiv.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™';
                errorDiv.classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                isLoggedIn = false;
                localStorage.removeItem('mahjong_logged_in');
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('passwordInput').value = '';
            }
        }

        // åˆæœŸåŒ–æ™‚ã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        window.addEventListener('DOMContentLoaded', () => {
            const loggedIn = localStorage.getItem('mahjong_logged_in');
            if (loggedIn === 'true') {
                isLoggedIn = true;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                loadFromFirebase();
            }
        });

        // Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadFromFirebase() {
            updateSyncStatus('loading');
            
            database.ref('mahjong').once('value')
                .then((snapshot) => {
                    const firebaseData = snapshot.val();
                    if (firebaseData) {
                        data = firebaseData.data || { dates: {} };
                        allPlayers = firebaseData.allPlayers || [];
                    }
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚’é–‹å§‹
                    setupRealtimeListener();
                    
                    // åˆæœŸè¡¨ç¤º
                    document.getElementById('selectedDate').valueAsDate = new Date();
                    dateChanged();
                    render();
                    updateSyncStatus('synced');
                })
                .catch((error) => {
                    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    notify('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    updateSyncStatus('error');
                });
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã®è¨­å®š
        function setupRealtimeListener() {
            database.ref('mahjong').on('value', (snapshot) => {
                const firebaseData = snapshot.val();
                if (firebaseData) {
                    data = firebaseData.data || { dates: {} };
                    allPlayers = firebaseData.allPlayers || [];
                    render();
                    updateSyncStatus('synced');
                }
            });
        }

        // Firebaseã¸ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveToFirebase() {
            updateSyncStatus('saving');
            
            database.ref('mahjong').set({
                data: data,
                allPlayers: allPlayers,
                lastUpdated: new Date().toISOString()
            })
            .then(() => {
                updateSyncStatus('synced');
            })
            .catch((error) => {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                notify('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                updateSyncStatus('error');
            });
        }

        // åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateSyncStatus(status) {
            const statusDiv = document.getElementById('syncStatus');
            if (!statusDiv) return;
            
            switch(status) {
                case 'loading':
                    statusDiv.innerHTML = '<span class="pulse">â³</span> èª­è¾¼ä¸­...';
                    statusDiv.className = 'text-xs px-2 py-1 bg-white/20 rounded';
                    break;
                case 'saving':
                    statusDiv.innerHTML = '<span class="pulse">ğŸ’¾</span> ä¿å­˜ä¸­...';
                    statusDiv.className = 'text-xs px-2 py-1 bg-white/20 rounded';
                    break;
                case 'synced':
                    statusDiv.innerHTML = 'âœ… åŒæœŸå®Œäº†';
                    statusDiv.className = 'text-xs px-2 py-1 bg-green-500/80 rounded';
                    setTimeout(() => {
                        statusDiv.innerHTML = 'â˜ï¸ åŒæœŸæ¸ˆã¿';
                        statusDiv.className = 'text-xs px-2 py-1 bg-white/20 rounded';
                    }, 2000);
                    break;
                case 'error':
                    statusDiv.innerHTML = 'âŒ ã‚¨ãƒ©ãƒ¼';
                    statusDiv.className = 'text-xs px-2 py-1 bg-red-500/80 rounded';
                    break;
            }
        }

        // é€šçŸ¥è¡¨ç¤º
        function notify(msg, type = 'success') {
            const n = document.getElementById('notification');
            if (!n) return;
            
            n.textContent = msg;
            n.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            } text-white`;
            n.style.display = 'block';
            setTimeout(() => n.style.display = 'none', 3000);
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            currentTab = tab;
            ['input','daily','players'].forEach(t => {
                document.getElementById('content-'+t).style.display = t===tab ? 'block' : 'none';
                document.getElementById('tab-'+t).className = 'flex-1 px-4 py-3 text-sm font-medium ' + 
                    (t===tab ? 'bg-gradient-to-r from-cyan-500 to-teal-500 text-white' : 'text-gray-600');
            });
            if(tab==='daily') renderDaily();
            if(tab==='players') renderPlayers();
        }

        // æ—¥ä»˜å¤‰æ›´
        let selectedDate = '';
        function dateChanged() {
            selectedDate = document.getElementById('selectedDate').value;
            render();
        }

        // éº»é›€ã®ç¨®é¡å¤‰æ›´
        function gameTypeChanged() {
            const d = getData();
            d.type = parseInt(document.getElementById('gameType').value);
            if(d.players.length > d.type) d.players = d.players.slice(0, d.type);
            saveToFirebase();
            render();
        }

        // ãƒ‡ãƒ¼ã‚¿å–å¾—
        function getData() {
            if(!data.dates[selectedDate]) {
                data.dates[selectedDate] = { type:4, players:[], games:[] };
            }
            return data.dates[selectedDate];
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰æ›´
        function playerChanged(index, value) {
            if(value==='__new__') {
                const name = prompt('æ–°ã—ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å');
                if(name && name.trim()) {
                    if(!allPlayers.includes(name.trim())) {
                        allPlayers.push(name.trim());
                    }
                    getData().players[index] = name.trim();
                    saveToFirebase();
                    render();
                }
            } else {
                getData().players[index] = value;
                saveToFirebase();
                render();
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ 
        function addPlayer() {
            const name = document.getElementById('newPlayer').value.trim();
            if(name && !allPlayers.includes(name)) {
                allPlayers.push(name);
                document.getElementById('newPlayer').value = '';
                saveToFirebase();
                render();
                notify('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€Œ' + name + 'ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
            }
        }

        // åŠè˜è¿½åŠ 
        function addGame() {
            const d = getData();
            if(d.players.length < d.type) {
                alert('å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            const scores = d.players.map((p,i) => parseInt(document.getElementById('score'+i).value) || 0);
            
            // ã‚¹ã‚³ã‚¢åˆè¨ˆãƒã‚§ãƒƒã‚¯
            const total = scores.reduce((sum, s) => sum + s, 0);
            if(total !== 0) {
                const confirmResult = window.confirm(`âš ï¸ ã‚¹ã‚³ã‚¢ã®åˆè¨ˆãŒ${total>0?'+':''}${total}ã§ã™ï¼ˆ0ã«ãªã£ã¦ã„ã¾ã›ã‚“ï¼‰\n\nã“ã®ã¾ã¾ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\nã€å…¥åŠ›ã—ãŸã‚¹ã‚³ã‚¢ã€‘\n${d.players.map((p,i) => `${p}: ${scores[i]>0?'+':''}${scores[i]}`).join('\n')}\nåˆè¨ˆ: ${total>0?'+':''}${total}`);
                if(!confirmResult) return;
            }
            
            d.games.push(scores);
            saveToFirebase();
            d.players.forEach((p,i) => document.getElementById('score'+i).value = '');
            render();
            notify('åŠè˜'+d.games.length+'ã‚’è¿½åŠ ');
        }

        // åŠè˜å‰Šé™¤
        function removeGame(date, idx) {
            if(confirm('ã“ã®åŠè˜ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                data.dates[date].games.splice(idx, 1);
                saveToFirebase();
                render();
                renderDaily();
                notify('å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // ã‚¹ã‚³ã‚¢æ›´æ–°
        function updateScore(date, gIdx, pIdx, val) {
            data.dates[date].games[gIdx][pIdx] = parseInt(val) || 0;
            saveToFirebase();
        }

        // ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        function clearToday() {
            if(data.dates[selectedDate]) {
                delete data.dates[selectedDate];
                saveToFirebase();
                render();
                notify('ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function exportData() {
            const exp = { data, allPlayers, exportDate: new Date().toISOString(), version: '1.0' };
            const jsonStr = JSON.stringify(exp, null, 2);
            const filename = 'mahjong_'+new Date().toISOString().split('T')[0]+'.json';
            
            // iOSã§å…±æœ‰ã‚·ãƒ¼ãƒˆã‚’ä½¿ã†ï¼ˆWeb Share APIï¼‰
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if(isIOS && navigator.share) {
                const file = new File([jsonStr], filename, { type: 'application/json' });
                navigator.share({
                    files: [file],
                    title: 'éº»é›€æˆç¸¾ãƒ‡ãƒ¼ã‚¿',
                    text: 'éº»é›€æˆç¸¾ç®¡ç†ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿'
                }).then(() => {
                    notify('å…±æœ‰å®Œäº†');
                }).catch((err) => {
                    if(err.name !== 'AbortError') {
                        downloadFile(jsonStr, filename);
                    }
                });
            } else {
                downloadFile(jsonStr, filename);
            }
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if(isIOS) {
                setTimeout(() => {
                    alert('ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nã€ä¿å­˜å ´æ‰€ã€‘\n1. Safariã®ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ï¼ˆâ†“ï¼‰ã‚’ã‚¿ãƒƒãƒ—\n2. ã¾ãŸã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¢ãƒ—ãƒªã®ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèª\n\nä¿å­˜å ´æ‰€ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒªã§ç§»å‹•ã§ãã¾ã™ã€‚');
                }, 500);
            } else {
                notify('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
            }
        }

        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function importData(e) {
            const file = e.target.files[0];
            if(!file) {
                console.log('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹:', file.name);
            const reader = new FileReader();
            
            reader.onerror = (error) => {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            };
            
            reader.onload = (ev) => {
                try {
                    console.log('ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:', ev.target.result.substring(0, 200));
                    const imp = JSON.parse(ev.target.result);
                    console.log('ãƒ‘ãƒ¼ã‚¹æˆåŠŸ:', imp);
                    
                    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æ¤œè¨¼
                    if(!imp.data || typeof imp.data !== 'object') {
                        throw new Error('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: data ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    if(!imp.data.dates || typeof imp.data.dates !== 'object') {
                        throw new Error('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: data.dates ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    if(!imp.allPlayers || !Array.isArray(imp.allPlayers)) {
                        throw new Error('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: allPlayers ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    
                    // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒæœªåˆæœŸåŒ–ã®å ´åˆã¯åˆæœŸåŒ–
                    if(!data || typeof data !== 'object') {
                        data = { dates: {} };
                    }
                    if(!data.dates || typeof data.dates !== 'object') {
                        data.dates = {};
                    }
                    if(!allPlayers || !Array.isArray(allPlayers)) {
                        allPlayers = [];
                    }
                    
                    if(confirm('ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\n\nOK: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ \nã‚­ãƒ£ãƒ³ã‚»ãƒ«: ã™ã¹ã¦ä¸Šæ›¸ã')) {
                        // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
                        let addedCount = 0;
                        Object.entries(imp.data.dates).forEach(([d,v]) => {
                            if(data.dates[d]) {
                                if(confirm(d+'ã®ãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) {
                                    data.dates[d] = v;
                                    addedCount++;
                                }
                            } else {
                                data.dates[d] = v;
                                addedCount++;
                            }
                        });
                        
                        let newPlayers = 0;
                        imp.allPlayers.forEach(p => { 
                            if(!allPlayers.includes(p)) {
                                allPlayers.push(p);
                                newPlayers++;
                            }
                        });
                        
                        console.log(`è¿½åŠ å®Œäº†: ${addedCount}æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿, ${newPlayers}äººã®æ–°è¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼`);
                        notify(`è¿½åŠ å®Œäº†: ${addedCount}æ—¥åˆ†, ${newPlayers}äººè¿½åŠ `);
                    } else {
                        // ä¸Šæ›¸ããƒ¢ãƒ¼ãƒ‰
                        data = JSON.parse(JSON.stringify(imp.data)); // ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
                        allPlayers = [...imp.allPlayers]; // ã‚³ãƒ”ãƒ¼
                        console.log('ä¸Šæ›¸ãå®Œäº†');
                        notify('ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã—ãŸ');
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ç¢ºèª
                    if(!data.dates) data.dates = {};
                    console.log('æœ€çµ‚ãƒ‡ãƒ¼ã‚¿:', data);
                    console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼:', allPlayers);
                    
                    // Firebaseã«ä¿å­˜
                    saveToFirebase();
                    
                    // ç”»é¢ã‚’æ›´æ–°
                    render();
                    if(currentTab === 'daily') renderDaily();
                    if(currentTab === 'players') renderPlayers();
                    
                } catch(err) {
                    console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', err);
                    console.error('ã‚¹ã‚¿ãƒƒã‚¯:', err.stack);
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ' + err.message + '\n\nã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
            };
            
            reader.readAsText(file);
            e.target.value = '';
        }

        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function render() {
            const d = getData();
            document.getElementById('gameType').value = d.type;
            renderStats();
            renderPlayerSelectors();
            renderScoreInputs();
            renderGamesList();
        }

        // çµ±è¨ˆè¡¨ç¤º
        function renderStats() {
            const statsElement = document.getElementById('stats');
            if(!statsElement) return;
            
            let games=0, players=new Set(), score=0;
            
            // ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
            if(!data || !data.dates || typeof data.dates !== 'object') {
                console.log('ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ - åˆæœŸåŒ–ã—ã¾ã™');
                data = { dates: {} };
                statsElement.innerHTML = `
                    <div class="bg-gradient-to-br from-cyan-500 to-teal-600 rounded-lg p-3 text-white">
                        <div class="text-2xl font-bold">0</div>
                        <div class="text-xs">ç·åŠè˜æ•°</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-cyan-600 rounded-lg p-3 text-white">
                        <div class="text-2xl font-bold">0</div>
                        <div class="text-xs">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°</div>
                    </div>
                `;
                return;
            }
            
            try {
                const dateValues = Object.values(data.dates);
                console.log('å‡¦ç†ã™ã‚‹æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿æ•°:', dateValues.length);
                
                dateValues.forEach(d => {
                    if(!d || typeof d !== 'object') {
                        console.warn('ç„¡åŠ¹ãªæ—¥ä»˜ãƒ‡ãƒ¼ã‚¿:', d);
                        return;
                    }
                    if(!d.games || !Array.isArray(d.games)) {
                        console.warn('gamesé…åˆ—ãŒå­˜åœ¨ã—ãªã„ã‹ç„¡åŠ¹:', d);
                        return;
                    }
                    
                    d.games.forEach(g => {
                        if(!g || !Array.isArray(g)) {
                            console.warn('ç„¡åŠ¹ãªã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿:', g);
                            return;
                        }
                        games++;
                        g.forEach((s,i) => {
                            if(d.players && Array.isArray(d.players) && d.players[i]) {
                                players.add(d.players[i]);
                            }
                            if(typeof s === 'number') {
                                score += s;
                            }
                        });
                    });
                });
            } catch(error) {
                console.error('çµ±è¨ˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            statsElement.innerHTML = `
                <div class="bg-gradient-to-br from-cyan-500 to-teal-600 rounded-lg p-3 text-white">
                    <div class="text-2xl font-bold">${games}</div>
                    <div class="text-xs">ç·åŠè˜æ•°</div>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-cyan-600 rounded-lg p-3 text-white">
                    <div class="text-2xl font-bold">${players.size}</div>
                    <div class="text-xs">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°</div>
                </div>
            `;
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠè¡¨ç¤º
        function renderPlayerSelectors() {
            const d = getData();
            let html = '';
            for(let i=0; i<d.type; i++) {
                const current = d.players[i] || '';
                html += `<select onchange="playerChanged(${i}, this.value)" class="w-full px-3 py-2 border rounded-lg mb-2">
                    <option value="">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}ã‚’é¸æŠ...</option>
                    ${allPlayers.map(p => `<option value="${p}" ${p===current?'selected':''}>${p}</option>`).join('')}
                    <option value="__new__">+ æ–°ã—ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</option>
                </select>`;
            }
            document.getElementById('playerSelectors').innerHTML = html;
        }

        // ã‚¹ã‚³ã‚¢å…¥åŠ›è¡¨ç¤º
        function renderScoreInputs() {
            const d = getData();
            let html = '';
            d.players.forEach((p,i) => {
                html += `<div class="mb-2">
                    <label class="block text-sm mb-1">${p}</label>
                    <input type="number" id="score${i}" class="w-full px-3 py-2 border rounded-lg" placeholder="ã‚¹ã‚³ã‚¢">
                </div>`;
            });
            document.getElementById('scoreInputs').innerHTML = html;
        }

        // ã‚²ãƒ¼ãƒ ãƒªã‚¹ãƒˆè¡¨ç¤º
        function renderGamesList() {
            const gamesListElement = document.getElementById('gamesList');
            if(!gamesListElement) return;
            
            try {
                const d = getData();
                if(!d || !d.games || !Array.isArray(d.games) || d.games.length === 0) {
                    gamesListElement.innerHTML = '';
                    return;
                }
                
                let html = '<div class="mt-4"><h3 class="font-bold mb-2">ä»Šæ—¥ã®åŠè˜</h3>';
                d.games.forEach((g, idx) => {
                    if(!g || !Array.isArray(g)) return;
                    const totals = g.map((s,i) => s);
                    html += `<div class="bg-gray-50 rounded-lg p-2 mb-2 text-sm">
                        <div class="font-bold mb-1">åŠè˜${idx+1}</div>
                        ${(d.players || []).map((p,i) => `<div class="flex justify-between">
                            <span>${p || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼'+(i+1)}</span>
                            <span class="${totals[i]>0?'text-green-600':totals[i]<0?'text-red-600':'text-gray-600'} font-bold">
                                ${totals[i]>0?'+':''}${totals[i] || 0}
                            </span>
                        </div>`).join('')}
                    </div>`;
                });
                html += '</div>';
                gamesListElement.innerHTML = html;
            } catch(error) {
                console.error('ã‚²ãƒ¼ãƒ ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                gamesListElement.innerHTML = '';
            }
        }

        // æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function renderDaily() {
            const dailyListElement = document.getElementById('dailyList');
            if(!dailyListElement) return;
            
            try {
                // ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
                if(!data || !data.dates || typeof data.dates !== 'object') {
                    dailyListElement.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
                    return;
                }
                
                const dates = Object.keys(data.dates).sort().reverse();
                if(dates.length===0) {
                    dailyListElement.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
                    return;
                }
                
                let html = '';
                dates.forEach(date => {
                    const d = data.dates[date];
                    if(!d || typeof d !== 'object') return;
                    if(!d.games || !Array.isArray(d.games) || d.games.length === 0) return;
                    if(!d.players || !Array.isArray(d.players)) return;
                    
                    const totals = d.players.map((p,i) => {
                        return d.games.reduce((sum,g) => {
                            if(g && Array.isArray(g) && typeof g[i] === 'number') {
                                return sum + g[i];
                            }
                            return sum;
                        }, 0);
                    });
                html += `<div class="bg-cyan-50 rounded-lg p-3 border border-cyan-200 mb-3">
                    <div class="mb-2">
                        <div class="text-sm font-bold">${new Date(date).toLocaleDateString('ja-JP',{month:'long',day:'numeric'})}</div>
                        <div class="inline-block bg-cyan-600 text-white px-2 py-1 rounded-full text-xs mt-1">${d.type}äººéº»é›€ | ${d.games.length}åŠè˜</div>
                    </div>
                    <div class="table-scroll">
                        <table class="w-full text-xs">
                            <thead><tr class="border-b-2 border-cyan-300">
                                <th class="text-left py-2 px-1 font-bold sticky left-0 bg-cyan-50">åŠè˜</th>
                                ${d.players.map(p => `<th class="text-center py-2 px-1 font-bold">${p}</th>`).join('')}
                            </tr></thead>
                            <tbody>
                                ${d.games.map((g,gi) => `<tr class="border-b border-gray-200">
                                    <td class="py-2 px-1 sticky left-0 bg-cyan-50">
                                        <div class="flex items-center gap-1">
                                            <span class="font-medium">${gi+1}</span>
                                            <button onclick="removeGame('${date}',${gi})" class="bg-red-500 text-white rounded px-2 py-1 text-xs font-bold active:bg-red-600" style="min-width:44px;min-height:32px;">å‰Šé™¤</button>
                                        </div>
                                    </td>
                                    ${g.map((s,pi) => `<td class="text-center py-2 px-1">
                                        <input type="number" value="${s}" onchange="updateScore('${date}',${gi},${pi},this.value)" 
                                            class="w-16 text-center px-1 py-1 border rounded ${s>0?'text-green-600':s<0?'text-red-600':'text-gray-600'}">
                                    </td>`).join('')}
                                </tr>`).join('')}
                                <tr class="border-t-2 border-cyan-300 bg-cyan-100 font-bold">
                                    <td class="py-2 px-1 sticky left-0 bg-cyan-100">åˆè¨ˆ</td>
                                    ${totals.map(t => `<td class="text-center py-2 px-1 ${t>0?'text-green-600':t<0?'text-red-600':'text-gray-600'}">${t>0?'+':''}${t}</td>`).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
                });
                dailyListElement.innerHTML = html;
            } catch(error) {
                console.error('æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                dailyListElement.innerHTML = '<div class="text-center py-8 text-red-400 text-sm">è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±è¨ˆè¡¨ç¤º
        function renderPlayers() {
            const playerStatsElement = document.getElementById('playerStats');
            if(!playerStatsElement) return;
            
            try {
                const stats = {};
                
                // ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
                if(!data || !data.dates || typeof data.dates !== 'object') {
                    playerStatsElement.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
                    return;
                }
                
                Object.values(data.dates).forEach(d => {
                    if(!d || typeof d !== 'object') return;
                    if(!d.games || !Array.isArray(d.games)) return;
                    if(!d.players || !Array.isArray(d.players)) return;
                    
                    d.games.forEach(g => {
                        if(!g || !Array.isArray(g)) return;
                    g.forEach((s,i) => {
                        const name = d.players[i];
                        if(!name) return;
                        if(typeof s !== 'number') return;
                        
                        if(!stats[name]) stats[name] = {name, totalGames:0, totalScore:0, ranks:{1:0,2:0,3:0,4:0}};
                        stats[name].totalGames++;
                        stats[name].totalScore += s;
                        const sorted = [...g].sort((a,b)=>b-a);
                        const rank = sorted.indexOf(s) + 1;
                        stats[name].ranks[rank]++;
                    });
                    });
                });
                
                const list = Object.values(stats).sort((a,b) => b.totalScore - a.totalScore);
                if(!list.length) {
                    playerStatsElement.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
                    return;
                }
                
                let html = '';
                list.forEach((p,idx) => {
                    const avg = Math.round(p.totalScore / p.totalGames);
                    const medal = ['ğŸ‘‘','ğŸ¥ˆ','ğŸ¥‰'][idx] || '';
                    let ranks = '';
                    for(let r=1; r<=4; r++) {
                        const count = p.ranks[r] || 0;
                        const pct = ((count/p.totalGames)*100).toFixed(1);
                        const colors = ['bg-yellow-500 text-yellow-700 bg-yellow-50','bg-gray-400 text-gray-700 bg-gray-50','bg-orange-500 text-orange-700 bg-orange-50','bg-red-500 text-red-700 bg-red-50'][r-1].split(' ');
                        ranks += `<div class="flex items-center gap-2 mb-2">
                            <span class="text-xs font-bold w-8 ${colors[1]}">${r}ä½</span>
                            <div class="flex-1 ${colors[2]} rounded-full h-6 overflow-hidden">
                                <div class="${colors[0]} h-full flex items-center justify-end px-2 text-white text-xs font-bold" style="width:${pct}%">
                                    ${pct>15?pct+'%':''}
                                </div>
                            </div>
                            <span class="text-xs font-bold ${colors[1]} w-12">${pct}%</span>
                            <span class="text-xs text-gray-500 w-10 text-right">${count}å›</span>
                        </div>`;
                    }
                    html += `<div class="bg-cyan-50 rounded-lg p-4 border border-cyan-200 mb-3">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <div class="w-10 h-10 bg-gradient-to-r from-cyan-500 to-teal-500 rounded-full flex items-center justify-center text-white font-bold">${p.name[0].toUpperCase()}</div>
                                <div>
                                    <h3 class="text-base font-bold">${medal} ${p.name}</h3>
                                    <p class="text-xs text-gray-600">${p.totalGames}åŠè˜</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-bold text-cyan-600">${p.totalScore>0?'+':''}${p.totalScore.toLocaleString()}</div>
                                <div class="text-xs text-gray-600">å¹³å‡: ${avg>0?'+':''}${avg}</div>
                            </div>
                        </div>
                        <div class="border-t border-cyan-200 pt-3">
                            <h4 class="text-xs font-bold mb-2">é †ä½å–å¾—ç‡</h4>
                            ${ranks}
                        </div>
                    </div>`;
                });
                playerStatsElement.innerHTML = html;
            } catch(error) {
                console.error('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±è¨ˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                playerStatsElement.innerHTML = '<div class="text-center py-8 text-red-400 text-sm">è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }
    </script>
</body>
</html>
