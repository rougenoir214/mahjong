<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>éº»é›€æˆç¸¾ç®¡ç† Firebaseç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; -webkit-font-smoothing: antialiased; }
        * { -webkit-tap-highlight-color: transparent; }
        input, select, button { font-size: 16px !important; }
        .animate-fade { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { border-collapse: collapse; min-width: 100%; }
        .login-screen { 
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-gradient-to-br from-cyan-50 via-blue-50 to-teal-50 min-h-screen">

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginScreen" class="login-screen">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 animate-fade">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">ğŸ€„</div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">éº»é›€æˆç¸¾ç®¡ç†</h1>
                <p class="text-gray-600">Firebaseç‰ˆ</p>
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="passwordInput" 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-cyan-500 focus:outline-none"
                       placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                       onkeypress="if(event.key==='Enter') login()">
            </div>
            <button onclick="login()" 
                    class="w-full bg-gradient-to-r from-cyan-600 to-teal-600 text-white py-3 rounded-lg font-bold hover:opacity-90 transition">
                ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <div id="loginError" class="mt-4 text-red-500 text-sm text-center hidden"></div>
            <div class="mt-6 text-center text-sm text-gray-500">
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç®¡ç†è€…ã‹ã‚‰å–å¾—ã—ã¦ãã ã•ã„
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è¡¨ç¤ºï¼‰ -->
    <div id="mainApp" style="display: none;">
        <header class="bg-gradient-to-r from-cyan-600 to-teal-600 text-white shadow-lg sticky top-0 z-50">
            <div class="px-3 py-3">
                <div class="flex items-center justify-between mb-2">
                    <h1 class="text-xl font-bold">ğŸ€„ éº»é›€æˆç¸¾ç®¡ç†</h1>
                    <div class="flex items-center gap-2">
                        <div id="syncStatus" class="text-xs px-2 py-1 bg-white/20 rounded">
                            <span class="pulse">ğŸ”„</span> åŒæœŸä¸­...
                        </div>
                        <button onclick="logout()" class="bg-white/20 active:bg-white/30 px-3 py-2 rounded text-xs">
                            ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                        </button>
                    </div>
                </div>
                <div class="flex gap-2 justify-center">
                    <button onclick="exportData()" class="bg-white/20 active:bg-white/30 px-3 py-2 rounded text-xs">ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button onclick="document.getElementById('fileInput').click()" class="bg-white/20 active:bg-white/30 px-3 py-2 rounded text-xs">ğŸ“¤ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    <button onclick="clearAllData()" class="bg-red-500/80 active:bg-red-600 px-3 py-2 rounded text-xs">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
                </div>
            </div>
        </header>
        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="importData(event)">

        <div class="px-3 py-4">
            <div id="stats" class="grid grid-cols-2 gap-2 mb-4"></div>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-4 animate-fade">
                <div class="flex border-b overflow-x-auto">
                    <button onclick="switchTab('input')" id="tab-input" class="flex-1 px-3 py-3 text-sm font-medium bg-gradient-to-r from-cyan-500 to-teal-500 text-white whitespace-nowrap">å…¥åŠ›</button>
                    <button onclick="switchTab('daily')" id="tab-daily" class="flex-1 px-3 py-3 text-sm font-medium text-gray-600 whitespace-nowrap">æ—¥åˆ¥</button>
                    <button onclick="switchTab('players')" id="tab-players" class="flex-1 px-3 py-3 text-sm font-medium text-gray-600 whitespace-nowrap">çµ±è¨ˆ</button>
                    <button onclick="switchTab('league')" id="tab-league" class="flex-1 px-3 py-3 text-sm font-medium text-gray-600 whitespace-nowrap">ğŸ† ãƒªãƒ¼ã‚°æˆ¦</button>
                </div>
                <div id="content-input" class="p-4">
                    <div class="mb-3">
                        <label class="block text-sm font-medium mb-1">æ—¥ä»˜</label>
                        <input type="date" id="selectedDate" onchange="dateChanged()" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium mb-1">éº»é›€ã®ç¨®é¡</label>
                        <select id="gameType" onchange="gameTypeChanged()" class="w-full px-3 py-2 border rounded-lg">
                            <option value="4">4äººéº»é›€</option>
                            <option value="3">3äººéº»é›€</option>
                        </select>
                    </div>
                    
                    <!-- ãƒªãƒ¼ã‚°æˆ¦é¸æŠ -->
                    <div class="mb-3 bg-amber-50 rounded-lg p-3 border-2 border-amber-300">
                        <label class="block text-sm font-medium mb-1 text-amber-800">
                            ğŸ† ãƒªãƒ¼ã‚°æˆ¦ã‹ã‚‰é¸æŠ
                        </label>
                        <select id="leagueQuickSelect" onchange="applyLeagueMembers()" class="w-full px-3 py-2 border-2 border-amber-300 rounded-lg bg-white">
                            <option value="">-- ãƒªãƒ¼ã‚°æˆ¦ã‚’é¸æŠ --</option>
                        </select>
                        <div class="text-xs text-amber-700 mt-1">ãƒªãƒ¼ã‚°æˆ¦ã‚’é¸æŠã™ã‚‹ã¨ãƒ¡ãƒ³ãƒãƒ¼ãŒè‡ªå‹•è¨­å®šã•ã‚Œã¾ã™</div>
                    </div>
                    
                    <div id="playerSelectors"></div>
                    <div id="scoreInputs"></div>
                    
                    <!-- ã‚¹ã‚³ã‚¢åˆè¨ˆè¡¨ç¤º -->
                    <div id="scoreTotal" class="mt-2 p-3 rounded-lg border-2 text-center font-bold" style="display:none;">
                        <div class="text-sm text-gray-600">ç¾åœ¨ã®åˆè¨ˆ</div>
                        <div id="scoreTotalValue" class="text-2xl"></div>
                        <div id="scoreTotalRemaining" class="text-sm text-gray-600 mt-1"></div>
                    </div>
                    
                    <button onclick="addGame()" class="w-full bg-gradient-to-r from-cyan-500 to-teal-500 text-white py-3 rounded-lg font-bold mt-3 active:opacity-80">åŠè˜ã‚’è¿½åŠ </button>
                    <div id="gamesList"></div>
                    
                    <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="mt-4 bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <h3 class="text-sm font-bold mb-2 text-gray-700">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†</h3>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="newPlayer" placeholder="æ–°ã—ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å" 
                                   class="flex-1 px-3 py-2 border rounded-lg text-sm"
                                   onkeypress="if(event.key==='Enter') addPlayer()">
                            <button onclick="addPlayer()" class="bg-green-500 text-white px-4 py-2 rounded-lg active:bg-green-600 text-sm font-bold">
                                â• è¿½åŠ 
                            </button>
                        </div>
                        <div id="playerList" class="text-xs text-gray-600"></div>
                    </div>
                    
                    <button onclick="if(confirm('æœ¬å½“ã«ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) clearToday()" 
                            class="w-full bg-red-500 text-white py-2 rounded-lg mt-3 active:bg-red-600 text-sm">
                        ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                    </button>
                </div>
                <div id="content-daily" class="p-4" style="display:none;">
                    <div id="dailyList"></div>
                </div>
                <div id="content-players" class="p-4" style="display:none;">
                    <!-- å¹´é¸æŠ -->
                    <div class="mb-4 bg-blue-50 rounded-lg p-3 border-2 border-blue-300">
                        <label class="block text-sm font-medium mb-1 text-blue-800">ğŸ“… é›†è¨ˆæœŸé–“</label>
                        <select id="playerYearSelect" onchange="renderPlayers()" class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg bg-white">
                            <option value="all">é€šç®—</option>
                        </select>
                    </div>
                    <div id="playerStats"></div>
                </div>
                <div id="content-league" class="p-4" style="display:none;">
                    <!-- å¹´é¸æŠ -->
                    <div class="mb-4 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-3 border-2 border-purple-300">
                        <label class="block text-sm font-medium mb-2 text-purple-800">ğŸ“Š è¡¨ç¤ºæœŸé–“</label>
                        <select id="leagueYearSelect" onchange="changeLeagueYear()" class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg bg-white">
                            <option value="all">é€šç®—æˆç¸¾</option>
                        </select>
                    </div>
                    
                    <!-- æ–°è¦ãƒªãƒ¼ã‚°æˆ¦ä½œæˆãƒœã‚¿ãƒ³ -->
                    <button onclick="showLeagueCreateForm()" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white py-3 rounded-lg font-bold mb-4 active:opacity-80 flex items-center justify-center gap-2">
                        <span class="text-xl">â•</span> æ–°ã—ã„ãƒªãƒ¼ã‚°æˆ¦ã‚’ä½œæˆ
                    </button>
                    
                    <!-- ãƒªãƒ¼ã‚°æˆ¦ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
                    <div id="leagueCreateForm" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-4 border-2 border-blue-300" style="display:none;">
                        <h3 class="text-lg font-bold text-blue-800 mb-3">ğŸ†• ãƒªãƒ¼ã‚°æˆ¦ã‚’ä½œæˆ</h3>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-blue-800 mb-1">ãƒªãƒ¼ã‚°æˆ¦å</label>
                            <input type="text" id="leagueName" placeholder="ä¾‹: é€±æœ«éº»é›€ä¼š" 
                                   class="w-full px-3 py-2 border-2 border-blue-300 rounded-lg text-sm">
                        </div>
                        
                        <label class="block text-sm font-medium text-blue-800 mb-2">å‚åŠ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆ4äººï¼‰</label>
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <select id="newLeaguePlayer1" class="px-3 py-2 border-2 border-blue-300 rounded-lg text-sm">
                                <option value="">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</option>
                            </select>
                            <select id="newLeaguePlayer2" class="px-3 py-2 border-2 border-blue-300 rounded-lg text-sm">
                                <option value="">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2</option>
                            </select>
                            <select id="newLeaguePlayer3" class="px-3 py-2 border-2 border-blue-300 rounded-lg text-sm">
                                <option value="">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3</option>
                            </select>
                            <select id="newLeaguePlayer4" class="px-3 py-2 border-2 border-blue-300 rounded-lg text-sm">
                                <option value="">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4</option>
                            </select>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="createLeague()" class="flex-1 bg-blue-500 text-white py-2 rounded-lg font-bold active:bg-blue-600">
                                ğŸ’¾ ä½œæˆ
                            </button>
                            <button onclick="hideLeagueCreateForm()" class="flex-1 bg-gray-400 text-white py-2 rounded-lg font-bold active:bg-gray-500">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                        </div>
                    </div>
                    
                    <!-- å¹´é¸æŠ -->
                    <div class="mb-4 bg-purple-50 rounded-lg p-3 border-2 border-purple-300">
                        <label class="block text-sm font-medium mb-1 text-purple-800">ğŸ“… é›†è¨ˆæœŸé–“</label>
                        <select id="leagueYearSelect" onchange="onLeagueYearChange()" class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg bg-white">
                            <option value="all">é€šç®—</option>
                        </select>
                    </div>
                    
                    <!-- ãƒªãƒ¼ã‚°æˆ¦ä¸€è¦§ -->
                    <div id="leagueList"></div>
                    
                    <!-- é¸æŠã•ã‚ŒãŸãƒªãƒ¼ã‚°æˆ¦ã®æˆç¸¾è¡¨ç¤º -->
                    <div id="leagueResults"></div>
                </div>
            </div>
        </div>

        <div id="notification" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg" style="display:none;"></div>
    </div>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyA7bkfPDgs3iSNFC2MOxjs1aakbHbMi-jM",
            authDomain: "mahjong-337a9.firebaseapp.com",
            databaseURL: "https://mahjong-337a9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mahjong-337a9",
            storageBucket: "mahjong-337a9.firebasestorage.app",
            messagingSenderId: "605742422445",
            appId: "1:605742422445:web:e207ae05cba0a67f7b2924",
            measurementId: "G-2VDY4LKSPP"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†ï¼ˆFirebaseã‹ã‚‰å–å¾—ï¼‰
        let appPasswords = {
            login: 'mahjong2024',      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆåˆå›ç”¨ï¼‰
            delete: 'mahjong1234'      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆåˆå›ç”¨ï¼‰
        };
        
        // ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹
        let data = { dates: {} };
        let allPlayers = [];
        let leagues = {}; // ãƒªãƒ¼ã‚°æˆ¦ãƒ‡ãƒ¼ã‚¿ { leagueId: { name, players: [], createdAt } }
        let selectedLeagueId = null; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒªãƒ¼ã‚°æˆ¦ID
        let selectedYear = 'all'; // é¸æŠã•ã‚ŒãŸå¹´ï¼ˆ'all', '2025', '2024'ãªã©ï¼‰
        let currentTab = 'input';
        let isLoggedIn = false;

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ï¼ˆXSSå¯¾ç­–ï¼‰
        function escapeHtml(text) {
            if (text == null) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function showNotification(message, duration = 3000) {
            // æ—¢å­˜ã®é€šçŸ¥ãŒã‚ã‚Œã°å‰Šé™¤
            const existing = document.getElementById('notification');
            if (existing) {
                existing.remove();
            }

            // é€šçŸ¥è¦ç´ ã‚’ä½œæˆ
            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.innerHTML = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: bold;
                animation: slideDown 0.3s ease-out;
                max-width: 90%;
                text-align: center;
            `;

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ ï¼ˆã¾ã ãªã‘ã‚Œã°ï¼‰
            if (!document.getElementById('notificationStyles')) {
                const style = document.createElement('style');
                style.id = 'notificationStyles';
                style.textContent = `
                    @keyframes slideDown {
                        from {
                            opacity: 0;
                            transform: translateX(-50%) translateY(-20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(-50%) translateY(0);
                        }
                    }
                    @keyframes slideUp {
                        from {
                            opacity: 1;
                            transform: translateX(-50%) translateY(0);
                        }
                        to {
                            opacity: 0;
                            transform: translateX(-50%) translateY(-20px);
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);

            // æŒ‡å®šæ™‚é–“å¾Œã«å‰Šé™¤
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease-out';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, duration);
        }

        // Firebaseã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€
        function loadPasswords() {
            return database.ref('settings/passwords').once('value')
                .then((snapshot) => {
                    const passwords = snapshot.val();
                    if (passwords) {
                        appPasswords = passwords;
                        console.log('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                    } else {
                        // åˆå›èµ·å‹•æ™‚ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’Firebaseã«ä¿å­˜
                        database.ref('settings/passwords').set(appPasswords);
                        console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸ');
                    }
                })
                .catch((error) => {
                    console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
                });
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        async function login() {
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');
            
            // ã¾ãšãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€
            await loadPasswords();
            
            if (password === appPasswords.login) {
                isLoggedIn = true;
                localStorage.setItem('mahjong_logged_in', 'true');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                errorDiv.classList.add('hidden');
                
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                loadFromFirebase();
            } else {
                errorDiv.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™';
                errorDiv.classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                isLoggedIn = false;
                localStorage.removeItem('mahjong_logged_in');
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('passwordInput').value = '';
            }
        }

        // åˆæœŸåŒ–æ™‚ã®ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        window.addEventListener('DOMContentLoaded', async () => {
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€
            await loadPasswords();
            
            const loggedIn = localStorage.getItem('mahjong_logged_in');
            if (loggedIn === 'true') {
                isLoggedIn = true;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                loadFromFirebase();
            }
        });

        // Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadFromFirebase() {
            updateSyncStatus('loading');
            
            database.ref('mahjong').once('value')
                .then((snapshot) => {
                    const firebaseData = snapshot.val();
                    
                    // ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
                    if (firebaseData && firebaseData.data) {
                        data = firebaseData.data;
                        if(!data.dates || typeof data.dates !== 'object') {
                            data.dates = {};
                        }
                    } else {
                        data = { dates: {} };
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ç¢ºä¿ï¼ˆå…¨ã¦ã®æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã«players, gamesã‚’è¿½åŠ ï¼‰
                    Object.keys(data.dates).forEach(date => {
                        const d = data.dates[date];
                        if(!d.players || !Array.isArray(d.players)) {
                            d.players = [];
                        }
                        if(!d.games || !Array.isArray(d.games)) {
                            d.games = [];
                        }
                        if(!d.type || typeof d.type !== 'number') {
                            d.type = 4;
                        }
                    });
                    
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
                    if (firebaseData && Array.isArray(firebaseData.allPlayers)) {
                        allPlayers = firebaseData.allPlayers;
                    } else {
                        allPlayers = [];
                    }
                    
                    console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', {
                        dates: Object.keys(data.dates).length,
                        players: allPlayers.length
                    });
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚’é–‹å§‹
                    setupRealtimeListener();
                    
                    // ãƒªãƒ¼ã‚°æˆ¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                    loadLeagues();
                    
                    // åˆæœŸè¡¨ç¤º
                    const dateInput = document.getElementById('selectedDate');
                    if(dateInput) {
                        dateInput.valueAsDate = new Date();
                        dateChanged();
                    }
                    
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¹´ã‚’ä»Šå¹´ã«è¨­å®š
                    const currentYear = new Date().getFullYear().toString();
                    const availableYears = getAvailableYears();
                    if(availableYears.includes(currentYear)) {
                        selectedYear = currentYear;
                    } else if(availableYears.length > 0) {
                        selectedYear = availableYears[0]; // æœ€æ–°ã®å¹´
                    }
                    
                    render();
                    updateSyncStatus('synced');
                })
                .catch((error) => {
                    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    
                    // ã‚¨ãƒ©ãƒ¼ã§ã‚‚åˆæœŸåŒ–ã¯è¡Œã†
                    data = { dates: {} };
                    allPlayers = [];
                    
                    // ãƒªãƒ¼ã‚°æˆ¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚¨ãƒ©ãƒ¼ã§ã‚‚è©¦ã¿ã‚‹ï¼‰
                    loadLeagues().catch(e => console.error('ãƒªãƒ¼ã‚°æˆ¦èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e));
                    
                    // åˆæœŸè¡¨ç¤º
                    const dateInput = document.getElementById('selectedDate');
                    if(dateInput) {
                        dateInput.valueAsDate = new Date();
                        dateChanged();
                    }
                    render();
                    
                    notify('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã§èµ·å‹•ã—ã¾ã™ã€‚', 'error');
                    updateSyncStatus('error');
                });
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã®è¨­å®š
        function setupRealtimeListener() {
            database.ref('mahjong').on('value', (snapshot) => {
                try {
                    const firebaseData = snapshot.val();
                    if (firebaseData) {
                        // ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
                        if(firebaseData.data && firebaseData.data.dates) {
                            data = firebaseData.data;
                            
                            // ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ç¢ºä¿
                            Object.keys(data.dates).forEach(date => {
                                const d = data.dates[date];
                                if(!d.players || !Array.isArray(d.players)) {
                                    d.players = [];
                                }
                                if(!d.games || !Array.isArray(d.games)) {
                                    d.games = [];
                                }
                                if(!d.type || typeof d.type !== 'number') {
                                    d.type = 4;
                                }
                            });
                        }
                        if(Array.isArray(firebaseData.allPlayers)) {
                            allPlayers = firebaseData.allPlayers;
                        }
                        
                        // ç”»é¢æ›´æ–°ï¼ˆç¾åœ¨ã®ã‚¿ãƒ–ã«å¿œã˜ã¦ï¼‰
                        render();
                        if(currentTab === 'daily') renderDaily();
                        if(currentTab === 'players') renderPlayers();
                        
                        updateSyncStatus('synced');
                    }
                } catch(error) {
                    console.error('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                }
            });
        }

        // Firebaseã¸ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveToFirebase() {
            updateSyncStatus('saving');
            
            database.ref('mahjong').set({
                data: data,
                allPlayers: allPlayers,
                lastUpdated: new Date().toISOString()
            })
            .then(() => {
                updateSyncStatus('synced');
            })
            .catch((error) => {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                notify('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                updateSyncStatus('error');
            });
        }

        // åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateSyncStatus(status) {
            const statusDiv = document.getElementById('syncStatus');
            if (!statusDiv) return;
            
            switch(status) {
                case 'loading':
                    statusDiv.innerHTML = '<span class="pulse">â³</span> èª­è¾¼ä¸­...';
                    statusDiv.className = 'text-xs px-2 py-1 bg-white/20 rounded';
                    break;
                case 'saving':
                    statusDiv.innerHTML = '<span class="pulse">ğŸ’¾</span> ä¿å­˜ä¸­...';
                    statusDiv.className = 'text-xs px-2 py-1 bg-white/20 rounded';
                    break;
                case 'synced':
                    statusDiv.innerHTML = 'âœ… åŒæœŸå®Œäº†';
                    statusDiv.className = 'text-xs px-2 py-1 bg-green-500/80 rounded';
                    setTimeout(() => {
                        statusDiv.innerHTML = 'â˜ï¸ åŒæœŸæ¸ˆã¿';
                        statusDiv.className = 'text-xs px-2 py-1 bg-white/20 rounded';
                    }, 2000);
                    break;
                case 'error':
                    statusDiv.innerHTML = 'âŒ ã‚¨ãƒ©ãƒ¼';
                    statusDiv.className = 'text-xs px-2 py-1 bg-red-500/80 rounded';
                    break;
            }
        }

        // é€šçŸ¥è¡¨ç¤º
        function notify(msg, type = 'success') {
            const n = document.getElementById('notification');
            if (!n) return;
            
            n.textContent = msg;
            n.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            } text-white`;
            n.style.display = 'block';
            setTimeout(() => n.style.display = 'none', 3000);
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            currentTab = tab;
            ['input','daily','players','league'].forEach(t => {
                const contentEl = document.getElementById('content-'+t);
                const tabEl = document.getElementById('tab-'+t);
                if(contentEl) contentEl.style.display = t===tab ? 'block' : 'none';
                if(tabEl) {
                    tabEl.className = 'flex-1 px-3 py-3 text-sm font-medium whitespace-nowrap ' + 
                        (t===tab ? 'bg-gradient-to-r from-cyan-500 to-teal-500 text-white' : 'text-gray-600');
                }
            });
            if(tab==='daily') renderDaily();
            if(tab==='players') {
                updateYearSelects(); // å¹´é¸æŠã‚’æ›´æ–°
                renderPlayers();
            }
            if(tab==='league') {
                updateYearSelects(); // å¹´é¸æŠã‚’æ›´æ–°
                updateLeaguePlayerSelects();
                renderLeagues();
            }
        }

        // æ—¥ä»˜å¤‰æ›´
        let selectedDate = '';
        function dateChanged() {
            selectedDate = document.getElementById('selectedDate').value;
            render();
        }

        // éº»é›€ã®ç¨®é¡å¤‰æ›´
        function gameTypeChanged() {
            const d = getData();
            d.type = parseInt(document.getElementById('gameType').value);
            if(d.players && Array.isArray(d.players) && d.players.length > d.type) {
                d.players = d.players.slice(0, d.type);
            }
            saveToFirebase();
            render();
        }

        // ãƒ‡ãƒ¼ã‚¿å–å¾—
        function getData() {
            if(!data.dates[selectedDate]) {
                data.dates[selectedDate] = { type:4, players:[], games:[] };
            }
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
            const d = data.dates[selectedDate];
            if(!d.players) d.players = [];
            if(!d.games) d.games = [];
            if(!d.type) d.type = 4;
            return d;
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¤‰æ›´
        function playerChanged(index, value) {
            if(value==='__new__') {
                const name = prompt('æ–°ã—ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å');
                if(name && name.trim()) {
                    if(!allPlayers.includes(name.trim())) {
                        allPlayers.push(name.trim());
                    }
                    getData().players[index] = name.trim();
                    saveToFirebase();
                    render();
                }
            } else {
                getData().players[index] = value;
                saveToFirebase();
                render();
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ 
        function addPlayer() {
            const input = document.getElementById('newPlayer');
            if(!input) return;
            
            const name = input.value.trim();
            if(!name) {
                alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if(allPlayers.includes(name)) {
                alert('ã“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
                input.value = '';
                return;
            }
            
            allPlayers.push(name);
            input.value = '';
            saveToFirebase();
            render();
            notify('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€Œ' + name + 'ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }

        // åŠè˜è¿½åŠ 
        function addGame() {
            const d = getData();
            if(d.players.length < d.type) {
                alert('å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            const scores = d.players.map((p,i) => parseFloat(document.getElementById('score'+i).value) || 0);
            
            // ã‚¹ã‚³ã‚¢åˆè¨ˆãƒã‚§ãƒƒã‚¯
            const total = scores.reduce((sum, s) => sum + s, 0);
            // å°æ•°ç‚¹ã®èª¤å·®ã‚’è€ƒæ…®ã—ã¦ã€0.01æœªæº€ãªã‚‰0ã¨ã—ã¦æ‰±ã†
            if(Math.abs(total) >= 0.01) {
                const confirmResult = window.confirm(`âš ï¸ ã‚¹ã‚³ã‚¢ã®åˆè¨ˆãŒ${total>0?'+':''}${total.toFixed(1)}ã§ã™ï¼ˆ0ã«ãªã£ã¦ã„ã¾ã›ã‚“ï¼‰\n\nã“ã®ã¾ã¾ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\nã€å…¥åŠ›ã—ãŸã‚¹ã‚³ã‚¢ã€‘\n${d.players.map((p,i) => `${p}: ${scores[i]>0?'+':''}${scores[i]}`).join('\n')}\nåˆè¨ˆ: ${total>0?'+':''}${total.toFixed(1)}`);
                if(!confirmResult) return;
            }
            
            d.games.push(scores);
            saveToFirebase();
            d.players.forEach((p,i) => document.getElementById('score'+i).value = '');
            updateScoreTotal(); // åˆè¨ˆè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            render();
            notify('åŠè˜'+d.games.length+'ã‚’è¿½åŠ ');
        }

        // åŠè˜å‰Šé™¤
        function removeGame(date, idx) {
            if(confirm('ã“ã®åŠè˜ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                data.dates[date].games.splice(idx, 1);
                saveToFirebase();
                render();
                renderDaily();
                notify('å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // ã‚¹ã‚³ã‚¢æ›´æ–°
        function updateScore(date, gIdx, pIdx, val) {
            data.dates[date].games[gIdx][pIdx] = parseFloat(val) || 0;
            saveToFirebase();
        }

        // ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        function clearToday() {
            if(data.dates[selectedDate]) {
                delete data.dates[selectedDate];
                saveToFirebase();
                render();
                notify('ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        function clearAllData() {
            // ã¾ãšå‰Šé™¤ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¦æ±‚
            const deletePassword = prompt('âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤\n\nå…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼\n\nå‰Šé™¤ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            
            if (!deletePassword) {
                notify('å‰Šé™¤ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
                return;
            }
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
            if (deletePassword !== appPasswords.delete) {
                alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚\n\nå‰Šé™¤ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç®¡ç†è€…ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ã„å ´åˆã®ã¿ç¶šè¡Œ
            if(confirm('âš ï¸ æœ€çµ‚ç¢ºèª\n\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç¢ºèªã•ã‚Œã¾ã—ãŸã€‚\n\nå…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€åŠè˜è¨˜éŒ²ãªã©ï¼‰ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\n\næœ¬å½“ã«å‰Šé™¤ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                // ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
                data = { dates: {} };
                allPlayers = [];
                
                // Firebaseã‹ã‚‰å‰Šé™¤
                database.ref('mahjong').set({
                    data: { dates: {} },
                    allPlayers: [],
                    lastUpdated: new Date().toISOString(),
                    deletedAt: new Date().toISOString()
                })
                .then(() => {
                    render();
                    if(currentTab === 'daily') renderDaily();
                    if(currentTab === 'players') renderPlayers();
                    notify('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    console.log('å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†');
                })
                .catch((error) => {
                    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    notify('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                });
            } else {
                notify('å‰Šé™¤ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
            }
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function exportData() {
            const exp = { data, allPlayers, exportDate: new Date().toISOString(), version: '1.0' };
            const jsonStr = JSON.stringify(exp, null, 2);
            const filename = 'mahjong_'+new Date().toISOString().split('T')[0]+'.json';
            
            // iOSã§å…±æœ‰ã‚·ãƒ¼ãƒˆã‚’ä½¿ã†ï¼ˆWeb Share APIï¼‰
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if(isIOS && navigator.share) {
                const file = new File([jsonStr], filename, { type: 'application/json' });
                navigator.share({
                    files: [file],
                    title: 'éº»é›€æˆç¸¾ãƒ‡ãƒ¼ã‚¿',
                    text: 'éº»é›€æˆç¸¾ç®¡ç†ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿'
                }).then(() => {
                    notify('å…±æœ‰å®Œäº†');
                }).catch((err) => {
                    if(err.name !== 'AbortError') {
                        downloadFile(jsonStr, filename);
                    }
                });
            } else {
                downloadFile(jsonStr, filename);
            }
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if(isIOS) {
                setTimeout(() => {
                    alert('ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nã€ä¿å­˜å ´æ‰€ã€‘\n1. Safariã®ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ï¼ˆâ†“ï¼‰ã‚’ã‚¿ãƒƒãƒ—\n2. ã¾ãŸã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¢ãƒ—ãƒªã®ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèª\n\nä¿å­˜å ´æ‰€ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒªã§ç§»å‹•ã§ãã¾ã™ã€‚');
                }, 500);
            } else {
                notify('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
            }
        }

        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function importData(e) {
            const file = e.target.files[0];
            if(!file) {
                console.log('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹:', file.name);
            const reader = new FileReader();
            
            reader.onerror = (error) => {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            };
            
            reader.onload = (ev) => {
                try {
                    console.log('ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:', ev.target.result.substring(0, 200));
                    const imp = JSON.parse(ev.target.result);
                    console.log('ãƒ‘ãƒ¼ã‚¹æˆåŠŸ:', imp);
                    console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®allPlayers:', imp.allPlayers);
                    console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®dates:', Object.keys(imp.data.dates));
                    
                    // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®æ¤œè¨¼
                    if(!imp.data || typeof imp.data !== 'object') {
                        throw new Error('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: data ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    if(!imp.data.dates || typeof imp.data.dates !== 'object') {
                        throw new Error('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: data.dates ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    if(!imp.allPlayers || !Array.isArray(imp.allPlayers)) {
                        throw new Error('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: allPlayers ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    
                    // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒæœªåˆæœŸåŒ–ã®å ´åˆã¯åˆæœŸåŒ–
                    if(!data || typeof data !== 'object') {
                        data = { dates: {} };
                    }
                    if(!data.dates || typeof data.dates !== 'object') {
                        data.dates = {};
                    }
                    if(!allPlayers || !Array.isArray(allPlayers)) {
                        allPlayers = [];
                    }
                    
                    if(confirm('ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\n\nOK: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ \nã‚­ãƒ£ãƒ³ã‚»ãƒ«: ã™ã¹ã¦ä¸Šæ›¸ã')) {
                        // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
                        let addedCount = 0;
                        Object.entries(imp.data.dates).forEach(([d,v]) => {
                            if(data.dates[d]) {
                                if(confirm(d+'ã®ãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) {
                                    data.dates[d] = v;
                                    addedCount++;
                                }
                            } else {
                                data.dates[d] = v;
                                addedCount++;
                            }
                        });
                        
                        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿½åŠ ï¼ˆallPlayersã‹ã‚‰ï¼‰
                        let newPlayers = 0;
                        console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‰ã®allPlayers:', allPlayers);
                        console.log('è¿½åŠ äºˆå®šã®allPlayers:', imp.allPlayers);
                        
                        imp.allPlayers.forEach(p => { 
                            console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‡¦ç†ä¸­:', p, 'æ—¢å­˜:', allPlayers.includes(p));
                            if(!allPlayers.includes(p)) {
                                allPlayers.push(p);
                                newPlayers++;
                                console.log('âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ :', p);
                            } else {
                                console.log('â­ï¸ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ—¢å­˜:', p);
                            }
                        });
                        
                        // ãƒ‡ãƒ¼ã‚¿å†…ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚è¿½åŠ ï¼ˆå¿µã®ãŸã‚ï¼‰
                        console.log('ãƒ‡ãƒ¼ã‚¿å†…ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯...');
                        Object.entries(imp.data.dates).forEach(([date, dateData]) => {
                            console.log('æ—¥ä»˜:', date, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼:', dateData.players);
                            if(dateData && dateData.players && Array.isArray(dateData.players)) {
                                dateData.players.forEach(p => {
                                    if(p && !allPlayers.includes(p)) {
                                        allPlayers.push(p);
                                        newPlayers++;
                                        console.log('âœ… ãƒ‡ãƒ¼ã‚¿å†…ã‹ã‚‰è¿½åŠ :', p);
                                    }
                                });
                            }
                        });
                        
                        console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¾Œã®allPlayers:', allPlayers);
                        console.log(`è¿½åŠ å®Œäº†: ${addedCount}æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿, ${newPlayers}äººã®æ–°è¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼`);
                        notify(`è¿½åŠ å®Œäº†: ${addedCount}æ—¥åˆ†, ${newPlayers}äººè¿½åŠ `);
                    } else {
                        // ä¸Šæ›¸ããƒ¢ãƒ¼ãƒ‰
                        console.log('ä¸Šæ›¸ããƒ¢ãƒ¼ãƒ‰é–‹å§‹');
                        console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‰ã®allPlayers:', allPlayers);
                        
                        data = JSON.parse(JSON.stringify(imp.data)); // ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
                        allPlayers = [...imp.allPlayers]; // ã‚³ãƒ”ãƒ¼
                        
                        console.log('allPlayersã‚³ãƒ”ãƒ¼å¾Œ:', allPlayers);
                        
                        // ãƒ‡ãƒ¼ã‚¿å†…ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚‚ç¢ºå®Ÿã«è¿½åŠ 
                        let dataPlayers = 0;
                        Object.entries(data.dates).forEach(([date, dateData]) => {
                            console.log('æ—¥ä»˜:', date, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼:', dateData.players);
                            if(dateData && dateData.players && Array.isArray(dateData.players)) {
                                dateData.players.forEach(p => {
                                    if(p && !allPlayers.includes(p)) {
                                        allPlayers.push(p);
                                        dataPlayers++;
                                        console.log('âœ… ãƒ‡ãƒ¼ã‚¿å†…ã‹ã‚‰è¿½åŠ ï¼ˆä¸Šæ›¸ããƒ¢ãƒ¼ãƒ‰ï¼‰:', p);
                                    }
                                });
                            }
                        });
                        
                        console.log('ä¸Šæ›¸ãå®Œäº† - æœ€çµ‚allPlayers:', allPlayers);
                        console.log('ãƒ‡ãƒ¼ã‚¿å†…ã‹ã‚‰è¿½åŠ ã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°:', dataPlayers);
                        notify('ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã—ãŸ');
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ç¢ºèª
                    if(!data.dates) data.dates = {};
                    
                    // å…¨ã¦ã®æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ç¢ºä¿
                    Object.keys(data.dates).forEach(date => {
                        const d = data.dates[date];
                        if(!d.players || !Array.isArray(d.players)) {
                            d.players = [];
                        }
                        if(!d.games || !Array.isArray(d.games)) {
                            d.games = [];
                        }
                        if(!d.type || typeof d.type !== 'number') {
                            d.type = 4;
                        }
                    });
                    
                    // æœ€çµ‚çš„ãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ã‚’ç¢ºèª
                    const finalPlayerCount = allPlayers.length;
                    const dateCount = Object.keys(data.dates).length;
                    const gameCount = Object.values(data.dates).reduce((sum, d) => {
                        return sum + (d.games ? d.games.length : 0);
                    }, 0);
                    
                    console.log('========================================');
                    console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ã‚µãƒãƒªãƒ¼:');
                    console.log('- æ—¥ä»˜æ•°:', dateCount);
                    console.log('- ç·åŠè˜æ•°:', gameCount);
                    console.log('- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°:', finalPlayerCount);
                    console.log('- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§:', allPlayers);
                    console.log('- ãƒ‡ãƒ¼ã‚¿:', data);
                    console.log('========================================');
                    
                    // Firebaseã«ä¿å­˜
                    console.log('Firebaseã«ä¿å­˜é–‹å§‹...');
                    saveToFirebase();
                    
                    // ç”»é¢ã‚’æ›´æ–°
                    console.log('ç”»é¢æ›´æ–°é–‹å§‹...');
                    render();
                    if(currentTab === 'daily') renderDaily();
                    if(currentTab === 'players') renderPlayers();
                    console.log('ç”»é¢æ›´æ–°å®Œäº†');
                    
                    // è©³ç´°ãªå®Œäº†é€šçŸ¥
                    setTimeout(() => {
                        alert(`âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†\n\nğŸ“Š ãƒ‡ãƒ¼ã‚¿æ¦‚è¦:\nãƒ»æ—¥ä»˜: ${dateCount}æ—¥åˆ†\nãƒ»åŠè˜: ${gameCount}å›\nãƒ»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${finalPlayerCount}äºº\n\nãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§:\n${allPlayers.join(', ')}`);
                    }, 500);
                    
                } catch(err) {
                    console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', err);
                    console.error('ã‚¹ã‚¿ãƒƒã‚¯:', err.stack);
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ' + err.message + '\n\nã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
            };
            
            reader.readAsText(file);
            e.target.value = '';
        }

        // ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åˆ©ç”¨å¯èƒ½ãªå¹´ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
        function getAvailableYears() {
            const years = new Set();
            if(data && data.dates) {
                Object.keys(data.dates).forEach(dateStr => {
                    const year = new Date(dateStr).getFullYear();
                    if(!isNaN(year)) {
                        years.add(year);
                    }
                });
            }
            return Array.from(years).sort((a, b) => b - a); // é™é †
        }

        // å¹´é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
        function updateYearSelects() {
            const years = getAvailableYears();
            const currentYear = new Date().getFullYear();
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±è¨ˆã®å¹´é¸æŠ
            const playerYearSelect = document.getElementById('playerYearSelect');
            if(playerYearSelect) {
                let html = '<option value="all">é€šç®—</option>';
                years.forEach(year => {
                    html += `<option value="${year}">${year}å¹´</option>`;
                });
                playerYearSelect.innerHTML = html;
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä»Šå¹´ï¼ˆãªã‘ã‚Œã°é€šç®—ï¼‰
                if(years.includes(currentYear)) {
                    playerYearSelect.value = currentYear.toString();
                }
            }
            
            // ãƒªãƒ¼ã‚°æˆ¦ã®å¹´é¸æŠ
            const leagueYearSelect = document.getElementById('leagueYearSelect');
            if(leagueYearSelect) {
                let html = '<option value="all">é€šç®—</option>';
                years.forEach(year => {
                    html += `<option value="${year}">${year}å¹´</option>`;
                });
                leagueYearSelect.innerHTML = html;
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä»Šå¹´ï¼ˆãªã‘ã‚Œã°é€šç®—ï¼‰
                if(years.includes(currentYear)) {
                    leagueYearSelect.value = currentYear.toString();
                }
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¹´ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
        function getAvailableYears() {
            const years = new Set();
            if(data && data.dates) {
                Object.keys(data.dates).forEach(dateStr => {
                    const year = dateStr.split('-')[0];
                    years.add(year);
                });
            }
            return Array.from(years).sort().reverse(); // æ–°ã—ã„å¹´ãŒä¸Š
        }

        // å¹´é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
        function updateYearSelects() {
            const years = getAvailableYears();
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¿ãƒ–ã®å¹´é¸æŠ
            const playerYearSelect = document.getElementById('playerYearSelect');
            if(playerYearSelect) {
                let html = '<option value="all">é€šç®—æˆç¸¾</option>';
                years.forEach(year => {
                    html += `<option value="${year}" ${year === selectedYear ? 'selected' : ''}>${year}å¹´</option>`;
                });
                playerYearSelect.innerHTML = html;
                playerYearSelect.value = selectedYear;
            }
            
            // ãƒªãƒ¼ã‚°æˆ¦ã‚¿ãƒ–ã®å¹´é¸æŠ
            const leagueYearSelect = document.getElementById('leagueYearSelect');
            if(leagueYearSelect) {
                let html = '<option value="all">é€šç®—æˆç¸¾</option>';
                years.forEach(year => {
                    html += `<option value="${year}" ${year === selectedYear ? 'selected' : ''}>${year}å¹´</option>`;
                });
                leagueYearSelect.innerHTML = html;
                leagueYearSelect.value = selectedYear;
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¿ãƒ–ã§å¹´ã‚’å¤‰æ›´
        function changePlayerYear() {
            const select = document.getElementById('playerYearSelect');
            if(select) {
                selectedYear = select.value;
                renderPlayers();
            }
        }

        // ãƒªãƒ¼ã‚°æˆ¦ã‚¿ãƒ–ã§å¹´ã‚’å¤‰æ›´
        function changeLeagueYear() {
            const select = document.getElementById('leagueYearSelect');
            if(select) {
                selectedYear = select.value;
                // ç¾åœ¨é¸æŠä¸­ã®ãƒªãƒ¼ã‚°æˆ¦ã‚’å†è¨ˆç®—
                if(selectedLeagueId) {
                    calculateLeagueById(selectedLeagueId);
                }
            }
        }

        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function render() {
            console.log('render() å‘¼ã³å‡ºã— - allPlayers:', allPlayers);
            const d = getData();
            const gameTypeElement = document.getElementById('gameType');
            if(gameTypeElement) {
                gameTypeElement.value = d.type;
            }
            updateYearSelects(); // å¹´é¸æŠã‚’æ›´æ–°
            renderStats();
            renderPlayerSelectors();
            renderScoreInputs();
            // renderGamesList(); // å…¥åŠ›ã‚¿ãƒ–ã«ã¯è¡¨ç¤ºã—ãªã„ï¼ˆæ—¥åˆ¥ã‚¿ãƒ–ã®ã¿ï¼‰
            renderPlayerList();
            updateLeaguePlayerSelects(); // ãƒªãƒ¼ã‚°æˆ¦ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠè‚¢ã‚’æ›´æ–°
            console.log('render() å®Œäº†');
        }

        // çµ±è¨ˆè¡¨ç¤º
        function renderStats() {
            const statsElement = document.getElementById('stats');
            if(!statsElement) return;
            
            let games=0, players=new Set(), score=0;
            
            // ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
            if(!data || !data.dates || typeof data.dates !== 'object') {
                console.log('ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ - åˆæœŸåŒ–ã—ã¾ã™');
                data = { dates: {} };
                statsElement.innerHTML = `
                    <div class="bg-gradient-to-br from-cyan-500 to-teal-600 rounded-lg p-3 text-white">
                        <div class="text-2xl font-bold">0</div>
                        <div class="text-xs">ç·åŠè˜æ•°</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-cyan-600 rounded-lg p-3 text-white">
                        <div class="text-2xl font-bold">0</div>
                        <div class="text-xs">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°</div>
                    </div>
                `;
                return;
            }
            
            try {
                const dateValues = Object.values(data.dates);
                console.log('å‡¦ç†ã™ã‚‹æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿æ•°:', dateValues.length);
                
                dateValues.forEach(d => {
                    if(!d || typeof d !== 'object') {
                        console.warn('ç„¡åŠ¹ãªæ—¥ä»˜ãƒ‡ãƒ¼ã‚¿:', d);
                        return;
                    }
                    if(!d.games || !Array.isArray(d.games)) {
                        console.warn('gamesé…åˆ—ãŒå­˜åœ¨ã—ãªã„ã‹ç„¡åŠ¹:', d);
                        return;
                    }
                    
                    d.games.forEach(g => {
                        if(!g || !Array.isArray(g)) {
                            console.warn('ç„¡åŠ¹ãªã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿:', g);
                            return;
                        }
                        games++;
                        g.forEach((s,i) => {
                            if(d.players && Array.isArray(d.players) && d.players[i]) {
                                players.add(d.players[i]);
                            }
                            if(typeof s === 'number') {
                                score += s;
                            }
                        });
                    });
                });
            } catch(error) {
                console.error('çµ±è¨ˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            statsElement.innerHTML = `
                <div class="bg-gradient-to-br from-cyan-500 to-teal-600 rounded-lg p-3 text-white">
                    <div class="text-2xl font-bold">${games}</div>
                    <div class="text-xs">ç·åŠè˜æ•°</div>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-cyan-600 rounded-lg p-3 text-white">
                    <div class="text-2xl font-bold">${players.size}</div>
                    <div class="text-xs">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°</div>
                </div>
            `;
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§è¡¨ç¤º
        function renderPlayerList() {
            const playerListElement = document.getElementById('playerList');
            if(!playerListElement) {
                console.warn('playerListElement ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            console.log('renderPlayerList å‘¼ã³å‡ºã— - allPlayers:', allPlayers);
            
            if(!allPlayers || allPlayers.length === 0) {
                playerListElement.innerHTML = '<div class="text-center py-2 text-gray-400">ç™»éŒ²ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãªã—</div>';
                console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãªã—è¡¨ç¤º');
                return;
            }
            
            let html = '<div class="font-semibold mb-1">ç™»éŒ²æ¸ˆã¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (' + allPlayers.length + 'äºº)</div>';
            html += '<div class="flex flex-wrap gap-1">';
            allPlayers.forEach((p, idx) => {
                html += `<span class="inline-block bg-cyan-100 text-cyan-700 px-2 py-1 rounded text-xs">
                    ${p}
                    <button onclick="removePlayer(${idx})" class="ml-1 text-red-500 hover:text-red-700 font-bold">Ã—</button>
                </span>`;
            });
            html += '</div>';
            playerListElement.innerHTML = html;
            console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§è¡¨ç¤ºå®Œäº†:', allPlayers.length + 'äºº');
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤
        function removePlayer(index) {
            const playerName = allPlayers[index];
            if(confirm(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€Œ${playerName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\næ³¨æ„: éå»ã®è¨˜éŒ²ã‹ã‚‰ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚`)) {
                allPlayers.splice(index, 1);
                saveToFirebase();
                render();
                notify(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€Œ${playerName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠè¡¨ç¤º
        function renderPlayerSelectors() {
            const playerSelectorsElement = document.getElementById('playerSelectors');
            if(!playerSelectorsElement) return;
            
            const d = getData();
            if(!d.players || !Array.isArray(d.players)) {
                d.players = [];
            }
            
            let html = '';
            for(let i=0; i<d.type; i++) {
                const current = d.players[i] || '';
                html += `<select onchange="playerChanged(${i}, this.value)" class="w-full px-3 py-2 border rounded-lg mb-2">
                    <option value="">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}ã‚’é¸æŠ...</option>
                    ${allPlayers.map(p => `<option value="${p}" ${p===current?'selected':''}>${p}</option>`).join('')}
                    <option value="__new__">+ æ–°ã—ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</option>
                </select>`;
            }
            playerSelectorsElement.innerHTML = html;
        }

        // ã‚¹ã‚³ã‚¢å…¥åŠ›è¡¨ç¤º
        function renderScoreInputs() {
            const d = getData();
            const scoreInputsElement = document.getElementById('scoreInputs');
            if(!scoreInputsElement) return;
            
            if(!d.players || d.players.length < d.type) {
                scoreInputsElement.innerHTML = '<div class="text-gray-400 text-sm text-center py-2">å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
                return;
            }
            
            const colors = ['bg-yellow-50 border-yellow-300', 'bg-blue-50 border-blue-300', 'bg-green-50 border-green-300', 'bg-purple-50 border-purple-300'];
            let html = '';
            d.players.forEach((p,i) => {
                html += `<div class="flex items-center gap-2 mb-2 p-3 rounded-lg border-2 ${colors[i % colors.length]}">
                    <div class="flex-1">
                        <div class="text-xs text-gray-600 mb-1">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}</div>
                        <div class="font-bold text-sm truncate">${p}</div>
                    </div>
                    <div class="flex-1">
                        <div class="text-xs text-gray-600 mb-1">ã‚¹ã‚³ã‚¢</div>
                        <input type="number" id="score${i}" placeholder="Â±0" 
                               step="0.1"
                               class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-center font-bold"
                               oninput="updateScoreTotal()">
                    </div>
                </div>`;
            });
            scoreInputsElement.innerHTML = html;
        }

        // ã‚¹ã‚³ã‚¢åˆè¨ˆè¡¨ç¤ºã®æ›´æ–°
        function updateScoreTotal() {
            const d = getData();
            const totalElement = document.getElementById('scoreTotal');
            const totalValueElement = document.getElementById('scoreTotalValue');
            const totalRemainingElement = document.getElementById('scoreTotalRemaining');
            
            if (!totalElement || !totalValueElement || !totalRemainingElement) return;
            
            // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ã‚³ã‚¢ã‚’åˆè¨ˆ
            let sum = 0;
            let filledCount = 0;
            
            for(let i = 0; i < d.type; i++) {
                const input = document.getElementById('score' + i);
                if(input && input.value !== '') {
                    sum += parseFloat(input.value) || 0;
                    filledCount++;
                }
            }
            
            // å°æ•°ç‚¹1æ¡ã«ä¸¸ã‚ã‚‹
            sum = Math.round(sum * 10) / 10;
            
            // ä½•ã‹å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿è¡¨ç¤º
            if(filledCount > 0) {
                totalElement.style.display = 'block';
                
                // åˆè¨ˆå€¤ã®è‰²ã‚’è¨­å®š
                if(sum === 0) {
                    totalElement.className = 'mt-2 p-3 rounded-lg border-2 border-green-400 bg-green-50 text-center font-bold';
                    totalValueElement.className = 'text-2xl text-green-600';
                } else if(sum > 0) {
                    totalElement.className = 'mt-2 p-3 rounded-lg border-2 border-red-400 bg-red-50 text-center font-bold';
                    totalValueElement.className = 'text-2xl text-red-600';
                } else {
                    totalElement.className = 'mt-2 p-3 rounded-lg border-2 border-blue-400 bg-blue-50 text-center font-bold';
                    totalValueElement.className = 'text-2xl text-blue-600';
                }
                
                totalValueElement.textContent = (sum > 0 ? '+' : '') + sum;
                
                // æ®‹ã‚Šã®å€¤ã‚’è¡¨ç¤º
                if(filledCount < d.type) {
                    const remaining = -sum;
                    totalRemainingElement.textContent = `æ®‹ã‚Š${d.type - filledCount}äººã§: ${remaining > 0 ? '+' : ''}${remaining.toFixed(1)}`;
                    totalRemainingElement.style.display = 'block';
                } else {
                    totalRemainingElement.style.display = 'none';
                }
            } else {
                totalElement.style.display = 'none';
            }
        }

        // ã‚²ãƒ¼ãƒ ãƒªã‚¹ãƒˆè¡¨ç¤º
        function renderGamesList() {
            const gamesListElement = document.getElementById('gamesList');
            if(!gamesListElement) return;
            
            try {
                const d = getData();
                if(!d || !d.games || !Array.isArray(d.games) || d.games.length === 0) {
                    gamesListElement.innerHTML = '';
                    return;
                }
                
                let html = '<div class="mt-4"><h3 class="font-bold mb-2">ä»Šæ—¥ã®åŠè˜</h3>';
                d.games.forEach((g, idx) => {
                    if(!g || !Array.isArray(g)) return;
                    const totals = g.map((s,i) => s);
                    html += `<div class="bg-gray-50 rounded-lg p-2 mb-2 text-sm">
                        <div class="font-bold mb-1">åŠè˜${idx+1}</div>
                        ${(d.players || []).map((p,i) => `<div class="flex justify-between">
                            <span>${p || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼'+(i+1)}</span>
                            <span class="${totals[i]>0?'text-green-600':totals[i]<0?'text-red-600':'text-gray-600'} font-bold">
                                ${totals[i]>0?'+':''}${totals[i] || 0}
                            </span>
                        </div>`).join('')}
                    </div>`;
                });
                html += '</div>';
                gamesListElement.innerHTML = html;
            } catch(error) {
                console.error('ã‚²ãƒ¼ãƒ ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                gamesListElement.innerHTML = '';
            }
        }

        // æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function renderDaily() {
            const dailyListElement = document.getElementById('dailyList');
            if(!dailyListElement) return;
            
            try {
                // ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
                if(!data || !data.dates || typeof data.dates !== 'object') {
                    dailyListElement.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
                    return;
                }
                
                const dates = Object.keys(data.dates).sort().reverse();
                if(dates.length===0) {
                    dailyListElement.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
                    return;
                }
                
                let html = '';
                dates.forEach(date => {
                    const d = data.dates[date];
                    if(!d || typeof d !== 'object') return;
                    if(!d.games || !Array.isArray(d.games) || d.games.length === 0) return;
                    if(!d.players || !Array.isArray(d.players)) return;
                    
                    const totals = d.players.map((p,i) => {
                        return d.games.reduce((sum,g) => {
                            if(g && Array.isArray(g) && typeof g[i] === 'number') {
                                return sum + g[i];
                            }
                            return sum;
                        }, 0);
                    });
                html += `<div class="bg-cyan-50 rounded-lg p-3 border border-cyan-200 mb-3">
                    <div class="mb-2">
                        <div class="text-sm font-bold">${new Date(date).toLocaleDateString('ja-JP',{month:'long',day:'numeric'})}</div>
                        <div class="inline-block bg-cyan-600 text-white px-2 py-1 rounded-full text-xs mt-1">${d.type}äººéº»é›€ | ${d.games.length}åŠè˜</div>
                    </div>
                    <div class="table-scroll">
                        <table class="w-full text-xs">
                            <thead><tr class="border-b-2 border-cyan-300">
                                <th class="text-left py-2 px-1 font-bold sticky left-0 bg-cyan-50">åŠè˜</th>
                                ${d.players.map(p => `<th class="text-center py-2 px-1 font-bold">${p}</th>`).join('')}
                                <th class="text-center py-2 px-1 font-bold">æ“ä½œ</th>
                            </tr></thead>
                            <tbody>
                                ${d.games.map((g,gi) => `<tr class="border-b border-gray-200">
                                    <td class="py-2 px-1 sticky left-0 bg-cyan-50">
                                        <span class="font-medium">${gi+1}</span>
                                    </td>
                                    ${g.map((s,pi) => `<td class="text-center py-2 px-1">
                                        <input type="number" step="0.1" value="${Number(s).toFixed(1)}" onchange="updateScore('${date}',${gi},${pi},this.value)" 
                                            class="w-16 text-center px-1 py-1 border rounded ${s>0?'text-green-600':s<0?'text-red-600':'text-gray-600'}">
                                    </td>`).join('')}
                                    <td class="text-center py-2 px-1">
                                        <button onclick="removeGame('${date}',${gi})" class="bg-red-500 text-white rounded px-2 py-1 text-xs font-bold active:bg-red-600" style="min-width:44px;min-height:32px;">å‰Šé™¤</button>
                                    </td>
                                </tr>`).join('')}
                                <tr class="border-t-2 border-cyan-300 bg-cyan-100 font-bold">
                                    <td class="py-2 px-1 sticky left-0 bg-cyan-100">åˆè¨ˆ</td>
                                    ${totals.map(t => `<td class="text-center py-2 px-1 ${t>0?'text-green-600':t<0?'text-red-600':'text-gray-600'}">${t>0?'+':''}${Number(t).toFixed(1)}</td>`).join('')}
                                    <td class="py-2 px-1"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
                });
                dailyListElement.innerHTML = html;
            } catch(error) {
                console.error('æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                dailyListElement.innerHTML = '<div class="text-center py-8 text-red-400 text-sm">è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±è¨ˆè¡¨ç¤º
        function renderPlayers() {
            const playerStatsElement = document.getElementById('playerStats');
            if(!playerStatsElement) return;
            
            try {
                const stats = {};
                
                // ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
                if(!data || !data.dates || typeof data.dates !== 'object') {
                    playerStatsElement.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
                    return;
                }
                
                // é¸æŠã•ã‚ŒãŸå¹´ã‚’å–å¾—
                const yearSelect = document.getElementById('playerYearSelect');
                const selectedYear = yearSelect ? yearSelect.value : 'all';
                
                // å¹´ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                Object.entries(data.dates).forEach(([dateStr, d]) => {
                    if(!d || typeof d !== 'object') return;
                    if(!d.games || !Array.isArray(d.games)) return;
                    if(!d.players || !Array.isArray(d.players)) return;
                    
                    // å¹´ãƒ•ã‚£ãƒ«ã‚¿
                    if(selectedYear !== 'all') {
                        const year = new Date(dateStr).getFullYear();
                        if(year.toString() !== selectedYear) return;
                    }
                    
                    d.games.forEach(g => {
                        if(!g || !Array.isArray(g)) return;
                    g.forEach((s,i) => {
                        const name = d.players[i];
                        if(!name) return;
                        if(typeof s !== 'number') return;
                        
                        if(!stats[name]) stats[name] = {name, totalGames:0, totalScore:0, ranks:{1:0,2:0,3:0,4:0}};
                        stats[name].totalGames++;
                        stats[name].totalScore += s;
                        const sorted = [...g].sort((a,b)=>b-a);
                        const rank = sorted.indexOf(s) + 1;
                        stats[name].ranks[rank]++;
                    });
                    });
                });
                
                const list = Object.values(stats).sort((a,b) => b.totalScore - a.totalScore);
                if(!list.length) {
                    playerStatsElement.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
                    return;
                }
                
                let html = '';
                list.forEach((p,idx) => {
                    const avg = (p.totalScore / p.totalGames).toFixed(1);
                    const medal = ['ğŸ‘‘','ğŸ¥ˆ','ğŸ¥‰'][idx] || '';
                    let ranks = '';
                    for(let r=1; r<=4; r++) {
                        const count = p.ranks[r] || 0;
                        const pct = ((count/p.totalGames)*100).toFixed(1);
                        const colors = ['bg-yellow-500 text-yellow-700 bg-yellow-50','bg-gray-400 text-gray-700 bg-gray-50','bg-orange-500 text-orange-700 bg-orange-50','bg-red-500 text-red-700 bg-red-50'][r-1].split(' ');
                        ranks += `<div class="flex items-center gap-2 mb-2">
                            <span class="text-xs font-bold w-8 ${colors[1]}">${r}ä½</span>
                            <div class="flex-1 ${colors[2]} rounded-full h-6 overflow-hidden">
                                <div class="${colors[0]} h-full flex items-center justify-end px-2 text-white text-xs font-bold" style="width:${pct}%">
                                    ${pct>15?pct+'%':''}
                                </div>
                            </div>
                            <span class="text-xs font-bold ${colors[1]} w-12">${pct}%</span>
                            <span class="text-xs text-gray-500 w-10 text-right">${count}å›</span>
                        </div>`;
                    }
                    html += `<div class="bg-cyan-50 rounded-lg p-4 border border-cyan-200 mb-3">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <div class="w-10 h-10 bg-gradient-to-r from-cyan-500 to-teal-500 rounded-full flex items-center justify-center text-white font-bold">${p.name[0].toUpperCase()}</div>
                                <div>
                                    <h3 class="text-base font-bold">${medal} ${p.name}</h3>
                                    <p class="text-xs text-gray-600">${p.totalGames}åŠè˜</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-bold text-cyan-600">${p.totalScore>0?'+':''}${Number(p.totalScore).toFixed(1)}</div>
                                <div class="text-xs text-gray-600">å¹³å‡: ${avg>0?'+':''}${avg}</div>
                            </div>
                        </div>
                        <div class="border-t border-cyan-200 pt-3">
                            <h4 class="text-xs font-bold mb-2">é †ä½å–å¾—ç‡</h4>
                            ${ranks}
                        </div>
                    </div>`;
                });
                playerStatsElement.innerHTML = html;
            } catch(error) {
                console.error('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±è¨ˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                playerStatsElement.innerHTML = '<div class="text-center py-8 text-red-400 text-sm">è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // ãƒªãƒ¼ã‚°æˆ¦ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠè‚¢ã‚’æ›´æ–°
        function renderLeagueSelectors() {
            for(let i = 1; i <= 4; i++) {
                const select = document.getElementById('leaguePlayer' + i);
                if(!select) continue;
                
                let html = `<option value="">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}ã‚’é¸æŠ</option>`;
                allPlayers.forEach(p => {
                    html += `<option value="${p}">${p}</option>`;
                });
                select.innerHTML = html;
            }
        }

        // ========== ãƒªãƒ¼ã‚°æˆ¦ç®¡ç†æ©Ÿèƒ½ ==========
        
        // ãƒªãƒ¼ã‚°æˆ¦ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        function showLeagueCreateForm() {
            document.getElementById('leagueCreateForm').style.display = 'block';
            document.getElementById('leagueName').value = '';
            updateLeaguePlayerSelects();
            document.getElementById('leagueName').focus();
        }

        // ãƒªãƒ¼ã‚°æˆ¦ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
        function hideLeagueCreateForm() {
            document.getElementById('leagueCreateForm').style.display = 'none';
        }

        // ãƒªãƒ¼ã‚°æˆ¦ä½œæˆç”¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠè‚¢ã‚’æ›´æ–°
        function updateLeaguePlayerSelects() {
            const html = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' + 
                         allPlayers.map(p => `<option value="${p}">${p}</option>`).join('');
            
            for(let i = 1; i <= 4; i++) {
                const select = document.getElementById('newLeaguePlayer' + i);
                if(select) select.innerHTML = html;
            }
            
            // å…¥åŠ›ã‚¿ãƒ–ã®ãƒªãƒ¼ã‚°æˆ¦ã‚¯ã‚¤ãƒƒã‚¯é¸æŠã‚‚æ›´æ–°
            updateLeagueQuickSelect();
        }
        
        // å…¥åŠ›ã‚¿ãƒ–ã®ãƒªãƒ¼ã‚°æˆ¦ã‚¯ã‚¤ãƒƒã‚¯é¸æŠã‚’æ›´æ–°
        function updateLeagueQuickSelect() {
            const select = document.getElementById('leagueQuickSelect');
            if(!select) return;
            
            let html = '<option value="">-- ãƒªãƒ¼ã‚°æˆ¦ã‚’é¸æŠ --</option>';
            
            if(leagues && Object.keys(leagues).length > 0) {
                Object.entries(leagues).forEach(([leagueId, league]) => {
                    html += `<option value="${leagueId}">${escapeHtml(league.name)}</option>`;
                });
            }
            
            select.innerHTML = html;
        }
        
        // ãƒªãƒ¼ã‚°æˆ¦ãƒ¡ãƒ³ãƒãƒ¼ã‚’å…¥åŠ›æ¬„ã«é©ç”¨
        function applyLeagueMembers() {
            const select = document.getElementById('leagueQuickSelect');
            if(!select || !select.value) return;
            
            const leagueId = select.value;
            const league = leagues[leagueId];
            
            if(!league || !league.players || league.players.length !== 4) {
                alert('ãƒªãƒ¼ã‚°æˆ¦ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const d = getData();
            
            // 4äººéº»é›€ã«è¨­å®š
            const gameTypeSelect = document.getElementById('gameType');
            if(gameTypeSelect && gameTypeSelect.value !== '4') {
                gameTypeSelect.value = '4';
                gameTypeChanged();
            }
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¨­å®š
            d.players = [...league.players];
            
            // ç”»é¢ã‚’æ›´æ–°
            render();
            
            // é€šçŸ¥
            showNotification(`ğŸ† ãƒªãƒ¼ã‚°æˆ¦ã€Œ${league.name}ã€ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ`);
        }

        // ãƒªãƒ¼ã‚°æˆ¦ã‚’ä½œæˆ
        function createLeague() {
            const name = document.getElementById('leagueName').value.trim();
            if(!name) {
                alert('ãƒªãƒ¼ã‚°æˆ¦åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // 4äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å–å¾—
            const selectedPlayers = [];
            for(let i = 1; i <= 4; i++) {
                const select = document.getElementById('newLeaguePlayer' + i);
                const player = select ? select.value : '';
                if(!player) {
                    alert(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}ã‚’é¸æŠã—ã¦ãã ã•ã„`);
                    return;
                }
                if(selectedPlayers.includes(player)) {
                    alert(`åŒã˜ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¤‡æ•°é¸æŠã•ã‚Œã¦ã„ã¾ã™: ${player}`);
                    return;
                }
                selectedPlayers.push(player);
            }

            // ãƒªãƒ¼ã‚°æˆ¦IDã‚’ç”Ÿæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ï¼‰
            const leagueId = 'league_' + Date.now();
            
            // ãƒªãƒ¼ã‚°æˆ¦ãƒ‡ãƒ¼ã‚¿
            const leagueData = {
                name: name,
                players: selectedPlayers,
                createdAt: Date.now()
            };

            // Firebaseã«ä¿å­˜
            database.ref('leagues/' + leagueId).set(leagueData)
                .then(() => {
                    console.log('ãƒªãƒ¼ã‚°æˆ¦ã‚’ä½œæˆã—ã¾ã—ãŸ:', leagueId, leagueData);
                    leagues[leagueId] = leagueData;
                    hideLeagueCreateForm();
                    renderLeagues();
                    updateLeagueQuickSelect(); // å…¥åŠ›ã‚¿ãƒ–ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                    showNotification('âœ… ãƒªãƒ¼ã‚°æˆ¦ã€Œ' + name + 'ã€ã‚’ä½œæˆã—ã¾ã—ãŸ');
                })
                .catch(error => {
                    console.error('ãƒªãƒ¼ã‚°æˆ¦ã®ä½œæˆã«å¤±æ•—:', error);
                    alert('ãƒªãƒ¼ã‚°æˆ¦ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                });
        }

        // Firebaseã‹ã‚‰ãƒªãƒ¼ã‚°æˆ¦ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        function loadLeagues() {
            return database.ref('leagues').once('value')
                .then(snapshot => {
                    leagues = snapshot.val() || {};
                    console.log('ãƒªãƒ¼ã‚°æˆ¦ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', Object.keys(leagues).length + 'ä»¶');
                    renderLeagues();
                    updateLeagueQuickSelect(); // å…¥åŠ›ã‚¿ãƒ–ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                })
                .catch(error => {
                    console.error('ãƒªãƒ¼ã‚°æˆ¦ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                });
        }

        // ãƒªãƒ¼ã‚°æˆ¦ä¸€è¦§ã‚’è¡¨ç¤º
        function renderLeagues() {
            const container = document.getElementById('leagueList');
            if(!container) return;

            const leagueArray = Object.entries(leagues).sort((a, b) => b[1].createdAt - a[1].createdAt);

            if(leagueArray.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 bg-gray-50 rounded-lg mb-4">
                        <div class="text-4xl mb-3">ğŸ†</div>
                        <p class="text-gray-600 font-semibold mb-2">ãƒªãƒ¼ã‚°æˆ¦ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <p class="text-sm text-gray-500">ã€Œæ–°ã—ã„ãƒªãƒ¼ã‚°æˆ¦ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="mb-4">';
            html += '<h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ“‹ ãƒªãƒ¼ã‚°æˆ¦ä¸€è¦§</h3>';
            
            leagueArray.forEach(([leagueId, league]) => {
                const isSelected = leagueId === selectedLeagueId;
                const borderColor = isSelected ? 'border-amber-400' : 'border-gray-200';
                const bgColor = isSelected ? 'bg-amber-50' : 'bg-white';
                
                html += `
                    <div class="mb-3 border-2 ${borderColor} ${bgColor} rounded-lg p-3 shadow-sm">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-gray-800 flex-1">${escapeHtml(league.name)}</h4>
                            <button onclick="deleteLeague('${leagueId}')" 
                                    class="text-red-500 text-sm px-2 py-1 hover:bg-red-50 rounded active:bg-red-100">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            ğŸ‘¥ ${league.players.map(p => escapeHtml(p)).join(' / ')}
                        </div>
                        <button onclick="selectLeague('${leagueId}')" 
                                class="w-full ${isSelected ? 'bg-amber-500' : 'bg-blue-500'} text-white py-2 rounded-lg text-sm font-bold active:opacity-80">
                            ${isSelected ? 'âœ… é¸æŠä¸­' : 'ğŸ“Š æˆç¸¾ã‚’è¡¨ç¤º'}
                        </button>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ãƒªãƒ¼ã‚°æˆ¦ã‚’é¸æŠã—ã¦æˆç¸¾ã‚’è¡¨ç¤º
        function selectLeague(leagueId) {
            selectedLeagueId = leagueId;
            const league = leagues[leagueId];
            
            if(!league) {
                alert('ãƒªãƒ¼ã‚°æˆ¦ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            console.log('ãƒªãƒ¼ã‚°æˆ¦ã‚’é¸æŠ:', leagueId, league);
            renderLeagues(); // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            calculateLeagueById(leagueId);
        }

        // ãƒªãƒ¼ã‚°æˆ¦ã‚’å‰Šé™¤
        function deleteLeague(leagueId) {
            const league = leagues[leagueId];
            if(!league) return;

            if(!confirm(`ãƒªãƒ¼ã‚°æˆ¦ã€Œ${league.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            database.ref('leagues/' + leagueId).remove()
                .then(() => {
                    console.log('ãƒªãƒ¼ã‚°æˆ¦ã‚’å‰Šé™¤ã—ã¾ã—ãŸ:', leagueId);
                    delete leagues[leagueId];
                    
                    if(selectedLeagueId === leagueId) {
                        selectedLeagueId = null;
                        document.getElementById('leagueResults').innerHTML = '';
                    }
                    
                    renderLeagues();
                    updateLeagueQuickSelect(); // å…¥åŠ›ã‚¿ãƒ–ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
                    showNotification('ğŸ—‘ï¸ ãƒªãƒ¼ã‚°æˆ¦ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                })
                .catch(error => {
                    console.error('ãƒªãƒ¼ã‚°æˆ¦ã®å‰Šé™¤ã«å¤±æ•—:', error);
                    alert('ãƒªãƒ¼ã‚°æˆ¦ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                });
        }

        // ãƒªãƒ¼ã‚°æˆ¦IDã‹ã‚‰æˆç¸¾ã‚’è¨ˆç®—
        function calculateLeagueById(leagueId) {
            const league = leagues[leagueId];
            if(!league) return;

            const selectedPlayers = league.players;
            console.log('ãƒªãƒ¼ã‚°æˆ¦ãƒ¡ãƒ³ãƒãƒ¼:', selectedPlayers);
            
            // é¸æŠã•ã‚ŒãŸå¹´ã‚’å–å¾—
            const yearSelect = document.getElementById('leagueYearSelect');
            const selectedYear = yearSelect ? yearSelect.value : 'all';

            // ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã§è¡Œã‚ã‚ŒãŸè©¦åˆã‚’æŠ½å‡º
            const leagueGames = [];
            Object.entries(data.dates).forEach(([date, dateData]) => {
                if(!dateData || !dateData.games || !dateData.players) return;
                
                // å¹´ãƒ•ã‚£ãƒ«ã‚¿
                if(selectedYear !== 'all') {
                    const year = new Date(date).getFullYear();
                    if(year.toString() !== selectedYear) return;
                }
                
                // ã“ã®æ—¥ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒªãƒ¼ã‚°æˆ¦ãƒ¡ãƒ³ãƒãƒ¼ã¨å®Œå…¨ä¸€è‡´ã™ã‚‹ã‹ç¢ºèªï¼ˆé †åºã¯ç„¡è¦–ï¼‰
                const dayPlayers = dateData.players.filter(p => p); // ç©ºæ–‡å­—ã‚’é™¤å¤–
                if(dayPlayers.length !== 4) return;
                
                // ã‚½ãƒ¼ãƒˆã—ã¦æ¯”è¼ƒã™ã‚‹ã“ã¨ã§ã€é †åºã«é–¢ä¿‚ãªãåŒã˜ãƒ¡ãƒ³ãƒãƒ¼ã‹ã‚’åˆ¤å®š
                const sortedDayPlayers = [...dayPlayers].sort();
                const sortedSelectedPlayers = [...selectedPlayers].sort();
                const isLeagueMatch = JSON.stringify(sortedDayPlayers) === JSON.stringify(sortedSelectedPlayers);
                
                if(isLeagueMatch) {
                    console.log('ãƒªãƒ¼ã‚°æˆ¦ã®è©¦åˆã‚’ç™ºè¦‹:', date, 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åº:', dayPlayers);
                    dateData.games.forEach((game, gameIndex) => {
                        leagueGames.push({
                            date: date,
                            gameIndex: gameIndex + 1,
                            players: dateData.players,
                            scores: game
                        });
                    });
                }
            });

            console.log('ãƒªãƒ¼ã‚°æˆ¦è©¦åˆæ•°:', leagueGames.length);

            if(leagueGames.length === 0) {
                document.getElementById('leagueResults').innerHTML = `
                    <div class="text-center py-12 bg-gray-50 rounded-lg">
                        <div class="text-4xl mb-3">ğŸ¤”</div>
                        <p class="text-gray-600 font-semibold mb-2">ã“ã®4äººã§ã®å¯¾æˆ¦è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
                        <p class="text-sm text-gray-500">ã€Œ${escapeHtml(league.name)}ã€ã®ãƒ¡ãƒ³ãƒãƒ¼å…¨å“¡ã§å¯¾æˆ¦ã—ãŸè¨˜éŒ²ãŒå¿…è¦ã§ã™</p>
                    </div>
                `;
                return;
            }

            // çµ±è¨ˆã‚’è¨ˆç®—
            const stats = {};
            selectedPlayers.forEach(p => {
                stats[p] = {
                    name: p,
                    totalGames: 0,
                    totalScore: 0,
                    ranks: {1:0, 2:0, 3:0, 4:0}
                };
            });

            leagueGames.forEach(game => {
                game.scores.forEach((score, idx) => {
                    const playerName = game.players[idx];
                    if(!stats[playerName]) return;
                    
                    stats[playerName].totalGames++;
                    stats[playerName].totalScore += score;
                    
                    // é †ä½è¨ˆç®—
                    const sorted = [...game.scores].sort((a,b) => b-a);
                    const rank = sorted.indexOf(score) + 1;
                    stats[playerName].ranks[rank]++;
                });
            });

            // çµæœã‚’è¡¨ç¤º
            renderLeagueResults(league.name, selectedPlayers, stats, leagueGames);
        }

        // ãƒªãƒ¼ã‚°æˆ¦ï¼šçµæœè¡¨ç¤ºï¼ˆãƒªãƒ¼ã‚°æˆ¦åã‚’è¿½åŠ ï¼‰
        function renderLeagueResults(leagueName, players, stats, games) {
            const list = players.map(p => stats[p]).sort((a,b) => b.totalScore - a.totalScore);
            
            let html = `
                <div class="bg-gradient-to-r from-amber-50 to-yellow-50 rounded-lg p-4 mb-4 border-2 border-amber-300">
                    <h3 class="text-lg font-bold text-amber-800 mb-2 flex items-center">
                        ğŸ† ${escapeHtml(leagueName)} - æˆç¸¾
                    </h3>
                    <p class="text-sm text-amber-700">ç·å¯¾æˆ¦æ•°: <span class="font-bold">${games.length}åŠè˜</span></p>
                </div>
            `;

            list.forEach((p, idx) => {
                const avg = (p.totalScore / p.totalGames).toFixed(1);
                const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£'];
                const borderColors = ['border-yellow-400', 'border-gray-400', 'border-orange-400', 'border-blue-300'];
                const bgColors = ['bg-yellow-50', 'bg-gray-50', 'bg-orange-50', 'bg-blue-50'];
                
                let ranks = '';
                for(let r=1; r<=4; r++) {
                    const count = p.ranks[r] || 0;
                    const pct = ((count/p.totalGames)*100).toFixed(1);
                    const colors = ['bg-yellow-500 text-yellow-700 bg-yellow-50','bg-gray-400 text-gray-700 bg-gray-50','bg-orange-500 text-orange-700 bg-orange-50','bg-red-500 text-red-700 bg-red-50'][r-1].split(' ');
                    ranks += `<div class="flex items-center gap-2 mb-2">
                        <span class="text-xs font-bold w-8 ${colors[1]}">${r}ä½</span>
                        <div class="flex-1 ${colors[2]} rounded-full h-6 overflow-hidden">
                            <div class="${colors[0]} h-full flex items-center justify-end px-2 text-white text-xs font-bold" style="width:${pct}%">
                                ${pct>15?pct+'%':''}
                            </div>
                        </div>
                        <span class="text-xs font-bold ${colors[1]} w-12">${pct}%</span>
                        <span class="text-xs text-gray-500 w-10 text-right">${count}å›</span>
                    </div>`;
                }
                
                html += `<div class="${bgColors[idx]} rounded-lg p-4 border-2 ${borderColors[idx]} mb-3">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="text-4xl">${medals[idx]}</div>
                            <div>
                                <h3 class="text-lg font-bold">${p.name}</h3>
                                <p class="text-xs text-gray-600">${p.totalGames}åŠè˜</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold ${p.totalScore>=0?'text-green-600':'text-red-600'}">
                                ${p.totalScore>0?'+':''}${Number(p.totalScore).toFixed(1)}
                            </div>
                            <div class="text-xs text-gray-600">å¹³å‡: ${avg>0?'+':''}${avg}</div>
                        </div>
                    </div>
                    <div class="border-t border-gray-300 pt-3">
                        <h4 class="text-xs font-bold mb-2">é †ä½å–å¾—ç‡</h4>
                        ${ranks}
                    </div>
                </div>`;
            });

            // æ—¥åˆ¥æˆç¸¾ã‚’è¿½åŠ 
            html += `
                <div class="mt-4 bg-white rounded-lg p-4 border-2 border-gray-300">
                    <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ“… æ—¥åˆ¥æˆç¸¾</h3>
            `;
            
            // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const gamesByDate = {};
            games.forEach(game => {
                if(!gamesByDate[game.date]) {
                    gamesByDate[game.date] = [];
                }
                gamesByDate[game.date].push(game);
            });
            
            // æ—¥ä»˜ã‚’é™é †ã§ã‚½ãƒ¼ãƒˆ
            const sortedDates = Object.keys(gamesByDate).sort().reverse();
            
            if(sortedDates.length === 0) {
                html += '<div class="text-center py-4 text-gray-400">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
            } else {
                sortedDates.forEach(date => {
                    const dateGames = gamesByDate[date];
                    html += `
                        <div class="mb-4 bg-gray-50 rounded-lg p-3 border border-gray-200">
                            <div class="font-bold text-sm mb-2">${new Date(date).toLocaleDateString('ja-JP', {year: 'numeric', month: 'long', day: 'numeric'})}</div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-xs">
                                    <thead>
                                        <tr class="border-b-2 border-gray-300 bg-gray-100">
                                            <th class="text-left py-2 px-2 font-bold">åŠè˜</th>
                                            ${players.map(p => `<th class="text-center py-2 px-2 font-bold">${escapeHtml(p)}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    dateGames.forEach((game, idx) => {
                        html += `<tr class="border-b border-gray-200">
                            <td class="py-2 px-2">${idx + 1}</td>`;
                        
                        players.forEach(playerName => {
                            const playerIndex = game.players.indexOf(playerName);
                            const score = game.scores[playerIndex];
                            const colorClass = score > 0 ? 'text-green-600' : score < 0 ? 'text-red-600' : 'text-gray-600';
                            html += `<td class="text-center py-2 px-2 font-bold ${colorClass}">
                                ${score > 0 ? '+' : ''}${Number(score).toFixed(1)}
                            </td>`;
                        });
                        
                        html += `</tr>`;
                    });
                    
                    // æ—¥ã”ã¨ã®åˆè¨ˆã‚’è¡¨ç¤º
                    html += `<tr class="border-t-2 border-gray-300 bg-gray-100 font-bold">
                        <td class="py-2 px-2">åˆè¨ˆ</td>`;
                    
                    players.forEach(playerName => {
                        let dayTotal = 0;
                        dateGames.forEach(game => {
                            const playerIndex = game.players.indexOf(playerName);
                            dayTotal += game.scores[playerIndex];
                        });
                        const colorClass = dayTotal > 0 ? 'text-green-600' : dayTotal < 0 ? 'text-red-600' : 'text-gray-600';
                        html += `<td class="text-center py-2 px-2 ${colorClass}">
                            ${dayTotal > 0 ? '+' : ''}${Number(dayTotal).toFixed(1)}
                        </td>`;
                    });
                    
                    html += `</tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';

            document.getElementById('leagueResults').innerHTML = html;
        }
    </script>
</body>
</html>
