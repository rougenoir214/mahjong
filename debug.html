<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebaseè¨ºæ–­ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-red-50 via-orange-50 to-yellow-50 min-h-screen p-8">

    <div class="container mx-auto max-w-4xl">
        <div class="bg-white rounded-xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">ğŸ”</div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Firebaseè¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
                <p class="text-gray-600">ç¾åœ¨ã®è¨­å®šã¨ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèªã—ã¾ã™</p>
            </div>

            <!-- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ -->
            <div class="mb-6">
                <button onclick="runAllTests()" 
                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 rounded-lg font-bold hover:opacity-90 transition text-lg">
                    ğŸš€ è¨ºæ–­ã‚’å®Ÿè¡Œã™ã‚‹
                </button>
            </div>

            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="results" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyA7bkfPDgs3iSNFC2MOxjs1aakbHbMi-jM",
            authDomain: "mahjong-337a9.firebaseapp.com",
            databaseURL: "https://mahjong-337a9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mahjong-337a9",
            storageBucket: "mahjong-337a9.firebasestorage.app",
            messagingSenderId: "605742422445",
            appId: "1:605742422445:web:e207ae05cba0a67f7b2924",
            measurementId: "G-2VDY4LKSPP"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        function addResult(title, status, message, details = '') {
            const resultsDiv = document.getElementById('results');
            const statusColors = {
                'success': 'bg-green-100 border-green-500 text-green-800',
                'error': 'bg-red-100 border-red-500 text-red-800',
                'warning': 'bg-yellow-100 border-yellow-500 text-yellow-800',
                'info': 'bg-blue-100 border-blue-500 text-blue-800'
            };
            
            const statusIcons = {
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸'
            };

            const html = `
                <div class="border-l-4 p-4 rounded ${statusColors[status]}">
                    <div class="font-bold mb-2">${statusIcons[status]} ${title}</div>
                    <div class="text-sm">${message}</div>
                    ${details ? `<div class="code-block mt-2">${details}</div>` : ''}
                </div>
            `;
            
            resultsDiv.innerHTML += html;
        }

        async function runAllTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="text-center py-8 text-gray-500">è¨ºæ–­ä¸­...</div>';
            
            await new Promise(resolve => setTimeout(resolve, 500));
            resultsDiv.innerHTML = '';

            addResult('è¨ºæ–­é–‹å§‹', 'info', 'å„ç¨®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™...');

            // ãƒ†ã‚¹ãƒˆ1: Firebaseæ¥ç¶šç¢ºèª
            await testFirebaseConnection();

            // ãƒ†ã‚¹ãƒˆ2: ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆ
            await testRootRead();

            // ãƒ†ã‚¹ãƒˆ3: groupsãƒ‘ã‚¹èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆ
            await testGroupsRead();

            // ãƒ†ã‚¹ãƒˆ4: groupsãƒ‘ã‚¹æ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆ
            await testGroupsWrite();

            // ãƒ†ã‚¹ãƒˆ5: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç¢ºèª
            await testExistingData();

            // æ¨å¥¨äº‹é …
            addRecommendations();
        }

        async function testFirebaseConnection() {
            try {
                const ref = database.ref('.info/connected');
                const snapshot = await ref.once('value');
                const connected = snapshot.val();
                
                if (connected) {
                    addResult(
                        'Firebaseæ¥ç¶š',
                        'success',
                        'Firebaseã«æ­£å¸¸ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã™',
                        `ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URL: ${firebaseConfig.databaseURL}`
                    );
                } else {
                    addResult(
                        'Firebaseæ¥ç¶š',
                        'error',
                        'Firebaseã«æ¥ç¶šã§ãã¦ã„ã¾ã›ã‚“',
                        'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„'
                    );
                }
            } catch (error) {
                addResult(
                    'Firebaseæ¥ç¶š',
                    'error',
                    'æ¥ç¶šãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
                    error.message
                );
            }
        }

        async function testRootRead() {
            try {
                const snapshot = await database.ref('/').once('value');
                addResult(
                    'ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«èª­ã¿å–ã‚Š',
                    'success',
                    'ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Œã¾ã—ãŸ',
                    `ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼: ${Object.keys(snapshot.val() || {}).join(', ') || '(ãªã—)'}`
                );
            } catch (error) {
                addResult(
                    'ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«èª­ã¿å–ã‚Š',
                    'error',
                    'ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ',
                    `ã‚¨ãƒ©ãƒ¼: ${error.code}\n${error.message}`
                );
            }
        }

        async function testGroupsRead() {
            try {
                const snapshot = await database.ref('groups').once('value');
                const groups = snapshot.val();
                
                if (groups) {
                    addResult(
                        'groupsãƒ‘ã‚¹èª­ã¿å–ã‚Š',
                        'success',
                        '/groups ãƒ‘ã‚¹ã®èª­ã¿å–ã‚Šã«æˆåŠŸã—ã¾ã—ãŸ',
                        `æ—¢å­˜ã‚°ãƒ«ãƒ¼ãƒ—: ${Object.keys(groups).join(', ')}`
                    );
                } else {
                    addResult(
                        'groupsãƒ‘ã‚¹èª­ã¿å–ã‚Š',
                        'success',
                        '/groups ãƒ‘ã‚¹ã®èª­ã¿å–ã‚Šã«æˆåŠŸã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰',
                        'ã¾ã ã‚°ãƒ«ãƒ¼ãƒ—ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“'
                    );
                }
            } catch (error) {
                addResult(
                    'groupsãƒ‘ã‚¹èª­ã¿å–ã‚Š',
                    'error',
                    '/groups ãƒ‘ã‚¹ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ',
                    `ã‚¨ãƒ©ãƒ¼: ${error.code}\n${error.message}\n\nğŸ”´ ã“ã‚ŒãŒåŸå› ã§ã™ï¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“`
                );
            }
        }

        async function testGroupsWrite() {
            const testGroupId = 'test_' + Date.now();
            try {
                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€
                await database.ref(`groups/${testGroupId}/info`).set({
                    name: 'ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—',
                    createdAt: new Date().toISOString(),
                    isTest: true
                });

                addResult(
                    'groupsãƒ‘ã‚¹æ›¸ãè¾¼ã¿',
                    'success',
                    '/groups ãƒ‘ã‚¹ã¸ã®æ›¸ãè¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸ',
                    `ãƒ†ã‚¹ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ID: ${testGroupId}\n\nâœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™ï¼`
                );

                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                await database.ref(`groups/${testGroupId}`).remove();
                
            } catch (error) {
                addResult(
                    'groupsãƒ‘ã‚¹æ›¸ãè¾¼ã¿',
                    'error',
                    '/groups ãƒ‘ã‚¹ã¸ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ',
                    `ã‚¨ãƒ©ãƒ¼: ${error.code}\n${error.message}\n\nğŸ”´ ã“ã‚ŒãŒå•é¡Œã§ã™ï¼\n\nFirebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`
                );
            }
        }

        async function testExistingData() {
            try {
                const [passwordsSnap, mahjongSnap, leaguesSnap] = await Promise.all([
                    database.ref('passwords').once('value'),
                    database.ref('mahjongData').once('value'),
                    database.ref('leagues').once('value')
                ]);

                const hasPasswords = passwordsSnap.exists();
                const hasMahjong = mahjongSnap.exists();
                const hasLeagues = leaguesSnap.exists();

                if (hasPasswords || hasMahjong || hasLeagues) {
                    let details = 'æ—¢å­˜ãƒ‡ãƒ¼ã‚¿:\n';
                    if (hasPasswords) details += 'âœ“ /passwords\n';
                    if (hasMahjong) details += 'âœ“ /mahjongData\n';
                    if (hasLeagues) details += 'âœ“ /leagues\n';
                    details += '\nğŸ’¡ migrate.htmlã§ã‚°ãƒ«ãƒ¼ãƒ—ã«ç§»è¡Œã§ãã¾ã™';

                    addResult(
                        'æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç¢ºèª',
                        'info',
                        'ç§»è¡Œå‰ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ',
                        details
                    );
                } else {
                    addResult(
                        'æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç¢ºèª',
                        'info',
                        'æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“',
                        'ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã§ã™'
                    );
                }
            } catch (error) {
                addResult(
                    'æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç¢ºèª',
                    'warning',
                    'æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ',
                    error.message
                );
            }
        }

        function addRecommendations() {
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML += `
                <div class="mt-8 p-6 bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg border-2 border-purple-300">
                    <h3 class="text-xl font-bold mb-4 text-purple-800">ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h3>
                    <div class="space-y-3 text-sm">
                        <div class="bg-white p-4 rounded-lg">
                            <div class="font-bold text-red-600 mb-2">âŒ ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆï¼š</div>
                            <ol class="list-decimal list-inside space-y-1 text-gray-700">
                                <li>Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ãï¼š
                                    <a href="https://console.firebase.google.com/project/mahjong-337a9/database/mahjong-337a9-default-rtdb/rules" 
                                       target="_blank" 
                                       class="text-blue-600 underline break-all">
                                        ãƒ«ãƒ¼ãƒ«è¨­å®šãƒšãƒ¼ã‚¸
                                    </a>
                                </li>
                                <li>ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‚¨ãƒ‡ã‚£ã‚¿ã«è²¼ã‚Šä»˜ã‘</li>
                                <li>ã€Œå…¬é–‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                                <li>ã“ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦å†åº¦è¨ºæ–­ã‚’å®Ÿè¡Œ</li>
                            </ol>
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg">
                            <div class="font-bold text-gray-700 mb-2">ã‚³ãƒ”ãƒ¼ç”¨ãƒ«ãƒ¼ãƒ«ï¼š</div>
                            <div class="code-block">{
  "rules": {
    "groups": {
      "$groupId": {
        "info": {
          ".read": true,
          ".write": true
        },
        "passwords": {
          ".read": true,
          ".write": true
        },
        "mahjong": {
          ".read": true,
          ".write": true
        },
        "leagues": {
          ".read": true,
          ".write": true
        }
      }
    },
    "passwords": {
      ".read": true,
      ".write": true
    },
    "mahjongData": {
      ".read": true,
      ".write": true
    },
    "leagues": {
      ".read": true,
      ".write": true
    }
  }
}</div>
                            <button onclick="copyRules()" 
                                    class="mt-2 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition">
                                ğŸ“‹ ãƒ«ãƒ¼ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
                            </button>
                        </div>

                        <div class="bg-white p-4 rounded-lg">
                            <div class="font-bold text-green-600 mb-2">âœ… æˆåŠŸã—ãŸå ´åˆï¼š</div>
                            <ol class="list-decimal list-inside space-y-1 text-gray-700">
                                <li>admin.htmlã§ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã§ãã¾ã™</li>
                                <li>migrate.htmlã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œã§ãã¾ã™</li>
                                <li>mobile-firebase.html?group=ã‚°ãƒ«ãƒ¼ãƒ—IDã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™</li>
                            </ol>
                        </div>
                    </div>
                </div>
            `;
        }

        function copyRules() {
            const rules = `{
  "rules": {
    "groups": {
      "$groupId": {
        "info": {
          ".read": true,
          ".write": true
        },
        "passwords": {
          ".read": true,
          ".write": true
        },
        "mahjong": {
          ".read": true,
          ".write": true
        },
        "leagues": {
          ".read": true,
          ".write": true
        }
      }
    },
    "passwords": {
      ".read": true,
      ".write": true
    },
    "mahjongData": {
      ".read": true,
      ".write": true
    },
    "leagues": {
      ".read": true,
      ".write": true
    }
  }
}`;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(rules).then(() => {
                    alert('âœ… ãƒ«ãƒ¼ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nFirebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã‚¨ãƒ‡ã‚£ã‚¿ã«è²¼ã‚Šä»˜ã‘ã¦ã€Œå…¬é–‹ã€ã—ã¦ãã ã•ã„ã€‚');
                });
            } else {
                alert('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.onload = function() {
            setTimeout(runAllTests, 500);
        };
    </script>
</body>
</html>
