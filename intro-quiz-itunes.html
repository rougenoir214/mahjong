<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>イントロクイズ - iTunes版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-cyan-teal {
            background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .animate-bounce-in {
            animation: bounceIn 0.5s ease;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .progress-bar {
            transition: width 0.1s linear;
        }
        
        .tab-active {
            background: rgba(255, 255, 255, 0.3);
            border-bottom: 3px solid white;
        }
    </style>
</head>
<body class="gradient-cyan-teal min-h-screen">
    <!-- オーディオプレーヤー（非表示） -->
    <audio id="audioPlayer" preload="auto"></audio>
    
    <!-- メインコンテナ -->
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- ヘッダー -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-black text-white mb-3 drop-shadow-lg">
                🎵 イントロクイズ
            </h1>
            <p class="text-lg text-white/90 drop-shadow">Apple Music プレビュー版</p>
        </header>

        <!-- メイン画面 -->
        <div id="app">
            <!-- ユーザー管理画面 -->
            <div id="userManagement" class="space-y-6">
                <!-- プレイヤー管理 -->
                <div class="glass-effect rounded-3xl p-6 shadow-2xl">
                    <h2 class="text-3xl font-bold text-white mb-4 flex items-center gap-3">
                        <span class="text-4xl">👥</span>
                        プレイヤー管理
                    </h2>
                    
                    <!-- プレイヤー追加フォーム -->
                    <div class="mb-6 flex gap-3">
                        <input 
                            type="text" 
                            id="playerName" 
                            placeholder="プレイヤー名を入力"
                            class="flex-1 px-4 py-3 rounded-xl text-lg focus:outline-none focus:ring-4 focus:ring-cyan-400/50"
                        />
                        <button 
                            onclick="addPlayer()"
                            class="bg-white text-cyan-600 px-8 py-3 rounded-xl font-bold text-lg hover:bg-cyan-50 transition-all transform hover:scale-105 shadow-lg"
                        >
                            追加
                        </button>
                    </div>
                    
                    <!-- プレイヤーリスト -->
                    <div id="playerList" class="space-y-3"></div>
                    
                    <!-- 成績リセットボタン -->
                    <button 
                        onclick="resetScores()"
                        class="mt-4 w-full bg-red-500/80 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-600 transition-all"
                    >
                        🔄 全成績をリセット
                    </button>
                </div>

                <!-- 曲管理 -->
                <div class="glass-effect rounded-3xl p-6 shadow-2xl">
                    <h2 class="text-3xl font-bold text-white mb-4 flex items-center gap-3">
                        <span class="text-4xl">🎵</span>
                        曲を追加
                    </h2>
                    
                    <!-- 検索タイプ切り替え -->
                    <div class="flex gap-2 mb-4">
                        <button 
                            id="tabSong"
                            onclick="switchSearchTab('song')"
                            class="tab-active flex-1 px-4 py-3 rounded-t-xl text-white font-bold transition-all"
                        >
                            🎵 曲名検索
                        </button>
                        <button 
                            id="tabArtist"
                            onclick="switchSearchTab('artist')"
                            class="flex-1 px-4 py-3 rounded-t-xl text-white font-bold transition-all hover:bg-white/20"
                        >
                            🎤 アーティスト検索
                        </button>
                        <button 
                            id="tabArtistQuiz"
                            onclick="switchSearchTab('artistQuiz')"
                            class="flex-1 px-4 py-3 rounded-t-xl text-white font-bold transition-all hover:bg-white/20"
                        >
                            🎯 アーティストクイズ
                        </button>
                    </div>
                    
                    <!-- 曲名検索タブ -->
                    <div id="songSearchTab" class="space-y-4">
                        <div class="flex gap-3">
                            <input 
                                type="text" 
                                id="songSearchQuery" 
                                placeholder="曲名で検索（例: Lemon）"
                                class="flex-1 px-4 py-3 rounded-xl text-lg focus:outline-none focus:ring-4 focus:ring-cyan-400/50"
                            />
                            <button 
                                onclick="searchBySong()"
                                class="bg-white text-cyan-600 px-8 py-3 rounded-xl font-bold text-lg hover:bg-cyan-50 transition-all transform hover:scale-105 shadow-lg"
                            >
                                🔍 検索
                            </button>
                        </div>
                    </div>
                    
                    <!-- アーティスト検索タブ -->
                    <div id="artistSearchTab" class="hidden space-y-4">
                        <div class="flex gap-3">
                            <input 
                                type="text" 
                                id="artistSearchQuery" 
                                placeholder="アーティスト名で検索（例: あいみょん）"
                                class="flex-1 px-4 py-3 rounded-xl text-lg focus:outline-none focus:ring-4 focus:ring-cyan-400/50"
                            />
                            <button 
                                onclick="searchByArtist()"
                                class="bg-white text-cyan-600 px-8 py-3 rounded-xl font-bold text-lg hover:bg-cyan-50 transition-all transform hover:scale-105 shadow-lg"
                            >
                                🔍 検索
                            </button>
                        </div>
                        <div id="artistResults" class="space-y-2 max-h-96 overflow-y-auto"></div>
                    </div>
                    
                    <!-- アーティストクイズタブ -->
                    <div id="artistQuizTab" class="hidden space-y-4">
                        <div class="bg-white/10 rounded-xl p-4 mb-4">
                            <p class="text-white text-sm mb-2">
                                💡 アーティスト名を入力すると、そのアーティストの曲を自動で10曲選択してクイズを開始します
                            </p>
                        </div>
                        <div class="flex gap-3">
                            <input 
                                type="text" 
                                id="artistQuizQuery" 
                                placeholder="アーティスト名を入力（例: 米津玄師）"
                                class="flex-1 px-4 py-3 rounded-xl text-lg focus:outline-none focus:ring-4 focus:ring-cyan-400/50"
                            />
                            <button 
                                onclick="startArtistQuiz()"
                                class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-8 py-3 rounded-xl font-bold text-lg hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                🎯 開始
                            </button>
                        </div>
                    </div>
                    
                    <!-- テーマ別クイズボタン -->
                    <div class="mb-6 mt-6">
                        <h3 class="text-white font-bold mb-3 text-lg">📋 テーマ別クイズ</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button 
                                onclick="startThemeQuiz('J-POP 2000年代 ヒット曲')"
                                class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                🎵 2000年代J-POP
                            </button>
                            <button 
                                onclick="startThemeQuiz('J-POP 2010年代 ヒット曲')"
                                class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                🎤 2010年代J-POP
                            </button>
                            <button 
                                onclick="startThemeQuiz('アニメソング 人気')"
                                class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                🌟 アニメソング
                            </button>
                            <button 
                                onclick="startThemeQuiz('洋楽 ヒット曲')"
                                class="bg-gradient-to-r from-green-500 to-teal-500 text-white px-4 py-3 rounded-xl font-bold hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                🌍 洋楽ヒット
                            </button>
                        </div>
                    </div>
                    
                    <!-- 検索結果 -->
                    <div id="searchResults" class="space-y-2 mb-4 max-h-96 overflow-y-auto"></div>
                    
                    <!-- 選択した曲リスト -->
                    <h3 class="text-xl font-bold text-white mb-3 mt-6">選択した曲（<span id="songCount">0</span>曲）</h3>
                    <div id="selectedSongsList" class="space-y-2 max-h-64 overflow-y-auto"></div>
                </div>

                <!-- クイズ設定 -->
                <div class="glass-effect rounded-3xl p-6 shadow-2xl">
                    <h2 class="text-3xl font-bold text-white mb-4">⚙️ クイズ設定</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white font-bold mb-2 text-lg">
                                イントロの長さ: <span id="introLengthValue">3</span>秒
                            </label>
                            <input 
                                type="range" 
                                id="introLength" 
                                min="1" 
                                max="10" 
                                value="3"
                                oninput="updateIntroLength(this.value)"
                                class="w-full h-3 bg-white/30 rounded-lg appearance-none cursor-pointer"
                            />
                        </div>
                    </div>
                    
                    <button 
                        onclick="startQuiz()"
                        class="mt-6 w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-8 py-4 rounded-xl font-black text-2xl hover:shadow-2xl transition-all transform hover:scale-105"
                    >
                        🎮 クイズスタート！
                    </button>
                </div>
            </div>

            <!-- クイズ画面 -->
            <div id="quizGame" class="hidden space-y-6">
                <!-- 進捗表示 -->
                <div class="glass-effect rounded-3xl p-6 shadow-2xl">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-white font-bold text-xl">問題 <span id="currentQuestion">1</span> / <span id="totalQuestions">10</span></span>
                        <span class="text-white font-bold text-xl">⏱️ <span id="timer">0</span>秒</span>
                    </div>
                    <div class="w-full bg-white/30 rounded-full h-4">
                        <div id="progressBar" class="progress-bar bg-yellow-400 h-4 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 曲情報と再生コントロール -->
                <div class="glass-effect rounded-3xl p-8 shadow-2xl text-center">
                    <div class="text-6xl mb-4">🎵</div>
                    <h3 class="text-3xl font-black text-white mb-4">この曲は何でしょう？</h3>
                    
                    <!-- 再生コントロール -->
                    <div class="flex justify-center gap-4 mb-6">
                        <button 
                            onclick="playIntro()"
                            class="bg-green-500 text-white px-8 py-4 rounded-xl font-bold text-lg hover:bg-green-600 transition-all transform hover:scale-105 shadow-lg"
                        >
                            🔊 再生
                        </button>
                        <button 
                            onclick="stopAudio()"
                            class="bg-red-500 text-white px-8 py-4 rounded-xl font-bold text-lg hover:bg-red-600 transition-all transform hover:scale-105 shadow-lg"
                        >
                            ⏸️ 停止
                        </button>
                    </div>
                    
                    <p id="currentSongTitle" class="text-2xl text-white font-bold hidden mt-4"></p>
                </div>

                <!-- プレイヤーボタン -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="playerButtons"></div>
                </div>

                <!-- コントロールボタン -->
                <div class="grid grid-cols-2 gap-4">
                    <button 
                        onclick="showAnswer()"
                        class="glass-effect text-white px-6 py-4 rounded-xl font-bold text-lg hover:bg-white/30 transition-all"
                    >
                        💡 答えを表示
                    </button>
                    <button 
                        onclick="nextQuestion()"
                        class="bg-white text-cyan-600 px-6 py-4 rounded-xl font-bold text-lg hover:bg-cyan-50 transition-all"
                    >
                        ➡️ 次の問題
                    </button>
                </div>

                <!-- 現在のスコア -->
                <div class="glass-effect rounded-3xl p-6 shadow-2xl">
                    <h3 class="text-2xl font-bold text-white mb-4">📊 現在のスコア</h3>
                    <div id="currentScores" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let players = JSON.parse(localStorage.getItem('quizPlayers') || '[]');
        let scores = JSON.parse(localStorage.getItem('quizScores') || '{}');
        let selectedSongs = [];
        let currentQuestionIndex = 0;
        let introLength = 3;
        let audioPlayer = document.getElementById('audioPlayer');
        let playbackTimer = null;
        let startTime = 0;
        let currentSearchTab = 'song';

        // 初期化
        renderPlayerList();

        // タブ切り替え
        function switchSearchTab(tab) {
            currentSearchTab = tab;
            
            // タブボタンのスタイル更新
            document.getElementById('tabSong').classList.remove('tab-active');
            document.getElementById('tabArtist').classList.remove('tab-active');
            document.getElementById('tabArtistQuiz').classList.remove('tab-active');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('tab-active');
            
            // タブコンテンツの表示切り替え
            document.getElementById('songSearchTab').classList.add('hidden');
            document.getElementById('artistSearchTab').classList.add('hidden');
            document.getElementById('artistQuizTab').classList.add('hidden');
            
            if (tab === 'song') {
                document.getElementById('songSearchTab').classList.remove('hidden');
            } else if (tab === 'artist') {
                document.getElementById('artistSearchTab').classList.remove('hidden');
            } else if (tab === 'artistQuiz') {
                document.getElementById('artistQuizTab').classList.remove('hidden');
            }
            
            // 検索結果をクリア
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('artistResults').innerHTML = '';
        }

        // プレイヤー追加
        function addPlayer() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('プレイヤー名を入力してください');
                return;
            }
            
            if (players.length >= 4) {
                alert('プレイヤーは最大4人までです');
                return;
            }
            
            const player = {
                id: Date.now(),
                name: name
            };
            
            players.push(player);
            scores[player.id] = scores[player.id] || 0;
            
            savePlayers();
            saveScores();
            renderPlayerList();
            
            nameInput.value = '';
        }

        // プレイヤー削除
        function removePlayer(id) {
            players = players.filter(p => p.id !== id);
            delete scores[id];
            savePlayers();
            saveScores();
            renderPlayerList();
        }

        // プレイヤーリスト表示
        function renderPlayerList() {
            const listDiv = document.getElementById('playerList');
            
            if (players.length === 0) {
                listDiv.innerHTML = '<p class="text-white/70 text-center py-4">プレイヤーを追加してください</p>';
                return;
            }
            
            listDiv.innerHTML = players.map(player => `
                <div class="bg-white/20 rounded-xl p-4 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">👤</span>
                        <div>
                            <div class="text-white font-bold text-lg">${player.name}</div>
                            <div class="text-white/80 text-sm">スコア: ${scores[player.id] || 0}ポイント</div>
                        </div>
                    </div>
                    <button 
                        onclick="removePlayer(${player.id})"
                        class="bg-red-500/80 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-600 transition-all"
                    >
                        ✕
                    </button>
                </div>
            `).join('');
        }

        // 曲名で検索
        async function searchBySong() {
            const query = document.getElementById('songSearchQuery').value.trim();
            
            if (!query) {
                alert('曲名を入力してください');
                return;
            }
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<p class="text-white text-center py-4">🔍 検索中...</p>';
            
            try {
                const url = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&entity=song&attribute=songTerm&limit=25&country=JP`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.results || data.results.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-white text-center py-4">検索結果がありません</p>';
                    return;
                }
                
                const songsWithPreview = data.results.filter(song => song.previewUrl);
                
                if (songsWithPreview.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-white text-center py-4">プレビュー可能な曲が見つかりませんでした</p>';
                    return;
                }
                
                resultsDiv.innerHTML = songsWithPreview.map(song => `
                    <div class="bg-white/20 rounded-xl p-3 flex items-center gap-3 hover:bg-white/30 transition-all cursor-pointer" onclick='addSong(${JSON.stringify(song).replace(/'/g, "&apos;")})'>
                        <img src="${song.artworkUrl60}" alt="${song.trackName}" class="w-16 h-16 rounded-lg" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23ccc%22 width=%2260%22 height=%2260%22/%3E%3C/svg%3E'" />
                        <div class="flex-1 min-w-0">
                            <div class="text-white font-bold truncate">${song.trackName}</div>
                            <div class="text-white/80 text-sm truncate">${song.artistName}</div>
                        </div>
                        <button class="bg-cyan-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-cyan-600 transition-all">
                            ➕
                        </button>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('検索エラー詳細:', error);
                resultsDiv.innerHTML = `
                    <div class="bg-red-500/30 rounded-xl p-4 text-white">
                        <p class="font-bold mb-2">❌ 検索に失敗しました</p>
                        <p class="text-sm">エラー: ${error.message}</p>
                    </div>
                `;
            }
        }

        // アーティストで検索
        async function searchByArtist() {
            const query = document.getElementById('artistSearchQuery').value.trim();
            
            if (!query) {
                alert('アーティスト名を入力してください');
                return;
            }
            
            const resultsDiv = document.getElementById('artistResults');
            resultsDiv.innerHTML = '<p class="text-white text-center py-4">🔍 検索中...</p>';
            
            try {
                const url = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&entity=song&attribute=artistTerm&limit=200&country=JP`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.results || data.results.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-white text-center py-4">検索結果がありません</p>';
                    return;
                }
                
                // アーティストごとにグループ化
                const artistGroups = {};
                data.results.filter(song => song.previewUrl).forEach(song => {
                    const artistName = song.artistName;
                    if (!artistGroups[artistName]) {
                        artistGroups[artistName] = [];
                    }
                    artistGroups[artistName].push(song);
                });
                
                // アーティスト一覧を表示
                resultsDiv.innerHTML = Object.keys(artistGroups).map(artistName => `
                    <div class="bg-white/20 rounded-xl p-4">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-3">
                                <img src="${artistGroups[artistName][0].artworkUrl60}" alt="${artistName}" class="w-12 h-12 rounded-lg" />
                                <div>
                                    <div class="text-white font-bold text-lg">${artistName}</div>
                                    <div class="text-white/70 text-sm">${artistGroups[artistName].length}曲</div>
                                </div>
                            </div>
                            <button 
                                onclick="toggleArtistSongs('${artistName.replace(/'/g, "\\'")}')"
                                class="bg-cyan-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-cyan-600 transition-all"
                            >
                                曲を表示
                            </button>
                        </div>
                        <div id="artist-songs-${artistName.replace(/[^a-zA-Z0-9]/g, '_')}" class="hidden space-y-2 mt-3 max-h-64 overflow-y-auto">
                            ${artistGroups[artistName].map(song => `
                                <div class="bg-white/10 rounded-lg p-2 flex items-center gap-2 hover:bg-white/20 transition-all cursor-pointer" onclick='addSong(${JSON.stringify(song).replace(/'/g, "&apos;")})'>
                                    <img src="${song.artworkUrl60}" alt="${song.trackName}" class="w-10 h-10 rounded" />
                                    <div class="flex-1 min-w-0">
                                        <div class="text-white text-sm font-semibold truncate">${song.trackName}</div>
                                    </div>
                                    <button class="bg-cyan-500 text-white px-3 py-1 rounded font-bold hover:bg-cyan-600 transition-all text-sm">
                                        ➕
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
                
                // グループデータを保存
                window.artistGroupsData = artistGroups;
                
            } catch (error) {
                console.error('検索エラー詳細:', error);
                resultsDiv.innerHTML = `
                    <div class="bg-red-500/30 rounded-xl p-4 text-white">
                        <p class="font-bold mb-2">❌ 検索に失敗しました</p>
                        <p class="text-sm">エラー: ${error.message}</p>
                    </div>
                `;
            }
        }

        // アーティストの曲リストを表示/非表示
        function toggleArtistSongs(artistName) {
            const cleanName = artistName.replace(/[^a-zA-Z0-9]/g, '_');
            const element = document.getElementById(`artist-songs-${cleanName}`);
            if (element.classList.contains('hidden')) {
                element.classList.remove('hidden');
            } else {
                element.classList.add('hidden');
            }
        }

        // アーティストクイズを開始
        async function startArtistQuiz() {
            const query = document.getElementById('artistQuizQuery').value.trim();
            
            if (!query) {
                alert('アーティスト名を入力してください');
                return;
            }
            
            if (players.length === 0) {
                alert('プレイヤーを追加してください');
                return;
            }
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = `<p class="text-white text-center py-4">🔍 「${query}」の曲を検索中...</p>`;
            
            try {
                const url = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&entity=song&attribute=artistTerm&limit=200&country=JP`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                const songsWithPreview = data.results.filter(song => song.previewUrl);
                
                if (songsWithPreview.length === 0) {
                    alert('プレビュー可能な曲が見つかりませんでした');
                    resultsDiv.innerHTML = '';
                    return;
                }
                
                // ランダムに10曲選択
                const numSongs = Math.min(10, songsWithPreview.length);
                selectedSongs = shuffleArray([...songsWithPreview]).slice(0, numSongs);
                updateSelectedSongsList();
                resultsDiv.innerHTML = `<p class="text-white text-center py-4">✅ ${query}の曲を${selectedSongs.length}曲選択しました！</p>`;
                
                // すぐにクイズを開始
                setTimeout(startQuiz, 1000);
                
            } catch (error) {
                console.error('検索エラー詳細:', error);
                alert(`検索に失敗しました: ${error.message}`);
                resultsDiv.innerHTML = '';
            }
        }

        // テーマ別クイズを開始
        async function startThemeQuiz(theme) {
            if (players.length === 0) {
                alert('プレイヤーを追加してください');
                return;
            }
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = `<p class="text-white text-center py-4">🔍 「${theme}」を検索中...</p>`;
            
            try {
                const url = `https://itunes.apple.com/search?term=${encodeURIComponent(theme)}&media=music&entity=song&limit=50&country=JP`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                const songsWithPreview = data.results.filter(song => song.previewUrl);
                
                if (songsWithPreview.length === 0) {
                    alert('プレビュー可能な曲が見つかりませんでした');
                    resultsDiv.innerHTML = '';
                    return;
                }
                
                // ランダムに10曲選択
                const numSongs = Math.min(10, songsWithPreview.length);
                selectedSongs = shuffleArray([...songsWithPreview]).slice(0, numSongs);
                updateSelectedSongsList();
                resultsDiv.innerHTML = `<p class="text-white text-center py-4">✅ ${selectedSongs.length}曲を自動選択しました！</p>`;
                
                // すぐにクイズを開始
                setTimeout(startQuiz, 1000);
                
            } catch (error) {
                console.error('検索エラー詳細:', error);
                alert(`検索に失敗しました: ${error.message}`);
                resultsDiv.innerHTML = '';
            }
        }

        // 曲を追加
        function addSong(song) {
            if (selectedSongs.find(s => s.trackId === song.trackId)) {
                alert('この曲は既に追加されています');
                return;
            }
            
            selectedSongs.push(song);
            updateSelectedSongsList();
        }

        // 曲を削除
        function removeSong(trackId) {
            selectedSongs = selectedSongs.filter(s => s.trackId !== trackId);
            updateSelectedSongsList();
        }

        // 選択した曲リストを更新
        function updateSelectedSongsList() {
            document.getElementById('songCount').textContent = selectedSongs.length;
            const listDiv = document.getElementById('selectedSongsList');
            
            if (selectedSongs.length === 0) {
                listDiv.innerHTML = '<p class="text-white/70 text-center py-4">曲を検索して追加してください</p>';
                return;
            }
            
            listDiv.innerHTML = selectedSongs.map(song => `
                <div class="bg-white/20 rounded-xl p-3 flex items-center gap-3">
                    <img src="${song.artworkUrl60}" alt="${song.trackName}" class="w-12 h-12 rounded-lg" />
                    <div class="flex-1 min-w-0">
                        <div class="text-white font-bold truncate text-sm">${song.trackName}</div>
                        <div class="text-white/80 text-xs truncate">${song.artistName}</div>
                    </div>
                    <button 
                        onclick="removeSong(${song.trackId})"
                        class="bg-red-500/80 text-white px-3 py-1 rounded-lg font-bold hover:bg-red-600 transition-all text-sm"
                    >
                        ✕
                    </button>
                </div>
            `).join('');
        }

        // イントロの長さを更新
        function updateIntroLength(value) {
            introLength = parseInt(value);
            document.getElementById('introLengthValue').textContent = value;
        }

        // クイズ開始
        function startQuiz() {
            if (players.length === 0) {
                alert('プレイヤーを追加してください');
                return;
            }
            
            if (selectedSongs.length === 0) {
                alert('曲を追加してください');
                return;
            }
            
            // 曲をシャッフル
            shuffleArray(selectedSongs);
            
            currentQuestionIndex = 0;
            document.getElementById('userManagement').classList.add('hidden');
            document.getElementById('quizGame').classList.remove('hidden');
            
            loadQuestion();
        }

        // 問題を読み込み
        function loadQuestion() {
            const song = selectedSongs[currentQuestionIndex];
            
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = selectedSongs.length;
            document.getElementById('currentSongTitle').classList.add('hidden');
            document.getElementById('timer').textContent = '0';
            
            const progress = ((currentQuestionIndex + 1) / selectedSongs.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            // プレイヤーボタンを生成
            const buttonsDiv = document.getElementById('playerButtons');
            buttonsDiv.innerHTML = players.map(player => `
                <button 
                    onclick="answerQuestion(${player.id})"
                    class="glass-effect text-white px-6 py-6 rounded-xl font-bold text-xl hover:bg-white/30 transition-all transform hover:scale-105"
                >
                    <div class="text-3xl mb-2">👤</div>
                    ${player.name}
                </button>
            `).join('');
            
            // スコア表示を更新
            updateCurrentScores();
            
            // 音楽を設定（自動再生はしない）
            audioPlayer.src = song.previewUrl;
            audioPlayer.currentTime = 0;
            
            // 最初のイントロを自動再生
            playIntro();
        }

        // イントロを再生
        function playIntro() {
            const song = selectedSongs[currentQuestionIndex];
            audioPlayer.currentTime = 0;
            audioPlayer.play();
            
            // タイマー開始
            if (playbackTimer) {
                clearInterval(playbackTimer);
            }
            
            startTime = Date.now();
            playbackTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = elapsed;
                
                if (elapsed >= introLength) {
                    audioPlayer.pause();
                    clearInterval(playbackTimer);
                }
            }, 100);
        }

        // 音声を停止
        function stopAudio() {
            audioPlayer.pause();
            if (playbackTimer) {
                clearInterval(playbackTimer);
            }
        }

        // 回答
        function answerQuestion(playerId) {
            stopAudio();
            
            const player = players.find(p => p.id === playerId);
            const song = selectedSongs[currentQuestionIndex];
            
            const userAnswer = confirm(`${player.name}さん、「${song.trackName}」で正解ですか？`);
            
            if (userAnswer) {
                scores[playerId] = (scores[playerId] || 0) + 10;
                saveScores();
                updateCurrentScores();
                alert(`✅ 正解！ ${player.name}さんに10ポイント！`);
            } else {
                alert(`❌ 不正解...`);
            }
            
            showAnswer();
        }

        // 答えを表示
        function showAnswer() {
            const song = selectedSongs[currentQuestionIndex];
            const titleElement = document.getElementById('currentSongTitle');
            titleElement.textContent = `♪ ${song.trackName} - ${song.artistName}`;
            titleElement.classList.remove('hidden');
            
            // 全曲再生
            audioPlayer.currentTime = 0;
            audioPlayer.play();
        }

        // 次の問題
        function nextQuestion() {
            stopAudio();
            
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= selectedSongs.length) {
                endQuiz();
            } else {
                loadQuestion();
            }
        }

        // クイズ終了
        function endQuiz() {
            stopAudio();
            
            document.getElementById('quizGame').classList.add('hidden');
            document.getElementById('userManagement').classList.remove('hidden');
            
            // 最終結果表示
            const sortedPlayers = [...players].sort((a, b) => (scores[b.id] || 0) - (scores[a.id] || 0));
            
            let resultMessage = '🏆 最終結果 🏆\n\n';
            sortedPlayers.forEach((player, index) => {
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '　';
                resultMessage += `${medal} ${player.name}: ${scores[player.id] || 0}ポイント\n`;
            });
            
            alert(resultMessage);
            renderPlayerList();
        }

        // 現在の